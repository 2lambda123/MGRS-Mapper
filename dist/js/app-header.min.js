function USNGGraticule(t,e){var a=this;if(!t)throw"Must supply map to the constructor";this._map=t,this.gridStyle=e,this.setMap(t),this.resizeListener=google.maps.event.addDomListener(window,"resize",function(){a.draw()}),this.dragListener=google.maps.event.addListener(t,"dragend",function(){a.draw()})}function USNGViewport(t){this.lat_coords=[],this.lng_coords=[],this.georectangle=[],this.bounds=t.getBounds(),this.slat=this.bounds.getSouthWest().lat(),this.wlng=this.bounds.getSouthWest().lng(),this.nlat=this.bounds.getNorthEast().lat(),this.elng=this.bounds.getNorthEast().lng(),84<this.nlat&&(this.nlat=84);var e,a=6*Math.floor(this.wlng/6+1),i=-80<=this.slat?8*Math.floor(this.slat/8+1):-80;this.slat<-80?this.lat_coords[0]=-80:this.lat_coords[0]=this.slat;for(var r=i,o=1;r<this.nlat;r+=8,o++)r<=72?this.lat_coords[o]=r:r<=80?this.lat_coords[o]=84:o--;if(this.lat_coords[o]=this.nlat,this.lng_coords[0]=this.wlng,this.wlng<this.elng)for(e=a,o=1;e<this.elng;e+=6,o++)this.lng_coords[o]=e;else{for(e=a,o=1;e<=180;e+=6,o++)this.lng_coords[o]=e;for(e=-180;e<this.elng;e+=6,o++)this.lng_coords[o]=e}this.lng_coords[o++]=this.elng;for(var n=0,s=0;s<this.lat_coords.length-1;s++)for(o=0;o<this.lng_coords.length-1;o++)72<=this.lat_coords[s]&&6==this.lng_coords[o]||72<=this.lat_coords[s]&&18==this.lng_coords[o]||72<=this.lat_coords[s]&&30==this.lng_coords[o]||(this.georectangle[n]=new usng_georectangle,this.georectangle[n].assignCorners(this.lat_coords[s],this.lat_coords[s+1],this.lng_coords[o],this.lng_coords[o+1]),this.lat_coords[s]!=this.lat_coords[s+1]&&this.georectangle[n].assignCenter(),n++)}function USNGZonelines(t,e,a){try{this._map=t,this.view=e,this.parent=a,this.lat_line=[],this.lng_line=[];var i=this.view.lats(),r=this.view.lngs();this.gzd_rectangles=this.view.geoextents(),this.marker=[];var o,n=[];for(o=1;o<i.length;o++){n=[];for(var s=0;s<r.length;s++)n.push(new google.maps.LatLng(i[o],r[s]));this.lat_line.push(new google.maps.Polyline({path:n,strokeColor:this.parent.gridStyle.majorLineColor,strokeWeight:this.parent.gridStyle.majorLineWeight,strokeOpacity:this.parent.gridStyle.majorLineOpacity,map:this._map}))}for(o=1;o<r.length;o++){if(n=[],6==r[o])for(s=0;s<i.length;s++)56==i[s]?(n.push(new google.maps.LatLng(i[s],r[o])),n.push(new google.maps.LatLng(i[s],r[o]-3))):i[s]<56||64<i[s]&&i[s]<72?n.push(new google.maps.LatLng(i[s],r[o])):56<i[s]&&i[s]<64?n.push(new google.maps.LatLng(i[s],r[o]-3)):64==i[s]?(n.push(new google.maps.LatLng(i[s],r[o]-3)),n.push(new google.maps.LatLng(i[s],r[o]))):72==i[s]?(n.push(new google.maps.LatLng(i[s],r[o])),n.push(new google.maps.LatLng(i[s],r[o]+3))):i[s]<72?n.push(new google.maps.LatLng(i[s],r[o])):72<i[s]?n.push(new google.maps.LatLng(i[s],r[o]+3)):n.push(new google.maps.LatLng(i[s],r[o]-3));else if(12==r[o]||18==r[o]||36==r[o])for(s=0;s<i.length;s++)i[s]<=72&&n.push(new google.maps.LatLng(i[s],r[o]));else if(24==r[o])for(s=0;s<i.length;s++)72==i[s]?(n.push(new google.maps.LatLng(i[s],r[o])),n.push(new google.maps.LatLng(i[s],r[o]-3))):i[s]<72?n.push(new google.maps.LatLng(i[s],r[o])):72<i[s]&&n.push(new google.maps.LatLng(i[s],r[o]-3));else if(30==r[o])for(s=0;s<i.length;s++)72==i[s]?(n.push(new google.maps.LatLng(i[s],r[o])),n.push(new google.maps.LatLng(i[s],r[o]+3))):i[s]<72?n.push(new google.maps.LatLng(i[s],r[o])):72<i[s]&&n.push(new google.maps.LatLng(i[s],r[o]+3));else for(s=0;s<i.length;s++)n.push(new google.maps.LatLng(i[s],r[o]));this.lng_line.push(new google.maps.Polyline({path:n,strokeColor:this.parent.gridStyle.majorLineColor,strokeWeight:this.parent.gridStyle.majorLineWeight,strokeOpacity:this.parent.gridStyle.majorLineOpacity,map:this._map}))}this._map.getZoom()<10&&this.zonemarkerdraw()}catch(t){throw"Error drawing USNG zone boundaries: "+t}}function Grid100klines(t,e,a){this._map=t,this.view=e,this.parent=a,this.Gridcell_100k=[],this.zonelines=new USNGZonelines(this._map,this.view,a),this.zones=this.view.geoextents();for(var i=0;i<this.zones.length;i++){var r=new Gridcell(this._map,this.parent,this.zones[i],1e5);this.Gridcell_100k.push(r),r.drawOneCell()}}function Grid1klines(t,e,a){this._map=t,this.view=e,this.parent=a,this.Gridcell_1k=[],this.zones=this.view.geoextents();for(var i=0;i<this.zones.length;i++)this.Gridcell_1k[i]=new Gridcell(this._map,this.parent,this.zones[i],1e3),this.Gridcell_1k[i].drawOneCell()}function Grid100mlines(t,e,a){this._map=t,this.view=e,this.parent=a,this.Gridcell_100m=[],this.zones=this.view.geoextents();for(var i=0;i<this.zones.length;i++)this.Gridcell_100m[i]=new Gridcell(this._map,this.parent,this.zones[i],100),this.Gridcell_100m[i].drawOneCell()}function usng_georectangle(){this.nlat=0,this.slat=0,this.wlng=0,this.elng=0,this.centerlat=0,this.centerlng=0}function Gridcell(t,e,a,i){if(!t)throw"map argument not supplied to Gridcell constructor";if(!e)throw"parent USNG grid not supplied to Gridcell constructor";this._map=t,this.parent=e,this.slat=a.slat,this.wlng=a.wlng,this.nlat=a.nlat,this.elng=a.elng,this.interval=i,this.gridlines=[],this.label_100k=[],this.label_1k=[],this.label_100m=[]}"undefined"==typeof MARCONI&&(MARCONI={}),MARCONI.namespace=function(){var t,e,a,i=arguments,r=null;for(t=0;t<i.length;t+=1)for(a=i[t].split("."),r=window,e=0;e<a.length;e+=1)r[a[e]]=r[a[e]]||{},r=r[a[e]];return r},MARCONI.namespace("MARCONI.stdlib"),Array.indexOf||(Array.prototype.indexOf=function(t,e){void 0===e&&(e=0);for(var a=e;a<this.length;a++)if(this[a]==t)return a;return-1}),Array.remove||(Array.prototype.remove=function(t){if(void 0===t)throw"Must provide index of item to remove";if(t>=this.length)throw"Index must be less than length";return this.slice(0,t).concat(this.slice(t+1))}),String.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),String.ltrim||(String.prototype.ltrim=function(){return this.replace(/^\s+/,"")}),String.rtrim||(String.prototype.rtrim=function(){return this.replace(/\s+$/,"")}),String.startsWith||(String.prototype.startsWith=function(t){return this.match("^"+t)==t}),String.indexOfAny||(String.prototype.indexOfAny=function(t,e){e||(e=0);for(var a=e;a<this.length;a++)if(0<=t.indexOf(this.substr(a,1)))return a;return-1}),MARCONI.stdlib=function(){var o=function(t){if("string"!=typeof t)return t;var e=document.getElementById(t);if(!e)throw"Control "+t+" not found";return e};return{addCodeFieldFilter:function(t,r){try{if(!window.YAHOO)throw"Cannot add code field filter, need YAHOO library";YAHOO.util.Event.addListener(t,"change",function(){for(var t=this.value,e="",a="abcdefghijklmnopqrstuvwxyz0123456789_"+("string"==typeof r?r:""),i=0;i<t.length;i++)0<=a.indexOf(t.substr(i,1).toLowerCase())&&(e+=t.substr(i,1));return this.value=e,!0})}catch(t){throw"addCodeFieldFilter() : error trying to install code field key filter: "+t}},addListener:function(t,e,a){t.addEventListener?t.addEventListener(e,a,!1):t.attachEvent("on"+e,a)},adjacentCharWrapping:function(e,a,t){try{var i=e.indexOf(a);return t?0===i?e.charAt(e.length-1):e.charAt(i-1):i===e.length-1?e.charAt(0):e.charAt(i+1)}catch(t){throw"Error handling adjacent character wrapping of string "+e+" and char "+a}},adjustMobilityLinks:function(t,e){var a=document.getElementById("linkMobile");if(a&&a.href)a.href=t;else{var i=document.getElementById("linkNonMobile");i&&i.href&&(i.href=e)}},arrayFromStyleString:function(t){if(!t)return[];for(var e=t.split(";"),a={},i=0;i<e.length;i++){var r=e[i].split(":"),o=r[0].trim(),n=r[1].trim();a[o]=n}return a},browserVersionNumber:function(){var t=navigator.appVersion,e=t.indexOf("MSIE "),a=0;if(0<=e){var i=t.substr(e+5);0<=(e=i.indexOf(";"))&&(i=i.substring(0,e)),a=parseFloat(i)}return a},checkboxGetTriState:function(t){try{return(t=o(t)).indeterminate?null:!!t.checked}catch(t){throw"Error getting tristate on checkbox: "+t}},checkboxSetTriState:function(t,e){try{(t=o(t)).indeterminate=null===e||""===e,t.checked=!0===e||"true"===e,t.state=t.indeterminate?null:t.checked,window.YAHOO&&YAHOO.util.Event.addListener(t,"change",function(){!0===this.state?(this.indeterminate=!0,this.checked=!1):null===this.state?(this.indeterminate=!1,this.checked=!1):(this.indeterminate=!1,this.checked=!0),this.state=this.indeterminate?null:this.checked})}catch(t){throw"Error setting tristate on checkbox: "+t}},clone:function(t){return t&&window.YAHOO?YAHOO.lang.JSON.parse(YAHOO.lang.JSON.stringify(t)):t},csvToArray:function(t,e){try{var a=t.split(/\r\n|\r|\n/g);a[a.length-1]||a.splice(a.length-1,1);for(var i=0;i<a.length;i++){for(var r,o=a[i].split(e=e||","),n=o.length-1;0<=n;n--)'"'==o[n].replace(/"\s+$/,'"').charAt(o[n].length-1)?1<(r=o[n].replace(/^\s+"/,'"')).length&&'"'==r.charAt(0)?o[n]=o[n].replace(/^\s*"|"\s*$/g,"").replace(/""/g,'"'):n?o.splice(n-1,2,[o[n-1],o[n]].join(e)):o=o.shift().split(e).concat(o):o[n].replace(/""/g,'"');a[i]=o}return a}catch(t){throw"Error parsing CSV to array: "+t}},fireEvent:function(e,a){try{if((e=o(e)).fireEvent)e.fireEvent("on"+a);else if(document.createEvent){var t=document.createEvent("HTMLEvents");t.initEvent(a,!0,!0),e.dispatchEvent(t)}}catch(t){throw"MARCONI.stdlib.fireEvent() reports error firing event "+a+" on element "+e+": "+t}},fireMouseEvent:function(t,e){if(document.createEvent){var a=document.createEvent("MouseEvents");a.initEvent(e,!0,!1),t.dispatchEvent(a)}else document.createEventObject&&t.fireEvent("on"+e)},fixedFormatNumber:function(e,t,a,i){try{if(null==e)return"";if("string"==typeof e)return e;var r=parseFloat(e),o=r<0;r=Math.abs(r),a=a||0;var n=Math.pow(10,a);if(i)r=Math.round(r*n)/n;var s=r.toString().split("."),l=this.padLeft(s[0],t),c=1<s.length?s[1]:"";return 0===a?c="":(c=this.getLocaleDecimalSeparator()+c).length>a+1?c=c.substr(0,a+1):c.length<a+1&&(c=this.padRight(c,a+1)),(o?"-":"")+l+c}catch(t){return MARCONI.stdlib.log("Error formatting number "+e+": "+t),e}},friendlyErrorMessage:function(t,e){return t?(e=e||"GRIM_ERROR:",t.indexOf(e)?t.substring(t.lastIndexOf(e)+e.length):t):""},generalFormatNumber:function(e,t,a,i){try{if(null==e)return"";if("string"==typeof e)return e;var r=parseFloat(e),o=r<0;r=Math.abs(r),a=a||0;var n=Math.pow(10,a);if(i)r=Math.round(r*n)/n;var s=r.toString().split("."),l=this.padLeft(s[0],t),c=1<s.length?s[1]:"";return 0===a?c="":(c=this.getLocaleDecimalSeparator()+c).length>a+1&&(c=c.substr(0,a+1)),(o?"-":"")+l+c}catch(t){return MARCONI.stdlib.log("Error formatting number "+e+": "+t),e}},getElemsWithClass:function(e,t){try{for(var a=((t=o(t))||document).getElementsByTagName("*"),i=[],r=0;r<a.length;r++)(!e||0<=(" "+a[r].className+" ").indexOf(" "+e+" "))&&i.push(a[r]);return i}catch(t){throw"Error forming up elements of class "+e+": "+t}},getFriendlyError:function(t){if(t){var e=t.lastIndexOf("GRIM_ERROR:");return 0<=e?t.substr(e+11):t}return null},getLocaleDecimalSeparator:function(){var t=1.1;return t=t.toLocaleString().substr(1,1)},getLocaleThousandSeparator:function(){return","==this.getLocaleDecimalSeparator()?".":","},isDigit:function(t){if("string"!=typeof t)return!1;if(0===t.length)return!1;for(var e=0;e<t.length;e++)if(t.charAt(e)<"0"||"9"<t.charAt(e))return!1;return!0},isExplorer:function(){return-1!=navigator.appVersion.indexOf("MSIE ")},isMacintosh:function(){return-1!=navigator.appVersion.indexOf("Mac")},listboxAddItem:function(t,e,a,i){try{if(!(t=o(t)))throw"select control not given";null==a&&(a=e),t.options[t.options.length]=new Option(e,a);var r=t.options[t.options.length-1];return i&&r.setAttribute("title",i),r}catch(t){throw"listboxAddItem(): unable to add item "+a+" to listbox, error is :"+t}},listboxAddItemIfMissing:function(t,e,a,i){try{if(!(t=o(t)))throw"select control not given";for(var r=0;r<t.options.length;r++)if(t.options[r].value==a)return t.options[r];return MARCONI.stdlib.listboxAddItem(t,e,a,i)}catch(t){throw"listboxAddItemIfMissing(): error is :"+t}},listboxAllItems:function(t){try{if(!(t=o(t)))throw"select control not given";if(!t.options||0===t.options.length)return null;for(var e=[],a=0;a<t.options.length;a++)e.push(t.options[a].value);return e}catch(t){throw"listboxAllItems(): unable to get items from listbox, error is :"+t}},listboxClear:function(t){try{if((t=o(t)).options.length=0,t.selectedIndex=-1,0!=t.options.length)throw"Failed to clear listbox"}catch(t){throw"listboxClear() error: "+t}},listboxClearSelection:function(t){try{if(!(t=o(t)))throw"list control not provided";0<t.options.length&&(t.selectedIndex=-1)}catch(t){throw"listboxClearSelection() error: "+t}},listboxIndexOf:function(t,e){try{if(!(t=o(t)))throw"list control not provided";if(!t.options)return-1;for(var a=0;a<t.options.length;a++)if(t.options[a].value==e)return a;return-1}catch(t){throw"listboxIndexOf() error: "+t}},listboxMoveItemBetweenLists:function(t,e,a){try{t=o(t),e=o(e);var i=0;if(!t||!e)throw"Must provide reference to both listboxes to move an item between the lists";for(var r=t.options.length-1;0<=r;r--)t.options[r].selected&&(e.appendChild(t.options[r]),i++);return 0<i&&(MARCONI.stdlib.listboxSort(t,a),MARCONI.stdlib.listboxSort(e,a)),i}catch(t){throw"listboxMoveItemBetweenLists() error: "+t}},listboxRemoveItem:function(t,e){try{for(var a=(t=o(t)).options.length-1;0<=a;a--)if(t.options[a].value==e)return t.remove(a),!0;return!1}catch(t){throw"listboxRemoveItem(): error: "+t}},listboxSelectedIndex:function(t){try{if(!(t=o(t)))throw"list control not provided";return t.selectedIndex}catch(t){throw"listboxSelectedIndex() error: "+t}},listboxSelectedItem:function(t){try{if(!(t=o(t)))throw"list control not provided";return t.selectedIndex<0?null:t.options[t.selectedIndex]}catch(t){throw"listboxSelectedItem() error: "+t}},listboxSelectedItems:function(t){try{if(!(t=o(t)))throw"list control not provided";for(var e=[],a=0;a<t.length;a++)t.options[a].selected&&e.push(t.options[a]);return e}catch(t){throw"listboxSelectedItems() error: "+t}},listboxSelectedText:function(t){try{if(!(t=o(t)))throw"list control not provided";return t.selectedIndex<0?"":t.options[t.selectedIndex].text}catch(t){throw"listboxSelectedText() error: "+t}},listboxSelectedValue:function(t){try{if(!(t=o(t)))throw"list control not provided";return t.selectedIndex<0?"":t.options[t.selectedIndex].value}catch(t){throw"listboxSelectedValue() error: "+t}},listboxSelectedValueOrText:function(t){try{if(!(t=o(t)))throw"list control not provided";if(t.selectedIndex<0)return"";var e=t.options[t.selectedIndex].value;return""===e&&(e=t.options[t.selectedIndex].text),e}catch(t){throw"listboxSelectedValueOrText() error: "+t}},listboxSelectedValues:function(t){try{if(!(t=o(t)))throw"list control not provided";for(var e=[],a=0,i=0;i<t.length;i++)t.options[i].selected&&(e.push(t.options[i].value),a++);return 0===a?null:e}catch(t){throw"listboxSelectedValues() error: "+t}},listboxSort:function(t,e){try{if(e=e||{},!(t=o(t)))throw"list control not provided";var a,i=[];for(a=0;a<t.options.length;a++)i.push(t.options[a]);for(i.sort(e.compareFunc||(e.byValue?function(t,e){return t.value<e.value?-1:t.value>e.value?1:0}:function(t,e){return t.text<e.text?-1:t.text>e.text?1:0})),a=t.options.length=0;a<i.length;a++)t.options[a]=i[a]}catch(t){throw"listboxSort() error: "+t}},listboxSwapItems:function(t,e,a){try{if(!(t=o(t)))throw"list control not provided";if(e<0||a<0||t.options.length-1<e||t.options.length-1<a)throw"Indices "+e+" and "+a+" not in bounds";var i=t.options[e].text,r=t.options[e].value;t.options[e].value=t.options[a].value,t.options[e].text=t.options[a].text,t.options[a].value=r,t.options[a].text=i}catch(t){throw"listboxSwapItems() error: "+t}},listboxSynchToValue:function(t,e,a){try{if(!(t=o(t)))throw"list control not provided";a&&(e=(e||"").toUpperCase());for(var i=0;i<t.options.length;i++){if((a?t.options[i].value.toUpperCase():t.options[i].value)==e)return t.selectedIndex=i,!0}return!1}catch(t){throw"listboxSynchToValue() error: "+t}},listboxSynchToValues:function(t,e){try{if(!(t=o(t)))throw"list control not provided";if(!e||!e.length)throw"valuelist array not provided to listboxSynchToValues";for(var a=0;a<t.options.length;a++)t.options[a].selected=0<=e.indexOf(t.options[a].value)}catch(t){throw"listboxSynchToValue() error: "+t}},listboxSynchToValueOrText:function(t,e,a){try{if(!(t=o(t)))throw"list control not provided";for(var i=0;i<t.options.length;i++)if(t.options[i].value==e||t.options[i].text==e||a&&(t.options[i].value.toUpperCase()==e.toUpperCase()||t.options[i].text.toUpperCase()==e.toUpperCase())){t.selectedIndex=i;break}}catch(t){throw"listboxSynchToValueOrText() error: "+t}},logObject:function(e,t,a,i,r){r||(r=5),void 0===t&&(t="top-level"),void 0===a&&(a=""),void 0===i&&(i=1);try{if(r<i)return a+t+": <Maximum Depth Reached>\n";if("object"!=typeof e)return e;var o=null,n=a+t+"\n";for(var s in a+="\t",e)if(e.hasOwnProperty&&e.hasOwnProperty(s)){try{o=e[s]}catch(t){o="<Unable to Evaluate>"}n+=o&&"object"==typeof o?this.logObject(o,s,a,i+1,r):a+s+": "+o+"\n"}return n}catch(t){return MARCONI.stdlib.log("Error dumping object "+e),"error dumping: "+t}},padLeft:function(t,e){for(var a=""+t;a.length<e;)a="0"+a;return a},padRight:function(t,e){for(var a=""+t;a.length<e;)a+="0";return a},pageLevel:function(){try{var t=window.location.pathname,e=document.getElementById("AppRoot")?document.getElementById("AppRoot").value:null;if(!e)throw"pageLevel() cannot determine app root, missing control named AppRoot";return t.substring(0,e.length)==e&&(t=t.substring(e.length)),t.split("/").length-1}catch(t){throw"pageLevel error:"+t}},paramString:function(e){try{if(null==e){var t=window.location.search;return console.log("fuck"),1<t.length?t.substr(1):""}var a=e.indexOf("?");return 0<=a?e.substr(a+1):""}catch(t){throw"paramString() error parsing querystring from URL "+e+", error is : "+t}},paramValue:function(e,t,a){try{a=a||MARCONI.stdlib.paramString();for(var i=null,r=a.split("&"),o=0;o<r.length;o++){var n=r[o].split("=");2==n.length&&n[0].toUpperCase()==e.toUpperCase()&&(i=n[1])}return null!==i?unescape(i):void 0===t?null:t}catch(t){throw"paramValue() error with paramName "+e+", error is "+t}},pluralModifier:function(t){try{return 1<t||0===t?"s":""}catch(t){throw"pluralModifier() error: "+t}},radioButtonSelectedIndex:function(t){try{var e=document.getElementsByName(t);if(!e)throw"radiobutton named "+t+" not found.";for(var a=0;a<e.length;a++)if(e[a].checked)return a;return-1}catch(t){throw"radioButtonSelectedIndex() error: "+t}},radioButtonSetState:function(t,e){try{var a=document.getElementsByName(t);if(!a)throw"radiobutton named "+t+" not found.";for(var i=0;i<a.length;i++)if(a[i].value==e)return a[i].checked=!0;return!1}catch(t){throw"radioButtonSetState() error: "+t}},radioButtonValue:function(t){try{var e=document.getElementsByName(t);if(!e)throw"radiobutton named "+t+" not found.";for(var a=0;a<e.length;a++)if(e[a].checked)return e[a].value;return null}catch(t){throw"radioButtonValue() error: "+t}},repeat:function(t,e){for(var a=[],i=0;i<e;i++)a.push(t);return a.join("")},log:function(){try{if(void 0!==window.console&&console.log)try{console.log.apply(console,arguments)}catch(t){try{Function.prototype.bind.call(console.log,console).apply(console,arguments)}catch(t){var e=[].slice.apply(arguments);e&&console.log(e.join(""))}}else window.YAHOO&&YAHOO.log&&YAHOO.log(arguments)}catch(t){throw"Error in logging function: "+t}},warn:function(){try{if(void 0!==window.console&&console.warn)try{console.warn.apply(console,arguments)}catch(t){try{Function.prototype.bind.call(console.warn,console).apply(console,arguments)}catch(t){var e=[].slice.apply(arguments);e&&console.warn(e.join(""))}}else window.YAHOO&&YAHOO.log&&YAHOO.log(arguments)}catch(t){throw"Error in logging function: "+t}},rootPath:function(){try{var t=null,e=MARCONI.stdlib.pageLevel()-1;if(0<e){t="";for(var a=0;a<e;a++)t+="../"}else t="./";return t}catch(t){throw"rootPath() error: "+t}},setReadonlyByClass:function(t,e,a){for(var i=MARCONI.stdlib.getElemsWithClass(t,a),r=0;r<i.length;r++)e?i[r].setAttribute("readonly","readonly"):i[r].removeAttribute("readonly")},setScreenResolution:function(){try{document.getElementById("ScreenWidth")&&document.getElementById("ScreenHeight")&&(document.getElementById("ScreenWidth").value=window&&window.screen&&window.screen.width?window.screen.width:"",document.getElementById("ScreenHeight").value=window&&window.screen&&window.screen.height?window.screen.height:"")}catch(t){MARCONI.stdlib.log("setScreenResolution() error: "+t)}},strcmp:function(e,a){try{return e==a?0:e<a?-1:1}catch(t){throw"strcmp() error comparing strings "+e+" and "+a+": "+t}},synchListBoxFromInputControl:function(t,e){try{if(!(e=o(e)))throw"text control not provided";var a=e.value;MARCONI.stdlib.listboxSynchToValue(t,a)}catch(t){throw"synchListBoxFromInputControl() error: unable to synch listbox from text control: "+t}},unescapeHTML:function(t){return t?t.replace("&amp;","&").replace("&quot;",'"').replace("&lt;","<").replace("&gt;",">"):null},typeOf:function(t){return"object"==typeof t?"number"==typeof t.length?"array":"object":typeof t},updateCSSClass:function(t,e){try{for(var a=[],i=0;i<document.styleSheets.length;i++){var r=document.styleSheets[i];r.cssRules?a=r.cssRules:r.rules&&(a=r.rules);for(var o=0;o<a.length;o++)if(a[o].selectorText.toLowerCase()==t.toLowerCase()){r.cssRules?(r.deleteRule(o),r.insertRule(t+"{"+e+"}",r.cssRules.length)):(r.removeRule(o),r.addRule(t,e,0));break}}}catch(t){throw"updateCSSClass() error: "+t}}}}(),MARCONI.map=function(){var t=3.28083333333333,e=1/t,a=100/30.48,i=Math.PI/180,r=180/Math.PI,o="GRS80",n="WGS84",s="AIRY",l="AIRY1849",c="CLARKE1866",u="GRS 80",d="Clarke 1866",h="WGS 84",p=6378206.4,g=6378137,f=6378137,m=6377563.396,M=6377340.189,A=.006768658,S=.00669437999014,C=.00669438,R=.0822718542230039,N=.0818191911198883,y=.081819190842622,O=.0816733743281685,v=.08167337375652854,I="NAD27",D="NAD83",w="WGS84",E="OSGB",L="IRISH65",x="usft",b="m",_="degrees",T="grid",U="hectare",G="WORLD",P="CAZONE2",Y="CAZONE3",k="CAZONE4",F="UTM10",q="USNG",B="MGRS",V="GARS",H="CAP_CLASSIC",X="CAP_CELL",j="ALBERS_CONUS",z="EBMUD",Z="LAMBERTCUSTOM",W="TMCUSTOM",J="UTM",K="OSGB",Q="IRISH",$="WGS84",tt="Degrees",et="Acre",at="World (lat/long)",it="CA Zone 3 (SF Bay Area)",rt="UTM Zone 10 (SF Bay Area)",ot="US National Grid",nt="US Military Grid Ref System (MGRS)",st="Global Area Reference System grid (GARS)",lt="Civil Air Patrol classic",ct="Civil Air Patrol Cell system",ut="Albers Equal-area conic for CONUS",dt="UTM Zone 18",ht="EBMUD map grid",pt="Ordnance Survey Great Britain",gt="Irish Grid",ft="WORLD",mt="LAMBERT",Mt="TM",At="GRID",St="ALBERS",Ct="LATLONG_WGS84",Rt="LATLONG_NAD27",Nt="LATLONG_NAD83",yt="UTM10_NAD83",Ot="UTM10_NAD27",vt="UTM_NAD83",It="UTM_NAD27",Dt="USNG",wt="CAP_CLASSIC",Et="CAP_CELL",Lt=[{datumCD:I,datumName:"NAD 1927",isActive:!0,equitorialAxisMeters:p,eccentricity:R,eccentricitySquared:A,flatteningInverse:294.9786982},{datumCD:D,datumName:"NAD 1983",isActive:!0,equitorialAxisMeters:f,eccentricity:N,eccentricitySquared:C,flatteningInverse:298.257222101},{datumCD:w,datumName:$,isActive:!0,equitorialAxisMeters:g,eccentricity:y,eccentricitySquared:S,flatteningInverse:298.257223563},{datumCD:E,datumName:"OSGB datum",isActive:!0,equitorialAxisMeters:m,eccentricity:O,eccentricitySquared:.006670540074149084,flatteningInverse:299.3249753},{datumCD:L,datumName:"Irish 1965 datum",isActive:!0,equitorialAxisMeters:M,eccentricity:v,eccentricitySquared:.00667054015,flatteningInverse:299.3249646}],xt=[{mapUnitCD:_,unitName:tt,isLinear:!1,isActive:!0},{mapUnitCD:x,unitName:"US Survey feet (usual kind for maps)",isLinear:!0,metersPerUnit:e,isActive:!0},{mapUnitCD:"mi",unitName:"Miles",isLinear:!0,metersPerUnit:5280*e,isActive:!0},{mapUnitCD:b,unitName:"Meters",isLinear:!0,metersPerUnit:1,isActive:!0},{mapUnitCD:"km",unitName:"Kilometers",isLinear:!0,metersPerUnit:1e3,isActive:!0},{mapUnitCD:"nmi",unitName:"Nautical Miles",isLinear:!0,metersPerUnit:1852,isActive:!0},{mapUnitCD:T,unitName:"Grid and-or page designation",isLinear:!1,isActive:!0},{mapUnitCD:"ft",unitName:"International feet (rarely used)",isLinear:!0,metersPerUnit:.3048,isActive:!0},{mapUnitCD:"sqm",unitName:"Square meters",isLinear:!1,metersPerUnit:1,isAreal:!0,isActive:!0},{mapUnitCD:U,unitName:"Hectare",isLinear:!1,metersPerUnit:1e4,isAreal:!0,isActive:!0},{mapUnitCD:"ac",unitName:et,isLinear:!1,metersPerUnit:4046.85642,isAreal:!0,isActive:!0},{mapUnitCD:"sqmi",unitName:et,isLinear:!1,metersPerUnit:2589988.11,isAreal:!0,isActive:!0},{mapUnitCD:"sqnmi",unitName:et,isLinear:!1,metersPerUnit:3429904,isAreal:!0,isActive:!0}],bt=[{coordSysCD:G,coordSysName:at,coordSysTypeCD:ft,isActive:!0},{coordSysCD:P,coordSysName:"CA Zone 2",coordSysTypeCD:mt,isActive:!1},{coordSysCD:Y,coordSysName:it,coordSysTypeCD:mt,isActive:!0},{coordSysCD:k,coordSysName:"CA Zone 4",coordSysTypeCD:mt,isActive:!1},{coordSysCD:J,coordSysName:"UTM",coordSysTypeCD:At,isActive:!0},{coordSysCD:F,coordSysName:rt,coordSysTypeCD:Mt,isActive:!0},{coordSysCD:"UTM18",coordSysName:dt,coordSysTypeCD:Mt,isActive:!1},{coordSysCD:q,coordSysName:ot,coordSysTypeCD:At,isActive:!0},{coordSysCD:B,coordSysName:nt,coordSysTypeCD:At,isActive:!0},{coordSysCD:V,coordSysName:st,coordSysTypeCD:At,isActive:!0},{coordSysCD:H,coordSysName:lt,coordSysTypeCD:At,isActive:!0},{coordSysCD:X,coordSysName:ct,coordSysTypeCD:At,isActive:!0},{coordSysCD:j,coordSysName:ut,coordSysTypeCD:St,isActive:!0},{coordSysCD:z,coordSysName:ht,coordSysTypeCD:At,isActive:!0,stateCD:"CA",zone:3,gridTemplate:"{0,number,0000}B{1,number,000}",gridCellSizeHorizontal:3e3,gridCellSizeVertical:2e3,baseCoordSysCD:Y},{coordSysCD:Z,coordSysName:"Lambert custom",coordSysTypeCD:mt,isActive:!0},{coordSysCD:W,coordSysName:"Custom Transverse Mercator",coordSysTypeCD:Mt,isActive:!0},{coordSysCD:K,coordSysName:pt,coordSysTypeCD:At,isActive:!0},{coordSysCD:Q,coordSysName:gt,coordSysTypeCD:At,isActive:!0}],_t=[{fromDatumCD:D,toDatumCD:w,datumShiftMethodCD:"SYNONYM",datumShiftMethodName:"Synonym -- the datums are essentially identical",isActive:!0},{fromDatumCD:I,toDatumCD:w,datumShiftMethodCD:"MRE",datumShiftMethodName:"Multiple Regression Equation (MRE)",isActive:!0,longitudeCoefficients:[{expLat:0,expLong:0,value:-.88437},{expLat:0,expLong:1,value:2.05061},{expLat:1,expLong:1,value:-.76804},{expLat:2,expLong:0,value:.26361},{expLat:0,expLong:2,value:.13374},{expLat:2,expLong:1,value:-.52162},{expLat:1,expLong:2,value:-1.05853},{expLat:2,expLong:2,value:-.49211},{expLat:3,expLong:0,value:-1.31974},{expLat:1,expLong:3,value:2.17204},{expLat:0,expLong:4,value:-.06004},{expLat:4,expLong:1,value:.30139},{expLat:1,expLong:4,value:1.88585},{expLat:1,expLong:5,value:-.81162},{expLat:3,expLong:5,value:-.12948},{expLat:0,expLong:6,value:-.05183},{expLat:1,expLong:6,value:-.96723},{expLat:8,expLong:1,value:-.44507},{expLat:1,expLong:8,value:.18882},{expLat:9,expLong:0,value:3.41827},{expLat:0,expLong:9,value:-.01444},{expLat:1,expLong:9,value:.04794},{expLat:9,expLong:3,value:-.59013}],latitudeCoefficients:[{expLat:0,expLong:0,value:.16984},{expLat:0,expLong:1,value:.09585},{expLat:1,expLong:0,value:-.76173},{expLat:0,expLong:3,value:.49831},{expLat:0,expLong:4,value:.1145},{expLat:1,expLong:3,value:.12415},{expLat:2,expLong:0,value:1.09919},{expLat:2,expLong:1,value:-1.13239},{expLat:3,expLong:0,value:-4.57801},{expLat:3,expLong:1,value:-.98399},{expLat:5,expLong:0,value:27.05396},{expLat:0,expLong:5,value:-.37548},{expLat:0,expLong:6,value:-.14197},{expLat:0,expLong:7,value:.07439},{expLat:0,expLong:8,value:.03385},{expLat:2,expLong:3,value:.73357},{expLat:3,expLong:9,value:-.07653},{expLat:4,expLong:1,value:2.03449},{expLat:4,expLong:9,value:.08646},{expLat:6,expLong:3,value:-1.30575},{expLat:7,expLong:0,value:-59.96555},{expLat:8,expLong:0,value:-4.76082},{expLat:9,expLong:0,value:49.0432}],scaleFactor:.05235988,shiftY:37,shiftX:-95,latitudeMin:20,latitudeMax:50,longitudeMin:-131,longitudeMax:-63},{datumShiftName:"CONUS",fromDatumCD:I,toDatumCD:w,datumShiftMethodCD:"MOLODENSKY",datumShiftMethodName:"Molodensky three-parameter offset",shiftX:-8,shiftY:160,shiftZ:176,isActive:!0},{datumShiftName:"OSGB-M",fromDatumCD:E,toDatumCD:w,datumShiftMethodCD:"MOLODENSKY",datumShiftMethodName:"Molodensky three-parameter offset",shiftX:375,shiftY:-111,shiftZ:431,isActive:!0},{datumShiftName:"OSGB-H",fromDatumCD:w,toDatumCD:E,datumShiftMethodCD:"HELMERT",datumShiftMethodName:"Helmert seven-parameter offset",shiftX:-446.448,shiftY:125.157,shiftZ:-542.06,rotationX:-.1502,rotationY:-.247,rotationZ:-.8421,scaleFactor:20.4894,isActive:!0},{datumShiftName:"IRISH-H",fromDatumCD:w,toDatumCD:L,datumShiftMethodCD:"HELMERT",datumShiftMethodName:"Helmert seven-parameter offset",shiftX:-482.53,shiftY:130.596,shiftZ:-564.557,rotationX:1.042,rotationY:.214,rotationZ:.631,scaleFactor:-8.15,isActive:!0}],Tt=[],Ut=0,Gt=null,Pt=[{spatialReferenceCD:"CAZONE3_NAD27_FT",spatialReferenceName:"CA Zone 3 NAD 27 feet",coordSysTypeCD:mt,coordSysCD:Y,coordSysName:it,originLatitude:36.5,originLongitude:-120.5,parallelOne:37+4/60,parallelTwo:38+26/60,originX:2e6,originY:0,centralScaleFactor:1,mapUnitCD:x,datumCD:I,ellipsoidCD:c,ellipsoidName:d,equitorialAxisMeters:p,eccentricity:R,isActive:!0},{spatialReferenceCD:"CAZONE3_NAD27_M",spatialReferenceName:"CA Zone 3 NAD 27 meters",coordSysTypeCD:mt,coordSysCD:Y,coordSysName:it,originLatitude:36.5,originLongitude:-120.5,parallelOne:37+4/60,parallelTwo:38+26/60,originX:2e6*e,originY:0,centralScaleFactor:1,mapUnitCD:b,datumCD:I,ellipsoidCD:c,ellipsoidName:d,equitorialAxisMeters:p,eccentricity:R,isActive:!1},{spatialReferenceCD:"CAZONE3_NAD83_FT",spatialReferenceName:"CA Zone 3 NAD 83 feet",coordSysTypeCD:mt,coordSysCD:Y,coordSysName:it,originLatitude:36.5,originLongitude:-120.5,parallelOne:37+4/60,parallelTwo:38+26/60,originX:2e6*t,originY:5e5*t,centralScaleFactor:1,mapUnitCD:x,datumCD:D,ellipsoidCD:o,ellipsoidName:u,equitorialAxisMeters:f,eccentricity:N,isActive:!0},{spatialReferenceCD:"CAZONE3_NAD83_M",spatialReferenceName:"CA Zone 3 NAD 83 meters",coordSysTypeCD:mt,coordSysCD:Y,coordSysName:it,originLatitude:36.5,originLongitude:-120.5,parallelOne:37+4/60,parallelTwo:38+26/60,originX:2e6,originY:5e5,centralScaleFactor:1,mapUnitCD:b,datumCD:D,ellipsoidCD:o,ellipsoidName:u,equitorialAxisMeters:f,eccentricity:N,isActive:!1},{spatialReferenceCD:Dt,spatialReferenceName:ot,coordSysTypeCD:At,coordSysCD:q,coordSysName:ot,originLatitude:null,originLongitude:null,datumCD:D,mapUnitCD:T,ellipsoidCD:o,ellipsoidName:u,equitorialAxisMeters:f,eccentricity:N,isActive:!0},{spatialReferenceCD:"MGRS",spatialReferenceName:nt,coordSysTypeCD:At,coordSysCD:B,coordSysName:nt,originLatitude:null,originLongitude:null,datumCD:D,mapUnitCD:T,ellipsoidCD:o,ellipsoidName:u,equitorialAxisMeters:f,eccentricity:N,isActive:!1},{spatialReferenceCD:"OSGB",spatialReferenceName:pt,coordSysTypeCD:At,coordSysCD:K,coordSysName:pt,originLatitude:49,originLongitude:-2,originX:4e5,originY:-1e5,datumCD:E,mapUnitCD:T,centralScaleFactor:.9996012717,ellipsoidCD:s,ellipsoidName:s,equitorialAxisMeters:m,eccentricity:O,isActive:!0,latitudeMin:42,latitudeMax:62,longitudeMin:-10,longitudeMax:4},{spatialReferenceCD:"IRISH",spatialReferenceName:gt,coordSysTypeCD:At,coordSysCD:Q,coordSysName:gt,originLatitude:53.5,originLongitude:-8,originX:2e5,originY:25e4,datumCD:L,mapUnitCD:T,centralScaleFactor:1.000035,ellipsoidCD:l,ellipsoidName:l,equitorialAxisMeters:M,eccentricity:v,isActive:!0,latitudeMin:50,latitudeMax:57,longitudeMin:-12,longitudeMax:-3},{spatialReferenceCD:vt,spatialReferenceName:"UTM NAD83",coordSysTypeCD:At,coordSysCD:J,coordSysName:"UTM",originLatitude:null,originLongitude:null,datumCD:D,mapUnitCD:T,ellipsoidCD:o,ellipsoidName:u,equitorialAxisMeters:f,eccentricity:N,isActive:!0},{spatialReferenceCD:It,spatialReferenceName:"UTM NAD27",coordSysTypeCD:At,coordSysCD:J,coordSysName:"UTM",originLatitude:null,originLongitude:null,datumCD:I,mapUnitCD:T,ellipsoidCD:c,ellipsoidName:d,equitorialAxisMeters:p,eccentricity:R,isActive:!0},{spatialReferenceCD:"GARS",spatialReferenceName:st,coordSysTypeCD:At,coordSysCD:V,coordSysName:st,originLatitude:null,originLongitude:null,datumCD:w,mapUnitCD:T,ellipsoidCD:n,ellipsoidName:h,equitorialAxisMeters:g,eccentricity:y,isActive:!0},{spatialReferenceCD:wt,spatialReferenceName:lt,coordSysTypeCD:At,coordSysCD:H,coordSysName:lt,originLatitude:null,originLongitude:null,datumCD:w,mapUnitCD:T,ellipsoidCD:n,ellipsoidName:h,equitorialAxisMeters:g,eccentricity:y,isActive:!0},{spatialReferenceCD:Et,spatialReferenceName:ct,coordSysTypeCD:At,coordSysCD:X,coordSysName:ct,originLatitude:null,originLongitude:null,datumCD:w,mapUnitCD:T,ellipsoidCD:n,ellipsoidName:h,equitorialAxisMeters:g,eccentricity:y,isActive:!0},{spatialReferenceCD:"EBMUD",spatialReferenceName:ht,coordSysTypeCD:At,coordSysCD:z,coordSysName:ht,originLatitude:null,originLongitude:null,parallelOne:null,parallelTwo:null,originX:null,originY:null,centralScaleFactor:null,mapUnitCD:T,datumCD:I,ellipsoidCD:c,ellipsoidName:d,equitorialAxisMeters:p,eccentricity:R,isActive:!0,inputResolution:1e3,inputResolutionUnitCD:x,latitudeMin:37.518,latitudeMax:38.031,longitudeMin:-122.442626953125,longitudeMax:-121.734008789062,stateCD:"CA",zone:3,gridTemplate:"{0,number,0000}B{1,number,000}",gridCellSizeHorizontal:3e3,gridCellSizeVertical:2e3,baseCoordSysCD:Y},{spatialReferenceCD:Rt,spatialReferenceName:"Lat-long NAD27",coordSysTypeCD:ft,coordSysCD:G,coordSysName:at,originLatitude:0,originLongitude:0,mapUnitCD:_,datumCD:I,ellipsoidCD:c,ellipsoidName:d,equitorialAxisMeters:p,eccentricity:R,isActive:!0},{spatialReferenceCD:Nt,spatialReferenceName:"Lat-long NAD83",coordSysTypeCD:ft,coordSysCD:G,coordSysName:at,originLatitude:null,originLongitude:null,mapUnitCD:_,datumCD:D,ellipsoidCD:o,ellipsoidName:u,equitorialAxisMeters:f,eccentricity:N,isActive:!0},{spatialReferenceCD:Ct,spatialReferenceName:"Lat-long WGS84",coordSysTypeCD:ft,coordSysCD:G,coordSysName:at,originLatitude:null,originLongitude:null,mapUnitCD:_,datumCD:w,ellipsoidCD:n,ellipsoidName:h,equitorialAxisMeters:g,eccentricity:y,isActive:!0},{spatialReferenceCD:"LATLONG_OSGB",spatialReferenceName:"Lat-long OSGB36",coordSysTypeCD:ft,coordSysCD:G,coordSysName:at,originLatitude:0,originLongitude:0,mapUnitCD:_,datumCD:E,ellipsoidCD:s,ellipsoidName:s,equitorialAxisMeters:m,eccentricity:O,isActive:!0},{spatialReferenceCD:yt,spatialReferenceName:"UTM zone 10, NAD83",coordSysTypeCD:Mt,coordSysCD:F,coordSysName:rt,originLatitude:0,originLongitude:-123,originX:5e5,originY:0,centralScaleFactor:.9996,mapUnitCD:b,datumCD:D,ellipsoidCD:o,ellipsoidName:u,equitorialAxisMeters:f,eccentricity:N,isActive:!1},{spatialReferenceCD:Ot,spatialReferenceName:"UTM zone 10, NAD27",coordSysTypeCD:Mt,coordSysCD:F,coordSysName:rt,originLatitude:0,originLongitude:-123,originX:5e5,originY:0,centralScaleFactor:.9996,mapUnitCD:b,datumCD:I,ellipsoidCD:c,ellipsoidName:d,equitorialAxisMeters:p,eccentricity:R,isActive:!1},{spatialReferenceCD:"UTM18_NAD83",spatialReferenceName:"UTM zone 18, NAD83",coordSysTypeCD:Mt,coordSysCD:"UTM18",coordSysName:dt,originLatitude:0,originLongitude:-75,originX:5e5,originY:0,centralScaleFactor:.9996,mapUnitCD:b,datumCD:D,ellipsoidCD:o,ellipsoidName:u,equitorialAxisMeters:f,eccentricity:N,isActive:!1},{spatialReferenceCD:"ALBERS_CONUS",spatialReferenceName:"Albers Equal-area Conic for CONUS",coordSysTypeCD:St,coordSysCD:j,coordSysName:ut,originLatitude:37.5,originLongitude:-96,parallelOne:29.5,parallelTwo:45.5,originX:0,originY:0,centralScaleFactor:1,mapUnitCD:b,datumCD:D,ellipsoidCD:o,ellipsoidName:u,equitorialAxisMeters:f,eccentricity:N,isActive:!0}],Yt=null;function kt(t){try{if(Ut--,MARCONI.stdlib.log("Finished "+(t||" asynch task")+", "+Ut+" tasks still running"),0===Ut&&Gt){for(var e=[],a=0;a<Gt.length;a++)e.push(Gt[a]);for(Gt=null,a=0;a<e.length;a++)e[a]("MARCONI map module is ready to use")}}catch(t){throw"Error registering completion of AJAX map calls at stage : "+t+", onready type is "+typeof Gt}}function Ft(t){Ut++,t&&MARCONI.stdlib.log("Launched "+(t||"asynch task")+", pending task count is "+Ut)}function qt(t,e){return(t||"data")+"_"+(e||"")}function Bt(a,i,r,o,n){function s(e,t,a){try{var i=null;try{i=u.getItem(qt(e,t))}catch(t){MARCONI.stdlib.warn("Exception reading raw "+e+" data from storage: "+t)}if(i){var r=YAHOO.lang.JSON.parse(i),o=r&&r.data||r,n=r&&r.dateStored?"string"==typeof r.dateStored?MARCONI.datetime.parseDate(r.dateStored):r.dateStored:null,s="string"==typeof a.minDate?MARCONI.datetime.parseDate(a.minDate):a.minDate,l=a.maxMinutes?a.maxMinutes:s?null:10080;if(l){var c=new Date((new Date).valueOf()-6e4*l);(!s||s<c)&&(s=c)}if(n&&s<n)return MARCONI.stdlib.log("Got useful "+e+" data "+(t?"for query "+t:"")+" from DOM storage, date stored was "+n+" versus min date of "+s),o;MARCONI.stdlib.log("Got expired "+e+" data for query "+t+" from DOM storage, date stored was "+n+" versus min date of "+s)}else MARCONI.stdlib.log("No useful "+e+" data read from DOM storage"+(t?", "+t:""));return null}catch(t){throw"Error doing user-data get from storage: "+t}}if(!a)throw"Must provide entity to getFromStorage()";if(!r)throw"Must provide onSuccess callback to getFromStorage()";if(!o)throw"Must provide onError callback to getFromStorage()";var u=null;try{if(!(u=YAHOO.util.StorageManager.get(YAHOO.util.StorageEngineHTML5.ENGINE_NAME,YAHOO.util.StorageManager.LOCATION_LOCAL,{force:!0})))return null}catch(t){u=null}if(u){if(u.isReady)try{var t=s(a,i,n);if(!t)return!1;r(t,n)}catch(t){throw"Error doing immediate fetch of "+a+i+" from DOM storage: "+t}else u.subscribe(u.CE_READY,function(t){try{var e=s(a,i,n);e?r(e,n):o("No "+a+" data",n),kt("fetching "+a+" from storage")}catch(t){o(t,n)}}),Ft("fetch of "+a+" from storage");return!0}return!1}function Vt(e,a,i,r,o){function n(e,t,a,i,r){MARCONI.stdlib.log("About to save "+e+t+" data to DOM storage");try{var o=YAHOO.lang.JSON.stringify({data:a,dateStored:MARCONI.datetime.dateToString(new Date)});s.setItem(qt(e,t),o),MARCONI.stdlib.log("Saved "+e+" data to DOM storage"),i&&i("data stored")}catch(t){return MARCONI.stdlib.warn("Error "+t+" trying to save "+e+" data to DOM storage"),r&&r(t),!1}}var s=null;try{if(!(s=YAHOO.util.StorageManager.get(YAHOO.util.StorageEngineHTML5.ENGINE_NAME,YAHOO.util.StorageManager.LOCATION_LOCAL,{force:!0})))return MARCONI.stdlib.log("No storage engine, cannot save "+e+" data to DOM storage"),null}catch(t){s=null}try{if(s)return s.isReady?n(e,a,i,r,o):(MARCONI.stdlib.log("Subscribing to event to save "+e+a+" data to DOM storage"),s.subscribe(s.CE_READY,function(t){n(e,a,i,r,o),kt("Storage of "+e+a)}),Ft("Finished asynch storage of "+e+a)),!0}catch(t){return o&&o(t),!1}return!1}var Ht=[{code:"SEA",sectionName:"Seattle",north:49,south:44.5,west:-125,east:-117},{code:"GTF",sectionName:"Great Falls",north:49,south:44.5,west:-117,east:-109},{code:"BIL",sectionName:"Billings",north:49,south:44.5,west:-109,east:-101},{code:"MSP",sectionName:"Twin Cities",north:49,south:44.5,west:-101,east:-93},{code:"GRB",sectionName:"Green Bay",north:48.25,south:44,west:-93,east:-85},{code:"LHN",sectionName:"Lake Huron",north:48,south:44,west:-85,east:-77},{code:"MON",sectionName:"Montreal",north:48,south:44,west:-77,east:-69},{code:"HFX",sectionName:"Halifax",north:48,south:44,west:-69,east:-61},{code:"LMT",sectionName:"Klamath Falls",north:44.5,south:40,west:-125,east:-117},{code:"SLC",sectionName:"Salt Lake City",north:44.5,south:40,west:-117,east:-109},{code:"CYS",sectionName:"Cheyenne",north:44.5,south:40,west:-109,east:-101},{code:"OMA",sectionName:"Omaha",north:44.5,south:40,west:-101,east:-93},{code:"ORD",sectionName:"Chicago",north:44,south:40,west:-93,east:-85},{code:"DET",sectionName:"Detroit",north:44,south:40,west:-85,east:-77},{code:"NYC",sectionName:"New York",north:44,south:40,west:-77,east:-69},{code:"SFO",sectionName:"San Franciso",north:40,south:36,west:-125,east:-118},{code:"LAX",sectionName:"Los Angeles",north:36,south:32,west:-121.5,east:-115},{code:"LAS",sectionName:"Las Vegas",north:40,south:35.75,west:-118,east:-111},{code:"DEN",sectionName:"Denver",north:40,south:35.75,west:-111,east:-104},{code:"ICT",sectionName:"Wichita",north:40,south:36,west:-104,east:-97},{code:"MKC",sectionName:"Kansas City",north:40,south:36,west:-97,east:-90},{code:"STL",sectionName:"St. Louis",north:40,south:36,west:-91,east:-84},{code:"LUK",sectionName:"Cincinnati",north:40,south:36,west:-85,east:-78},{code:"DCA",sectionName:"Washington",north:40,south:36,west:-79,east:-72},{code:"PHX",sectionName:"Phoenix",north:35.75,south:31.25,west:-116,east:-109},{code:"ABQ",sectionName:"Albuquerque",north:36,south:32,west:-109,east:-102},{code:"DFW",sectionName:"Dallas - Ft. Worth",north:36,south:32,west:-102,east:-95},{code:"MEM",sectionName:"Memphis",north:36,south:32,west:-95,east:-88},{code:"ATL",sectionName:"Atlanta",north:36,south:32,west:-88,east:-81},{code:"CLT",sectionName:"Charlotte",north:36,south:32,west:-81,east:-75},{code:"ELP",sectionName:"El Paso",north:32,south:28,west:-109,east:-103},{code:"SAT",sectionName:"San Antonio",north:32,south:28,west:-103,east:-97},{code:"HOU",sectionName:"Houstone",north:32,south:28,west:-97,east:-91},{code:"MSY",sectionName:"New Orleans",north:32,south:28,west:-91,east:-85},{code:"JAX",sectionName:"Jacksonville",north:32,south:28,west:-85,east:-79},{code:"BRO",sectionName:"Brownsville",north:28,south:24,west:-103,east:-97},{code:"MIA",sectionName:"Miami",north:28,south:24,west:-83,east:-77},{code:"AL_I",sectionName:"Alaska I",north:72,south:68,west:-175,east:-160,widthMinutes:60,heightMinutes:30},{code:"AL_II",sectionName:"Alaska II",north:72,south:68,west:-160,east:-144,widthMinutes:60,heightMinutes:30},{code:"AL_III",sectionName:"Alaska III",north:72,south:68,west:-144,east:-128,widthMinutes:60,heightMinutes:30},{code:"AL_IV",sectionName:"Alaska IV",north:68,south:64,west:-171,east:-158,widthMinutes:60,heightMinutes:30},{code:"AL_V",sectionName:"Alaska V",north:68,south:64,west:-158,east:-145,widthMinutes:60,heightMinutes:30},{code:"AL_VI",sectionName:"Alaska VI",north:68,south:64,west:-145,east:-132,widthMinutes:60,heightMinutes:30},{code:"AL_VII",sectionName:"Alaska VII",north:64,south:60,west:-172,east:-160,widthMinutes:60,heightMinutes:30},{code:"AL_VIII",sectionName:"Alaska VIII",north:64,south:60,west:-160,east:-148,widthMinutes:60,heightMinutes:30},{code:"AL_IX",sectionName:"Alaska IX",north:64,south:60,west:-148,east:-136,widthMinutes:60,heightMinutes:30},{code:"AL_X",sectionName:"Alaska X",north:60,south:56,west:-173,east:-162,widthMinutes:60,heightMinutes:30},{code:"AL_XI",sectionName:"Alaska XI",north:60,south:56,west:-162,east:-151,widthMinutes:60,heightMinutes:30},{code:"AL_XII",sectionName:"Alaska XII",north:60,south:56,west:-151,east:-141,widthMinutes:60,heightMinutes:30},{code:"AL_XIII",sectionName:"Alaska XIII",north:60,south:56,west:-141,east:-131,widthMinutes:60,heightMinutes:30},{code:"AL_XIV",sectionName:"Alaska XIV",north:56,south:52,west:-168,east:-159,widthMinutes:60,heightMinutes:30},{code:"AL_XV",sectionName:"Alaska XV",north:56,south:52,west:-135,east:-126,widthMinutes:60,heightMinutes:30}];return{METERS_TO_SURVEY_FEET:t,SURVEY_FEET_TO_METERS:e,METERS_TO_INTERNATIONAL_FEET:a,INTERNATIONALFEET_TO_METERS:.3048,DEGREES_TO_RADIANS:i,RADIANS_TO_DEGREES:r,RADIUS_CLARKE1866_METERS:p,RADIUS_WGS84_METERS:g,RADIUS_GRS80_METERS:f,RADIUS_CLARKE1866_SURVEYFEET:20925832.163999982,eSquared_CLARKE1866:A,E_CLARKE1866:R,RADIUS_GRS80_SURVEYFEET:20925604.474166647,RADIUS_GRS80_INTERNATIONALFEET:20925646.325459316,eSquared_WGS84:S,eSquared_GRS80:C,E_GRS80:N,E_WGS84:y,DATUM_HORIZ_1927:I,DATUM_HORIZ_1983:D,DATUM_HORIZ_WGS84:w,DATUM_HORIZ_OSGB:E,DATUM_HORIZ_IRISH65:L,DATUM_HORIZ_WGS84_STR:$,UNITS_INTERNATIONALFEET:"ft",UNITS_SURVEYFEET:x,UNITS_METERS:b,UNITS_KILOMETERS:"km",UNITS_MILES:"mi",UNITS_DEGREES:_,UNITS_GRID:T,UNITS_SQUAREMETERS:"sqm",UNITS_ACRES:"ac",UNITS_HECTARES:U,UNITS_DEGREES_STR:tt,COORDSYS_WORLD:G,COORDSYS_CAZONE2:P,COORDSYS_CAZONE3:Y,COORDSYS_CAZONE4:k,COORDSYS_UTM10:F,COORDSYS_USNG:q,COORDSYS_MGRS:B,COORDSYS_GARS:V,COORDSYS_OSGB:K,COORDSYS_IRISH:Q,COORDSYS_CAP_CLASSIC:H,COORDSYS_CAP_CELL:X,COORDSYS_ALBERS_CONUS:j,COORDSYS_EBMUDGRID:z,COORDSYS_LAMBERTCUSTOM:Z,COORDSYS_TMCUSTOM:W,COORDSYS_UTM:J,COORDSYS_WORLD_STR:at,DATUM_HORIZ_DEFAULT:"WGS84",DATUM_HORIZ_DEFAULT_STR:"WGS84",UNITS_DEFAULT:"degrees",COORDSYS_DEFAULT:"WORLD",COORDSYS_TYPE_WORLD:ft,COORDSYS_TYPE_LAMBERT:mt,COORDSYS_TYPE_ALBERS:St,COORDSYS_TYPE_TM:Mt,COORDSYS_TYPE_GRID:At,COORDSYS_TYPE_ATLAS:"ATLAS",COORDSYS_TYPE_MERCATOR:"MERCATOR",COORDSYS_TYPE_STEREO:"STEREO",SPATIALREF_LATLONG_WGS84:Ct,SPATIALREF_LATLONG_NAD27:Rt,SPATIALREF_LATLONG_NAD83:Nt,SPATIALREF_UTM10_NAD83:yt,SPATIALREF_UTM10_NAD27:Ot,SPATIALREF_EBMUDGRID:"EBMUD",SPATIALREF_USNG:Dt,SPATIALREF_GARS:"GARS",SPATIALREF_OSGB:"OSGB",SPATIALREF_IRISH:"IRISH",SPATIALREF_CAP_CLASSIC:wt,SPATIALREF_CAP_CELL:Et,SPATIALREF_UTM_NAD83:vt,SPATIALREF_UTM_NAD27:It,SPATIALREF_DEFAULT_INPUT:Ct,SPATIALREF_DEFAULT_OUTPUT:Dt,SPATIALREF_FOR_STORAGE:Ct,getCanonicalDatumSet:function(t){if(Yt&&!t)return Yt;Yt=[];for(var e=0;e<_t.length;e++)if("SYNONYM"==_t[e].datumShiftMethodCD){var a=this.canonicalDatum(_t[e].fromDatumCD,!0),i=this.canonicalDatum(_t[e].toDatumCD,!0);a||i?a&&!i?Yt[_t[e].toDatumCD]=a:i&&!a&&(Yt[_t[e].fromDatumCD]=i):(Yt[_t[e].fromDatumCD]=_t[e].fromDatumCD,Yt[_t[e].toDatumCD]=_t[e].fromDatumCD)}return Yt},canonicalDatum:function(t,e){var a=this.getCanonicalDatumSet()[t];return a||e?a:t},isDatumUsedByCoordSys:function(t,e){for(var a=0;a<Pt.length;a++)if(Pt[a].datumCD==t&&Pt[a].coordSysCD==e)return!0;return!1},coordSysGivenAtlas:function(t){for(var e=0;e<bt.length;e++)if("ATLAS"==bt[e].coordSysTypeCD&&bt[e].atlasGN==t)return bt[e];return null},spatialRefGivenAtlas:function(t){var e=this.coordSysGivenAtlas(t);if(!e)throw"Cannot find a coordinate system for atlas "+t;for(var a=null,i=0;i<Pt.length;i++)if(Pt[i].coordSysCD==e.coordSysCD){a=Pt[i];break}a||(a={coordSysTypeCD:e.coordSysTypeCD,coordSysCD:e.coordSysCD,coordSysName:e.coordSysName,datumCD:MARCONI.map.DATUM_HORIZ_WGS84,mapUnitCD:MARCONI.map.UNITS_GRID,spatialReferenceCD:"ad-hoc",spatialReferenceName:"ad hoc spatial reference for atlas "+t},Pt.push(a));var r=new MARCONI.map.SpatialReference(a.coordSysCD,a.datumCD,a.mapUnitCD);if(!r)throw"Unable to get spatial reference for atlas "+t;return r},canConvertDatum:function(t,e){if(t==e)return!0;for(var a=0;a<_t.length;a++){var i=this.canonicalDatum(_t[a].fromDatumCD),r=this.canonicalDatum(_t[a].toDatumCD);if(t==i&&e==r||e==i&&t==r)return!0}return!1},destinationDatums:function(e){try{for(var t=this.canonicalDatum(e),a=[],i=0;i<Lt.length;i++){var r=this.canonicalDatum(Lt[i].datumCD);this.canConvertDatum(t,r)&&a.push(Lt[i])}return a.length?a:null}catch(t){throw"Error getting list of destination datums from datum code "+e+": "+t}},isUnitUsedByCoordSys:function(t,e){for(var a=0;a<Pt.length;a++)if(Pt[a].mapUnitCD==t&&Pt[a].coordSysCD==e)return!0;return!1},isCoordSysUsedByAnySpatialRef:function(t){for(var e=0;e<Pt.length;e++)if(Pt[e].coordSysCD==t)return!0;return!1},populateSpatialReferenceList:function(e,t,a){try{var i=MARCONI.stdlib.listboxSelectedValue(e);MARCONI.stdlib.listboxClear(e),t&&MARCONI.stdlib.listboxAddItem(e,"Automatic",""),MARCONI.stdlib.log("updating list control of spatial refs");for(var r=0;r<Pt.length;r++)if(Pt[r].isActive&&(!a||Pt[r].coordSysTypeCD===this.COORDSYS_TYPE_GRID&&Pt[r].gridTemplate)){var o=MARCONI.stdlib.listboxAddItem(e,Pt[r].spatialReferenceName,Pt[r].spatialReferenceCD);o&&Pt[r].description&&(o.title=Pt[r].description)}else MARCONI.stdlib.log("skipping ",Pt[r]);MARCONI.stdlib.listboxSynchToValue(e,i),MARCONI.stdlib.listboxSelectedIndex(e)<0&&MARCONI.stdlib.listboxSynchToValue(e,"")}catch(t){throw"Cannot populate spatial ref list "+e+": "+t}},spatialRefGivenCode:function(t){for(var e=0;e<Pt.length;e++)if(Pt[e].spatialReferenceCD===t)return new MARCONI.map.SpatialReference(Pt[e].coordSysCD,Pt[e].datumCD,Pt[e].mapUnitCD);return null},spatialRefGivenComponents:function(t,e,a){return new MARCONI.map.SpatialReference(t,e,a)},parseLatLong:function(e){if(!e)return null;try{var t=new RegExp("^([\\d\\+\\-.]+)[\\^d°]?[\\s]*([\\d.]*)['′]?[\\s]*([\\d.]*)[\"″]?[\\s]*(North?|South?|N?|S?)[,\\s]+([\\d\\+\\-.]+)[\\^d°]?[\\s]*([\\d.]*)['′]?[\\s]*([\\d.]*)[\"″]?[\\s]*(West?|East?|W?|E?)$","i").exec(e.trim());if(t&&9==t.length){var a=t[1],i=a<0?-1:1;if(90<(a=Math.abs(a)))throw"Latitude "+t[1]+" out of bounds, must be between -90 and 90";a+=t[2]?t[2]/60:0,a+=t[3]?t[3]/3600:0,t[4]&&"S"==t[4].substr(0,1).toUpperCase()&&(i=-1),a*=i;var r=t[5],o=r<0?-1:1;if(180<(r=Math.abs(r)))throw"Longitude "+t[5]+" out of bounds, must be between -180 and 180";return r+=t[6]?t[6]/60:0,r+=t[7]?t[7]/3600:0,t[8]&&"W"==t[8].substr(0,1).toUpperCase()&&(o=-1),r*=o,new MARCONI.map.GeoPoint(r,a)}return null}catch(t){throw"Error parsing "+e+" as lat-long: "+t}},parseUTMGridRef:function(t){if("string"!=typeof t||0===t.length)return null;var e=new RegExp("^([\\d]{1,2})[\\s]*([c-x]|north|south)[\\s]+([\\d.,]*)E?[\\s]+([\\d.,]*)N?$","i").exec(t);if(e&&5==e.length){for(var a=[],i=1;i<e.length;i++)a.push(e[i].toUpperCase());return a}return null},parseUSNGGridRef:function(t){if("string"!=typeof t||0===t.length)return null;var e=new RegExp("^([0-9]{0,2})[\\s]*([ABCDEFGHJKLMNPQRSTUVWXYZ])[\\s]*([ABCDEFGHJKLMNPQRSTUVWXYZ]?[ABCDEFGHJKLMNPQRSTUV]?)[\\s]*([0-9]*)[\\s]*([0-9]*)$","i").exec(t);if(!e)return null;var a=[];a.push(e[1]),a.push(e[2].toUpperCase()),a.push(e[3].toUpperCase());var i=0<="ABYZ".indexOf(e[2].toUpperCase());if(i==0<e[1].length||2!=e[3].length&&!i)return null;if(""!==e[5])a.push(e[4]),a.push(e[5]);else if(""!==e[4]){if(e[4].length%2!=0)return null;a.push(e[4].substr(0,e[4].length/2)),a.push(e[4].substr(e[4].length/2))}else a.push(""),a.push("");return a},isValidUTM:function(e){try{return null!=MARCONI.map.parseUTMGridRef(e)}catch(t){throw"MARCONI.map.isValidUTM(): Error checking grid value "+e+", err is "+t}},isValidUSNG:function(e){try{return null!=this.parseUSNGGridRef(e)}catch(t){throw"MARCONI.map.isValidUSNG(): Error checking grid value "+e+", err is "+t}},defaultSpatialRefGivenXY:function(e,a){try{var t=null;return t=MARCONI.map.isValidUSNG(e)?new MARCONI.map.SpatialReference(MARCONI.map.COORDSYS_USNG,MARCONI.map.DATUM_HORIZ_1983,MARCONI.map.UNITS_GRID):MARCONI.map.isValidUTM(e)?new MARCONI.map.SpatialReference(MARCONI.map.COORDSYS_UTM,MARCONI.map.DATUM_HORIZ_1983,MARCONI.map.UNITS_GRID):MARCONI.map.isDegrees(e)&&MARCONI.map.isDegrees(a)?new MARCONI.map.SpatialReference(MARCONI.map.COORDSYS_WORLD,MARCONI.map.DATUM_HORIZ_WGS84,MARCONI.map.UNITS_DEGREES):Math.abs(e)<18e5&&Math.abs(a)<7e5?new MARCONI.map.SpatialReference(MARCONI.map.COORDSYS_CAZONE3,MARCONI.map.DATUM_HORIZ_1927,MARCONI.map.UNITS_SURVEYFEET):new MARCONI.map.SpatialReference(MARCONI.map.COORDSYS_CAZONE3,MARCONI.map.DATUM_HORIZ_1983,MARCONI.map.UNITS_SURVEYFEET),MARCONI.stdlib.log("Spatial ref is ",t," given x,y of "+e+", "+a),t}catch(t){throw"MARCONI.map.defaultSpatialRefGivenXY(): "+t+", given x,y of "+e+", "+a}},populateHorizontalDatumList:function(t,e,a){try{"string"==typeof t&&(t=document.getElementById(t));var i=MARCONI.stdlib.listboxSelectedValue(t);MARCONI.stdlib.listboxClear(t);for(var r=a?this.destinationDatums(a):null,o=0;o<Lt.length;o++)Lt[o].isActive&&(e&&!this.isDatumUsedByCoordSys(Lt[o].datumCD,e)||r&&!r.indexOf(Lt[o].datumCD)||MARCONI.stdlib.listboxAddItem(t,Lt[o].datumName,Lt[o].datumCD));MARCONI.stdlib.listboxSynchToValue(t,i),0<t.options.length&&t.selectedIndex<0&&(t.selectedIndex=0)}catch(t){throw"error in MARCONI.map.populateHorizontalDatumList(): "+t}},populateDatumShiftList:function(t,e,a,i){try{"string"==typeof t&&(t=document.getElementById(t));var r=MARCONI.stdlib.listboxSelectedValue(t);MARCONI.stdlib.listboxClear(t);for(var o=0;o<_t.length;o++)if(_t[o].isActive){var n=this.canonicalDatum(_t[o].fromDatumCD),s=this.canonicalDatum(_t[o].toDatumCD);if((n==e&&s==a||s==e&&n==a)&&(!i||!_t[o].isAvailableOnServerOnly)){var l=_t[o].datumShiftMethodName;_t[o].datumShiftName&&(l+=" ["+_t[o].datumShiftName+"]"),_t[o].isAvailableOnServerOnly&&(l+=" [server only]");var c=_t[o].datumShiftMethodCD;_t[o].datumShiftName&&(c+=" "+_t[o].datumShiftName),MARCONI.stdlib.listboxAddItem(t,l,c)}}MARCONI.stdlib.listboxSynchToValue(t,r),0<t.options.length&&t.selectedIndex<0&&(t.selectedIndex=0)}catch(t){throw"error in MARCONI.map.populateDatumShiftList(): "+t}},getDatumShift:function(t,e,a,i,r){var o=null;a&&0<a.indexOf(" ")&&(o=a.substr(a.indexOf(" ")+1),a=a.substr(0,a.indexOf(" ")));for(var n=0;n<_t.length;n++)if(!(a&&_t[n].datumShiftMethodCD!=a||this.canonicalDatum(_t[n].fromDatumCD)!=t||this.canonicalDatum(_t[n].toDatumCD)!=e||o&&o!=_t[n].datumShiftName)&&(!i||this.isDatumShiftOkayForGivenPoint(_t[n],i))&&!_t[n].isAvailableOnServerOnly)return _t[n];return null},isDatumShiftOkayForGivenPoint:function(t,e){if(!e||!e.x||!e.y)throw"Invalid point passed to isDatumShiftOkayForGivenPoint() in map.js";return(!t.latitudeMin||t.latitudeMin<e.y)&&(!t.longitudeMin||t.longitudeMin<e.x)&&(!t.latitudeMax||t.latitudeMax>e.y)&&(!t.longitudeMax||t.longitudeMax>e.x)},populateUnitsList:function(t,e,a){try{"string"==typeof t&&(t=document.getElementById(t));var i=MARCONI.stdlib.listboxSelectedValue(t);MARCONI.stdlib.listboxClear(t);for(var r=0;r<xt.length;r++)xt[r].isActive&&(e&&!this.isUnitUsedByCoordSys(xt[r].mapUnitCD,e)||(!a||"linear"==a.toLowerCase()&&xt[r].isLinear||"areal"==a.toLowerCase()&&xt[r].isAreal)&&MARCONI.stdlib.listboxAddItem(t,xt[r].unitName,xt[r].mapUnitCD));MARCONI.stdlib.listboxSynchToValue(t,i),0<t.options.length&&t.selectedIndex<0&&(t.selectedIndex=0)}catch(t){throw"error in MARCONI.map.populateUnitsList(): "+t}},populateCoordSysList:function(t,e){try{var a=MARCONI.stdlib.listboxSelectedValue(t);MARCONI.stdlib.listboxClear(t);for(var i=0;i<bt.length;i++)bt[i].isActive&&(e||this.isCoordSysUsedByAnySpatialRef(bt[i].coordSysCD))&&MARCONI.stdlib.listboxAddItem(t,bt[i].coordSysName,bt[i].coordSysCD);MARCONI.stdlib.listboxSynchToValue(t,a)}catch(t){throw"error in MARCONI.map.populateCoordSysList(): "+t}},mapUnitGivenCode:function(t){for(var e=0;e<xt.length;e++)if(t==xt[e].mapUnitCD)return xt[e];return MARCONI.stdlib.log("Unknown unit "+t),null},datumGivenCode:function(t){for(var e=0;e<Lt.length;e++)if(t==Lt[e].datumCD)return Lt[e];return null},coordSysGivenCode:function(t){for(var e=0;e<bt.length;e++)if(t==bt[e].coordSysCD)return bt[e];return null},getCAPClassicGridSections:function(){return Ht},refCount:function(){return Pt.length},datumCount:function(){return Lt.length},unitsCount:function(){return xt.length},coordSysCount:function(){return bt.length},coordSysGivenIndex:function(t){return bt[t]},spatialRefGivenIndex:function(t){return Pt[t]},spatialRefInfoLookup:function(t,e,a){for(var i=0;i<Pt.length;i++)if(Pt[i].datumCD===e&&Pt[i].mapUnitCD===a&&Pt[i].coordSysCD===t)return Pt[i];return null},getUSNGZoneSet:function(t){try{return parseInt(t-1,10)%6+1}catch(t){throw"getUSNGZoneSet(): unknown error "+t}},getUTMZoneFromLatLong:function(t,e){e=e<=180?e:e-360;var a=Math.floor((e+180)/6)+1;return 56<=t&&t<64&&3<=e&&e<12?a=32:72<=t&&t<84&&(0<=e&&e<9?a=31:9<=e&&e<21?a=33:21<=e&&e<33?a=35:33<=e&&e<42&&(a=37)),a},UTMSpatialRef:function(t,e,a){a||(a=this.DATUM_HORIZ_1983);var i=new MARCONI.map.SpatialReference(this.COORDSYS_TMCUSTOM,a,this.UNITS_METERS),r=6*(t-1)-180+3,o=e&&e<"N"?1e7:0;return i.setCustomParams(0,0,0,r,5e5,o,.9996),i},updateAll:function(t){var e=null;t&&t.onComplete&&(e=t.onComplete,t.onComplete=null),this.updateSpatialRefList(t),this.updateCoordSysList(t),this.updateDatumList(t),this.updateMapUnitList(t),this.registerAJAXCallback(e)},registerAJAXCallback:function(t){if(t&&(Gt||(Gt=[]),Gt.push(t)),0===Ut){if(MARCONI.stdlib.log("All AJAX map.js calls completed"),Gt){for(var e=0;e<Gt.length;e++)Gt[e]("MARCONI map module is ready to use");Gt=null}}else MARCONI.stdlib.log(Ut+" AJAX map.js calls pending")},updateSpatialRefList:function(t){var e;(e=t?MARCONI.stdlib.clone(t):{}).spatialRefArray=Pt;try{var i=void 0===e.activeOnly?"":"&IsActive="+e.activeOnly;if(!window.YAHOO||!YAHOO.util.Storage||e&&(e.noStorage||e.noReadStorage))MARCONI.stdlib.log("DOM storage either not available, or noStorage option passed for spatialref "+i+", fetching list with AJAX call","info","clientinclude/map.js");else{MARCONI.stdlib.log("Attempting to get spatial ref list from DOM storage "+i);try{if(Bt("spatialref",i,function(t,e){o(t,e),e&&e.onComplete&&e.onComplete()},function(t,e){MARCONI.stdlib.log(t+", spatial ref list not found in storage, calling again with noReadStorage option"),e.noReadStorage=!0,MARCONI.map.updateSpatialRefList(e)},e))return}catch(t){return MARCONI.stdlib.log("Exception "+t+" reading spatial ref list from DOM storage, calling again with noReadStorage option"),e||(e={}),e.noReadStorage=!0,void MARCONI.map.updateSpatialRefList(e)}MARCONI.stdlib.log("spatialref, "+i+" data not available in DOM storage cache, fetching list with AJAX call")}var a=new YAHOO.util.DataSource("../ajax/Lookup?entity=spatialreference");a.responseType=YAHOO.util.DataSource.TYPE_JSON,a.responseSchema={resultsList:"data.Results",fields:["spatialReferenceGN","spatialReferenceCD","spatialReferenceName","baseCoordSysCD","gridTemplate","gridCellSizeHorizontal","gridCellSizeVertical","description","isSystem","isActive","WKID","coordSysCD","coordSysName","coordSysTypeCD","coordSysTypeName","originLatitude","originLongitude","parallelOne","parallelTwo","centralScaleFactor","stateCD","stateName","zone","ellipsoidCD","ellipsoidName","datumCD","datumName","equitorialAxisMeters","eccentricity","mapUnitCD","collatingValue","originX","originY","inputResolution","inputResolutionUnitCD","latitudeMin","latitudeMax","longitudeMin","longitudeMax","atlasGN"]},a.maxCacheEntries=2;var r={success:function(t,e,a){a&&a.noStorage||Vt("spatialref",i,e.results),o(e.results,a),kt("AJAX load of spatialref list")},failure:function(t,e,a){throw"Failed to get list of spatial references, response was "+MARCONI.stdlib.logObject(e,"response")},scope:this,argument:e};a.doBeforeParseData=function(t,e){return void 0===e.data&&(e.replyCode?alert("error "+e.replyCode+": "+MARCONI.stdlib.friendlyErrorMessage(e.replyText)):alert("Unknown error getting spatial reference list")),e},a.sendRequest(i,r),Ft()}catch(t){throw"map.js: error launching AJAX request for update of spatial references: "+t}function o(t,e){try{if(!e)throw"Missing required args parameter to function _updateRefs in map.js";var a=0,i=0;if(!t)throw"No data received from AJAX call for spatial references";if(0<t.length){for(var r=0;r<t.length;r++){var o=n(e.spatialRefArray,t[r]);"Add"===o?(a++,e.onAdd&&e.onAdd(t[r])):"Update"===o&&(i++,e.onUpdate&&e.onUpdate(t[r]))}if(0<a||0<i)try{e.spatialRefArray.sort(function(t,e){try{return void 0===t.collatingValue||void 0===e.collatingValue||t.collatingValue===e.collatingValue?MARCONI.stdlib.strcmp(t.spatialReferenceName,e.spatialReferenceName):t.collatingValue-e.collatingValue}catch(t){return MARCONI.stdlib.log("error in sort compare func for spatial ref, working around it, err is "+t),0}})}catch(t){MARCONI.stdlib.log("error trying to sort spatial refs:"+t)}}e.onComplete&&e.onComplete("Added "+a+" spatial references, updated "+i)}catch(t){alert("Error updating spatial references with AJAX data, error is "+t)}}function n(t,e){try{var a=e.spatialReferenceCD;if(!a)throw"Got bad data in place of a spatial reference: "+MARCONI.stdlib.logObject(e);for(var i=!1,r=null,o="",n=0;n<t.length;n++)if(t[n].spatialReferenceCD===a){i=!0,r=n;break}if(i)for(var s in e)void 0!==e[s]&&null!==e[s]&&t[r][s]!==e[s]&&(o="Update",t[r][s]=e[s]);else t.push(e),r=t.length-1,o="Add";return t[r].baseCoordSysCD,o}catch(t){throw"Error updating spatial reference "+e+": "+t}}},updateCoordSysList:function(t){try{var e;t?((e=MARCONI.stdlib.clone(t)).onComplete=t.onComplete,e.onError=t.onError):e={};var i=void 0===e.activeOnly?"&IsActive=true":"&IsActive="+e.activeOnly;if(window.YAHOO&&YAHOO.util.Storage&&(!e||!e.noReadStorage&&!e.noStorage)){try{if(Bt("coordsys",i,function(t,e){o(t,e),e&&e.onComplete&&e.onComplete("Got coord sys list from storage")},function(t,e){MARCONI.stdlib.warn(t+", coordinate system list not read from storage, calling again with noReadStorage option"),e.noReadStorage=!0,MARCONI.map.updateCoordSysList(e)},e))return}catch(t){return MARCONI.stdlib.log("Exception reading coord sys list from DOM storage: "+t+", calling again with noReadStorage option"),e||(e={}),e.noReadStorage=!0,void MARCONI.map.updateCoordSysList(e)}MARCONI.stdlib.log("coordsys, "+i+" data not available in DOM storage cache, fetching list with AJAX call")}var a=new YAHOO.util.DataSource("../ajax/Lookup?entity=coordsys");a.responseType=YAHOO.util.DataSource.TYPE_JSON,a.responseSchema={resultsList:"data.Results",fields:["coordSysCD","coordSysName","coordSysTypeCD","coordSysTypeName","stateCD","stateName","zone","isActive","isSystem","atlasGN","collatingValue","atlasGN","gridTemplate","gridCellSizeHorizontal","gridCellSizeVertical","baseCoordSysCD"]},a.maxCacheEntries=2;var r={success:function(t,e,a){a&&a.noStorage||Vt("coordsys",i,e.results),o(e.results,a),kt("AJAX load of coordsys list")},failure:function(t,e,a){throw"Failed to get list of coordinate systems, response was "+MARCONI.stdlib.logObject(e,"response")},scope:this,argument:e};a.doBeforeParseData=function(t,e){return void 0===e.data&&(e.replyCode?alert("error "+e.replyCode+": "+MARCONI.stdlib.friendlyErrorMessage(e.replyText)):alert("Unknown error getting list of coordinate systems")),e},a.sendRequest(i,r),Ft()}catch(t){throw"map.js: error launching AJAX request for update of coordinate systems: "+t}function o(t,e){var a="init";try{if(!e)throw"Missing required args parameter to function _updateCoordSystems in map.js";var i=0,r=0;if(!t)throw"No data received from AJAX call for coordinate systems";if(0<t.length){for(var o=0;o<t.length;o++){a="processing item "+o;var n=s(bt,t[o]);"Add"===n?(i++,e.onAdd&&e.onAdd(t[o])):"Update"===n&&(r++,e.onUpdate&&e.onUpdate(t[o]))}if(0<i||0<r){a="sorting";try{bt.sort(function(t,e){try{return void 0===t.collatingValue||void 0===e.collatingValue||t.collatingValue===e.collatingValue?MARCONI.stdlib.strcmp(t.coordSysName,e.coordSysName):t.collatingValue-e.collatingValue}catch(t){return MARCONI.stdlib.log("sorter returning zero to work around error: "+t),0}})}catch(t){MARCONI.stdlib.log("non-fatal error sorting coordinate systems: "+t)}}}e.onComplete&&e.onComplete("Added "+i+" coordinate systems, updated "+r,e.callbackArg)}catch(t){alert("Error updating coordinate systems with AJAX data at stage "+a+", error is "+t)}}function s(t,e){try{var a=e.coordSysCD;if(!a)throw"Got bad data in place of a coordSysCD: "+MARCONI.stdlib.logObject(e);for(var i=!1,r=null,o="",n=0;n<t.length;n++)if(t[n].coordSysCD===a){i=!0,r=n;break}if(i)for(var s in t[r])t[r][s]!==e[s]&&(o="Update");else t.push(e),r=t.length-1,o="Add";return t[r]=e,o}catch(t){throw"Error updating coordinate system "+MARCONI.stdlib.logObject(e)+": "+t}}},isAtlasLoaded:function(t){return void 0!==Tt[t]},getAtlas:function(t){return Tt[t]},dumpAtlases:function(t){for(var e in Tt)Tt.hasOwnProperty(e)&&MARCONI.stdlib.log("key is "+e+", atlas is "+Tt[e]+MARCONI.stdlib.logObject(Tt[e]))},getAtlasByAjax:function(e){try{if(!e)throw"Options required, since at least atlasGN is required";if(!e.atlasGN)throw"atlasGN is required to load an atlas";var i="&AtlasGN="+e.atlasGN;if(YAHOO.util.Storage&&(!e||!e.noReadStorage&&!e.noStorage)){MARCONI.stdlib.log("Attempting to get atlas page list from DOM storage, "+i);try{if(Bt("atlaspage",i,function(t,e){r(t,e)},function(t,e){MARCONI.stdlib.log(t+", atlas pages not found in storage, calling again with noReadStorage option"),e.noReadStorage=!0,MARCONI.map.getAtlasByAjax(e)},e))return}catch(t){return MARCONI.stdlib.log("Exception reading atlas pages: "+t+", calling again with noReadStorage option"),(e=e||{}).noReadStorage=!0,void MARCONI.map.getAtlasByAjax(e)}MARCONI.stdlib.log("atlaspage, "+i+" data not available in DOM storage cache, fetching list with AJAX call")}MARCONI.stdlib.log("Loading atlas pages for atlas "+e.atlasGN);var t=new YAHOO.util.DataSource("../ajax/Lookup?entity=atlaspage");t.responseType=YAHOO.util.DataSource.TYPE_JSON,t.responseSchema={resultsList:"data.Results",fields:["atlasPageGN","pageIdentifier","atlasPageTypeCD","hasGridOnPage","gridIncreasesDownPage","gridFirstHorizontal","gridFirstVertical","gridCellCountHorizontal","gridCellCountVertical","imageOverlayURL","mapUnitCD","pageHeightMapUnits","pageWidthMapUnits","geometricShapeGN","latitudeMin","latitudeMax","longitudeMin","longitudeMax","horizontalGridValueList","verticalGridValueList"]},t.maxCacheEntries=2;var a={success:function(t,e,a){a&&a.noStorage||Vt("atlaspage",i,e.results),r(e.results,a),kt("AJAX fetch of atlas "+i.atlasGN)},failure:function(t,e,a){throw"Failed to get list of atlas pages, response was "+MARCONI.stdlib.logObject(e,"response")},scope:this,argument:e};t.doBeforeParseData=function(t,e){return void 0===e.data&&(e.replyCode?alert("error "+e.replyCode+": "+MARCONI.stdlib.friendlyErrorMessage(e.replyText)):alert("Unknown error getting list of atlas pages")),e},t.sendRequest(i,a),Ft("ajax request for atlas pages")}catch(t){throw"map.js: error launching AJAX request for update of atlas pages: "+t}function r(t,e){try{if(!e)throw"Missing required args parameter to function _updateAtlasPages in map.js";if(!e.atlasGN)throw"Missing required args parameter atlasGN in function _updateAtlasPages in map.js";var a=0;if(!t)throw"No data received from AJAX call for atlas pages";a=(Tt[e.atlasGN]=t).length,e.onComplete?e.onComplete(e.atlasGN,"Loaded "+a+" pages for atlas "+e.atlasGN,e.callBackExtraArg):MARCONI.stdlib.log("No onComplete func for atlas load, args is "+MARCONI.stdlib.logObject(e))}catch(t){throw"Error updating atlas page list with AJAX data, error is "+t}}},updateDatumList:function(t){try{var e,i=void 0===(e=t?MARCONI.stdlib.clone(t):{}).activeOnly?"&IsActive=true":"&IsActive="+e.activeOnly;if(YAHOO.util.Storage&&(!e||!e.noReadStorage&&!e.noStorage)){try{if(Bt("datum",i,function(t,e){o(t,e),e&&e.onComplete&&e.onComplete()},function(t,e){MARCONI.stdlib.log(t+", datum list not found in storage, calling again with noReadStorage option"),e.noReadStorage=!0,MARCONI.map.updateDatumList(e)},e))return}catch(t){return MARCONI.stdlib.log("Exception "+t+" reading datum list from storage, calling again with noReadStorage option"),e||(e={}),e.noReadStorage=!0,void MARCONI.map.updateDatumList(e)}MARCONI.stdlib.log("datum, "+i+" data not available in DOM storage cache, fetching list with AJAX call")}var a=new YAHOO.util.DataSource("../ajax/Lookup?entity=datum");a.responseType=YAHOO.util.DataSource.TYPE_JSON,a.responseSchema={resultsList:"data.Results",fields:["datumCD","datumName","description","ellipsoidCD","ellipsoidName","isActive","equitorialAxisMeters","polarAxisMeters","eccentricity","eccentricitySquared","flatteningInverse","collatingValue"]},a.maxCacheEntries=2;var r={success:function(t,e,a){a&&a.noStorage||Vt("datum",i,e.results),o(e.results,a),kt("AJAX fetch of datum list")},failure:function(t,e,a){throw"Failed to get list of datums, response was "+MARCONI.stdlib.logObject(e,"response")},scope:this,argument:e};a.doBeforeParseData=function(t,e){return void 0===e.data&&(e.replyCode?alert("error "+e.replyCode+": "+MARCONI.stdlib.friendlyErrorMessage(e.replyText)):alert("Unknown error getting datum list")),e},a.sendRequest(i,r),Ft()}catch(t){throw"map.js: error launching AJAX request for update of datums: "+t}function o(t,e){try{if(!e)throw"Missing required args parameter to function _updateDatums in map.js";var a=0,i=0;if(!t)throw"No data received from AJAX call for datums";if(0<t.length){for(var r=0;r<t.length;r++){var o=n(Lt,t[r]);"Add"===o?(a++,e.onAdd&&e.onAdd(t[r])):"Update"===o&&(i++,e.onUpdate&&e.onUpdate(t[r]))}if(0<a||0<i)try{Lt.sort(function(t,e){try{return void 0===t.collatingValue||void 0===e.collatingValue||t.collatingValue==e.collatingValue?MARCONI.stdlib.strcmp(t.datumName,e.datumName):t.collatingValue-e.collatingValue}catch(t){return MARCONI.stdlib.log("Error comparing datums: "+t),0}})}catch(t){MARCONI.stdlib.log("Error sorting datums: "+t)}}MARCONI.map.updateDatumShiftList(e)}catch(t){alert("Error updating datum list with AJAX data, error is "+t)}}function n(t,e){try{var a=e.datumCD;if(!a)throw"Got bad data in place of a datum: "+MARCONI.stdlib.logObject(e);for(var i=!1,r=null,o="",n=0;n<t.length;n++)if(t[n].datumCD===a){i=!0,r=n;break}if(i)for(var s in t[r])t[r][s]!==e[s]&&(o="Update");else t.push(e),r=t.length-1,o="Add";return t[r]=e,o}catch(t){throw"Error updating datum "+MARCONI.stdlib.logObject(e)+": "+t}}},updateDatumShiftList:function(t){try{var e,i=void 0===(e=t?MARCONI.stdlib.clone(t):{}).activeOnly?"&IsActive=true":"&IsActive="+e.activeOnly;if(YAHOO.util.Storage&&(!e||!e.noReadStorage&&!e.noStorage)){try{if(Bt("datumshift",i,function(t,e){o(t,e),e&&e.onComplete&&e.onComplete()},function(t,e){MARCONI.stdlib.log(t+", datumshift list not found in storage, calling again with noReadStorage option"),e.noReadStorage=!0,MARCONI.map.updateDatumShiftList(e)},e))return}catch(t){return MARCONI.stdlib.log("Exception reading datum shifts from storage: "+t+", calling again with noReadStorage option"),e||(e={}),e.noReadStorage=!0,void MARCONI.map.updateDatumShiftList(e)}MARCONI.stdlib.log("coordsys, "+i+" data not available in DOM storage cache, fetching list with AJAX call")}var a=new YAHOO.util.DataSource("../ajax/Lookup?entity=datumshift");a.responseType=YAHOO.util.DataSource.TYPE_JSON,a.responseSchema={resultsList:"data.Results",fields:["fromDatumCD","toDatumCD","datumShiftMethodCD","datumShiftMethodName","datumShiftName","datumShiftGN","latitudeMin","latitudeMax","longitudeMin","longitudeMax","shiftX","shiftY","shiftZ","scaleFactor","rotationX","rotationY","rotationZ","latitudeCoefficients","longitudeCoefficients","isAvailableOnServerOnly","isActive"]},a.maxCacheEntries=2;var r={success:function(t,e,a){a&&a.noStorage||Vt("datumshift",i,e.results),o(e.results,a),kt("AJAX fetch of datum shift list")},failure:function(t,e,a){throw"Failed to get list of datum shifts, response was "+MARCONI.stdlib.logObject(e,"response")},scope:this,argument:e};a.doBeforeParseData=function(t,e){return void 0===e.data&&(e.replyCode?alert("error "+e.replyCode+": "+MARCONI.stdlib.friendlyErrorMessage(e.replyText)):alert("Unknown error getting list of datum shifts")),e},a.sendRequest(i,r),Ft()}catch(t){throw"map.js: error launching AJAX request for update of datum shifts: "+t}function o(t,e){try{var a=0,i=0;if(!t)throw"No data received from AJAX call for datums";if(0<t.length){for(var r=0;r<t.length;r++){var o=n(_t,t[r]);"Add"===o?(a++,e&&e.onAdd&&e.onAdd(t[r])):"Update"===o&&(i++,e&&e.onUpdate&&e.onUpdate(t[r]))}if(0<a||0<i)try{_t.sort(function(t,e){function a(t){return"SYNONYM"===t?1:"MRE"==t?2:"HELMERT"==t?3:"MOLODENSKY"==t?4:5}return t.fromDatumCD!==e.fromDatumCD?MARCONI.stdlib.strcmp(t.fromDatumCD,e.fromDatumCD):t.toDatumCD!==e.toDatumCD?MARCONI.stdlib.strcmp(t.toDatumCD,e.toDatumCD):a(t.datumShiftMethodCD)-a(e.datumShiftMethodCD)})}catch(t){MARCONI.stdlib.log("Error sorting datum shifts: "+t)}MARCONI.map.getCanonicalDatumSet(!0)}e&&e.onComplete&&e.onComplete("Added "+a+" datum shifts, updated "+i)}catch(t){alert("Error updating datum shift list with AJAX data, error is "+t)}}function n(t,e){try{var a=e.fromDatumCD;if(!a)throw"Got bad data in place of a datum shift: "+MARCONI.stdlib.logObject(e);for(var i=!1,r=null,o="",n=0;n<t.length;n++)if(t[n].fromDatumCD===e.fromDatumCD&&t[n].toDatumCD===e.toDatumCD&&t[n].datumShiftMethodCD===e.datumShiftMethodCD&&(!t[n].datumShiftName||t[n].datumShiftName===e.datumShiftName)){i=!0,r=n;break}if(i)for(var s in e)t[r][s]&&t[r][s]===e[s]||(o="Update");else t.push(e),r=t.length-1,MARCONI.stdlib.log("adding new datum shift from "+a+" to "+e.toDatumCD+", method "+e.datumShiftMethodCD+", count of datum shifts is now "+t.length),o="Add";return t[r]=e,o}catch(t){throw"Error updating datum shift "+MARCONI.stdlib.logObject(e)+": "+t}}},getPointShifted:function(t,e,a,i,r){try{var o=MARCONI.map.mapUnitGivenCode(r||"m");if(!o)throw"Could not resolve units code "+r;if(!o.metersPerUnit)throw"Meters per unit unknown for unit "+r;var n=parseFloat(t)*MARCONI.map.DEGREES_TO_RADIANS,s=180/(MARCONI.map.RADIUS_WGS84_METERS*Math.PI),l=s/Math.cos(n),c=i*o.metersPerUnit*s,u=a*o.metersPerUnit*l;return new MARCONI.map.GeoPoint(parseFloat(e)+u,parseFloat(t)+c)}catch(t){throw"Error shifting point: "+t}},updateMapUnitList:function(t){try{var e;t?(e=MARCONI.stdlib.clone(t)).onComplete=t.onComplete:e={};var i=void 0===e.activeOnly?"&IsActive=true":"&IsActive="+e.activeOnly;if(window.YAHOO&&YAHOO.util.Storage&&(!e||!e.noReadStorage&&!e.noStorage)){try{if(Bt("mapunit",i,function(t,e){o(t,e)},function(t,e){MARCONI.stdlib.log(t+", mapunit list not found in storage, calling again with noReadStorage option"),e.noReadStorage=!0,MARCONI.map.updateMapUnitList(e)},e))return}catch(t){return MARCONI.stdlib.log("Exception reading map units from DOM storage: "+t+", calling again with noReadStorage option"),e||(e={}),e.noReadStorage=!0,void MARCONI.map.updateMapUnitList(e)}MARCONI.stdlib.log("mapunit, "+i+" data not available in DOM storage cache, fetching list with AJAX call")}var a=new YAHOO.util.DataSource("../ajax/Lookup?entity=mapunit");a.responseType=YAHOO.util.DataSource.TYPE_JSON,a.responseSchema={resultsList:"data.Results",fields:["mapUnitCD","unitName","description","isActive","isLinear","isAreal","metersPerUnit","collatingValue"]},a.maxCacheEntries=2;var r={success:function(t,e,a){a&&a.noStorage||Vt("mapunit",i,e.results),o(e.results,a),kt("AJAX fetch of mapunit list")},failure:function(t,e,a){throw"Failed to get list of mapping units, response was "+MARCONI.stdlib.logObject(e,"response")},scope:this,argument:e};a.doBeforeParseData=function(t,e){return void 0===e.data&&(e.replyCode?MARCONI.stdlib.log("error "+e.replyCode+": "+MARCONI.stdlib.friendlyErrorMessage(e.replyText)):MARCONI.stdlib.log("Unknown error getting list of mapping units")),e},a.sendRequest(i,r),Ft()}catch(t){throw"map.js: error launching AJAX request for update of map units: "+t}function o(t,e){try{if(!e)throw"Missing required args parameter to function _updateMapUnits in map.js";var a=0,i=0;if(!t)throw"No data received from AJAX call for map units";if(0<t.length){for(var r=0;r<t.length;r++){var o=n(xt,t[r]);"Add"==o?(a++,e.onAdd&&e.onAdd(t[r])):"Update"==o&&(i++,e.onUpdate&&e.onUpdate(t[r]))}if(0<a||0<i)try{xt.sort(function(t,e){return void 0===t.collatingValue||void 0===e.collatingValue||t.collatingValue==e.collatingValue?MARCONI.stdlib.strcmp(t.mapUnitName,e.mapUnitName):t.collatingValue-e.collatingValue})}catch(t){MARCONI.stdlib.log("Error sorting map unit list: "+t)}}e.onComplete&&e.onComplete("Added "+a+" map units, updated "+i)}catch(t){alert("Error updating map unit list with AJAX data, error is "+t)}}function n(t,e){try{var a=e.mapUnitCD;if(!a)throw"Got bad data in place of a map unit: "+MARCONI.stdlib.logObject(e);for(var i=!1,r=null,o="",n=0;n<t.length;n++)if(t[n].mapUnitCD==a){i=!0,r=n;break}if(i)for(var s in t[r])t[r][s]!=e[s]&&(o="Update");else t.push({mapUnitCD:a}),r=t.length-1,o="Add";return t[r]=e,o}catch(t){throw"Error updating map unit "+MARCONI.stdlib.logObject(e)+": "+t}}}}}(),MARCONI.map.GeoPoint=function(t,e){this.x=t,this.y=e},MARCONI.map.GeoPoint.prototype.setMapGridValue=function(t){this.mapGridValue=t},MARCONI.map.SpatialReference=function(t,e,a){var i=null;if(t&&e&&a&&(i=MARCONI.map.spatialRefInfoLookup(t,e,a)),i){for(var r in i)i.hasOwnProperty(r)&&(this[r]=i[r]);return this.eSquared||(this.eSquared=this.eccentricity*this.eccentricity),void(this.mapUnitCD==MARCONI.map.UNITS_SURVEYFEET?this.equitorialAxis=this.equitorialAxisMeters*MARCONI.map.METERS_TO_SURVEY_FEET:this.mapUnitCD==MARCONI.map.UNITS_INTERNATIONALFEET?this.equitorialAxis=this.equitorialAxisMeters*MARCONI.map.METERS_TO_INTERNATIONAL_FEET:this.equitorialAxis=this.equitorialAxisMeters)}if(t==MARCONI.map.COORDSYS_LAMBERTCUSTOM)this.coordSysTypeCD=MARCONI.map.COORDSYS_TYPE_LAMBERT,this.coordSysCD=t,this.datumCD=e,this.mapUnitCD=a;else{if(t!=MARCONI.map.COORDSYS_TMCUSTOM)throw"Cannot construct SpatialReference object that has coord sys "+t+" with datum "+e+" and units "+a;this.coordSysTypeCD=MARCONI.map.COORDSYS_TYPE_TM,this.coordSysCD=t,this.datumCD=e,this.mapUnitCD=a}if(this.equitorialAxisMeters=0,this.equitorialAxis=0,this.eSquared=0,this.parallel_one=0,this.parallelTwo=0,this.originLatitude=0,this.originLongitude=0,this.originX=0,this.originY=0,this.centralScaleFactor=1,e==MARCONI.map.DATUM_HORIZ_1927)this.equitorialAxisMeters=MARCONI.map.RADIUS_CLARKE1866_METERS,this.eSquared=MARCONI.map.eSquared_CLARKE1866;else if(e==MARCONI.map.DATUM_HORIZ_1983)this.equitorialAxisMeters=MARCONI.map.RADIUS_GRS80_METERS,this.eSquared=MARCONI.map.eSquared_GRS80;else{if(e!=MARCONI.map.DATUM_HORIZ_WGS84)throw"Datum "+e+" not recognized, must be "+MARCONI.map.DATUM_HORIZ_1927+" for NAD27 or "+MARCONI.map.DATUM_HORIZ_1983+" for NAD83";this.equitorialAxisMeters=MARCONI.map.RADIUS_WGS84_METERS,this.eSquared=MARCONI.map.eSquared_WGS84}if(a==MARCONI.map.UNITS_SURVEYFEET)this.equitorialAxis=this.equitorialAxisMeters*MARCONI.map.METERS_TO_SURVEY_FEET;else if(a==MARCONI.map.UNITS_METERS)this.equitorialAxis=this.equitorialAxisMeters;else if(this.mapUnitCD==MARCONI.map.UNITS_INTERNATIONALFEET)this.equitorialAxis=this.equitorialAxisMeters*MARCONI.map.METERS_TO_INTERNATIONAL_FEET;else if(a!=MARCONI.map.UNITS_DEGREES)throw"Units not supported, must be "+UNITS_SURVEYFEET+" for survey feet, "+MARCONI.map.UNITS_INTERNATIONALFEET+" for int. feet, "+MARCONI.map.UNITS_METERS+" for meters, or "+MARCONI.map.UNITS_DEGREES+" for degrees."},MARCONI.map.SpatialReference.prototype.toString=function(){return"Coord sys "+this.coordSysCD+" of type "+this.coordSysTypeCD+", datum "+this.datumCD+", units "+this.mapUnitCD},MARCONI.map.SpatialReference.prototype.setCustomParams=function(t,e,a,i,r,o,n){void 0!==t&&(this.parallel_one=t),void 0!==e&&(this.parallelTwo=e),void 0!==a&&(this.originLatitude=a),void 0!==i&&(this.originLongitude=i),void 0!==r&&(this.originX=r),void 0!==o&&(this.originY=o),void 0!==n&&(this.centralScaleFactor=n)},MARCONI.map.GeoPoint.prototype.toString=function(){return"x="+this.x+", y="+this.y},MARCONI.map.GeoPoint.prototype.setUTMzoneStyle=function(t){this.utmZoneStyle=t},MARCONI.map.GeoPoint.prototype.getUTMzoneStyle=function(){return this.utmZoneStyle||"Letter"},MARCONI.map.GeoPoint.prototype.convert=function(t,e,a,i){var L=this;function r(t,e){try{var a,i,r,o=L.y,n=L.x,s=MARCONI.map.getUTMZoneFromLatLong(o,n),l=h(o,n);if(0<="ABYZ".indexOf(l))i=a=2e6,r=.994,function(t,e,a,i,r){try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal lat-long "+L.y+", "+L.x+", must be numeric";var o=0<L.y?90:-90;S(t,e,o,0,a,i,r)}catch(t){throw"Polar_LatLongToCartesian(): Error converting lat-long to polar coordinates: "+t}}(MARCONI.map.RADIUS_GRS80_METERS,MARCONI.map.eSquared_GRS80,a,i,r),L.x=function(t,e,a,i,r){var o="A"==a||"B"==a?"S":"N",n="N"==o?"RSTUXYZABCFGHJ":"KLPQRSTUXYZABCFGHJKLPQ",s="N"==o?"ABCDEFGHJKLMNP":"BCDEFGHJKLMNPQRSTUVWXY",l=Math.floor((t-2e6)/1e5),c=Math.floor((e-2e6)/1e5);t%=1e5,e%=1e5;var u=n.charAt(l+n.indexOf("A")),d=s.charAt(c+s.indexOf("N"==o?"H":"N"));{if(i)return a+u+d+MARCONI.stdlib.padLeft(Math.round(t),5)+MARCONI.stdlib.padLeft(Math.round(e),5);var h=g(t,r),p=g(e,r);return a+" "+u+d+" "+h+" "+p}}(L.x,L.y,l,t,e),L.y="";else{var c=6*(s-1)-180+3;a=5e5,i=l<"N"?1e7:0,r=.9996,R(MARCONI.map.RADIUS_GRS80_METERS,MARCONI.map.eSquared_GRS80,0,c,a,i,r);var u=L.x,d=L.y;L.x=function(t,e,a,i,r,o){void 0===r&&(r=!1);var n=Math.floor(t/1e5)-1,s=Math.floor(e/1e5);t%=1e5,e%=1e5,n%=8,s%=20;var l,c,u=MARCONI.map.getUSNGZoneSet(a);l=u%2!=0?"ABCDEFGHJKLMNPQRSTUV".charAt(s):"FGHJKLMNPQRSTUVABCDE".charAt(s);c=1==u||4==u?"ABCDEFGH".charAt(n):2==u||5==u?"JKLMNPQR".charAt(n):"STUVWXYZ".charAt(n);{if(r)return a+i+c+l+MARCONI.stdlib.padLeft(Math.floor(t),5)+MARCONI.stdlib.padLeft(Math.floor(e),5);var d=g(t,o),h=g(e,o);return a+i+" "+c+l+" "+d+" "+h}}(u,d,s,l,t,e),L.y=""}return L.x}catch(t){throw"Error computing USNG from lat-long: "+t}}function O(e){try{var t=5-e.length,a=(e?parseFloat(e):0)+.5;return a*=Math.pow(10,t)}catch(t){throw"Error parsing grid number "+e+": "+t}}function g(t,e){return 5==(e=e||5)?MARCONI.stdlib.padLeft(Math.floor(t),e):(t=Math.floor(t*Math.pow(10,5-e))/Math.pow(10,5-e),e<5?(""+t).substr(0,e):MARCONI.stdlib.fixedFormatNumber(t,1,e-5))}function h(e,t){try{var a;if(-80<=e&&e<=84){var i="CDEFGHJKLMNPQRSTUVWX",r=80<=e?i.length-1:Math.floor((e+80)/8);a=i.charAt(r)}else{if(null==t)throw"Longitude must be supplied to get zone letter in polar regions";a=e<-80?t<=0?"A":"B":t<=0?"Y":"Z"}return a}catch(t){throw"getZoneLetter(): cannot get zone letter from latitude "+e+": "+t}}function d(t,e,a,i,r,o,n,s){function l(t,e,a){var i=Math.sin(t);return(1-a)*Math.abs(i/(1-a*i*i)-1/(2*e)*Math.log((1-e*i)/(1+e*i)))}try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal lat-long "+L.y+", "+L.x+", must be numeric";if(90<Math.abs(L.y))throw"Latitude of "+L.y+" is illegal, domain is +/- 90";if(180<Math.abs(L.x))throw"Longitude of "+L.x+" is illegal, domain is +/- 180";a*=MARCONI.map.DEGREES_TO_RADIANS,i*=MARCONI.map.DEGREES_TO_RADIANS,r*=MARCONI.map.DEGREES_TO_RADIANS,o*=MARCONI.map.DEGREES_TO_RADIANS;var c=L.y*MARCONI.map.DEGREES_TO_RADIANS,u=L.x*MARCONI.map.DEGREES_TO_RADIANS,d=Math.sqrt(e),h=D(a,e),p=D(i,e),g=l(r,d,e),f=l(a,d,e),m=l(i,d,e),M=l(c,d,e),A=(h*h-p*p)/(m-f),S=h*h+A*f,C=t*Math.sqrt(S-A*M)/A,R=t*Math.sqrt(S-A*g)/A,N=A*(u-o);return L.x=n+C*Math.sin(N),L.y=s+R-C*Math.cos(N),!0}catch(t){throw"Error converting from lat-long to Albers: "+t}}function f(t,e,a,i,r,o,n,s){function l(t,e,a){var i=Math.sin(t);return(1-a)*(i/(1-a*i*i)-1/(2*e)*Math.log((1-e*i)/(1+e*i)))}try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal x,y of "+L.x+", "+L.y+", must be numeric";a*=MARCONI.map.DEGREES_TO_RADIANS,i*=MARCONI.map.DEGREES_TO_RADIANS,r*=MARCONI.map.DEGREES_TO_RADIANS,o*=MARCONI.map.DEGREES_TO_RADIANS;var c=L.x-n,u=L.y-s,d=Math.sqrt(e),h=D(a,e),p=D(i,e),g=l(r,d,e),f=l(a,d,e),m=(h*h-p*p)/(l(i,d,e)-f),M=h*h+m*f,A=t*Math.sqrt(M-m*g)/m,S=Math.sqrt(c*c+(A-u)*(A-u)),C=(M-S*S*m*m/(t*t))/m,R=e*e,N=R*e,y=Math.asin(C/Math.abs(1-(1-e)/(2*d)*Math.log((1-d)/(1+d)))),O=y+(e/3+31*R/180+517*N/5040)*Math.sin(2*y)+(23*R/360+251*N/3780)*Math.sin(4*y)+761*N/45360*Math.sin(4*y),v=0<m?Math.atan2(c,A-u):Math.atan2(-c,u-A);return L.y=O*MARCONI.map.RADIANS_TO_DEGREES,L.x=(v/m+o)*MARCONI.map.RADIANS_TO_DEGREES,!0}catch(t){throw"Error converting from Albers to lat-long: "+t}}function p(t,e,a,i,r,o,n,s){try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal lat-long "+L.y+", "+L.x+", must be numeric";if(90<Math.abs(L.y))throw"Latitude of "+L.y+" is illegal, domain is +/- 90";if(180<Math.abs(L.x))throw"Longitude of "+L.x+" is illegal, domain is +/- 180";a*=MARCONI.map.DEGREES_TO_RADIANS,i*=MARCONI.map.DEGREES_TO_RADIANS,r*=MARCONI.map.DEGREES_TO_RADIANS,o*=MARCONI.map.DEGREES_TO_RADIANS;var l=L.y*MARCONI.map.DEGREES_TO_RADIANS,c=L.x*MARCONI.map.DEGREES_TO_RADIANS,u=Math.sqrt(e),d=D(a,e),h=D(i,e),p=(D(l,e),w(a,u)),g=w(i,u),f=w(r,u),m=w(l,u),M=(Math.log(d)-Math.log(h))/(Math.log(p)-Math.log(g)),A=d/(M*Math.pow(p,M)),S=t*A*Math.pow(f,M),C=t*A*Math.pow(m,M),R=M*(c-o);return L.x=n+C*Math.sin(R),L.y=s+S-C*Math.cos(R),!0}catch(t){throw"Error converting from lat-long to Lambert: "+t}}function m(t,e,a,i,r,o,n,s){try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal x,y of "+L.x+", "+L.y+", must be numeric";a*=MARCONI.map.DEGREES_TO_RADIANS,i*=MARCONI.map.DEGREES_TO_RADIANS,r*=MARCONI.map.DEGREES_TO_RADIANS,o*=MARCONI.map.DEGREES_TO_RADIANS;var l=parseFloat(L.x)-n,c=parseFloat(L.y)-s,u=Math.sqrt(e),d=D(a,e),h=D(i,e),p=w(r,u),g=w(a,u),f=w(i,u),m=(Math.log(d)-Math.log(h))/(Math.log(g)-Math.log(f)),M=d/(m*Math.pow(g,m)),A=t*M*Math.pow(p,m);m<0&&(l=-l,c=-c,A=-A);var S=Math.sqrt(l*l+(A-c)*(A-c));S=0<m?Math.abs(S):-Math.abs(S);var C=Math.pow(S/(t*M),1/m),R=.5*Math.PI-2*Math.atan(C),N=R;N+=Math.sin(2*R)*(.5*e+5*e*e/24+Math.pow(e,3)/12+13/360*Math.pow(e,4)),N+=Math.sin(4*R)*(e*e*7/48+29*Math.pow(e,3)/240+811/11520*Math.pow(e,4)),N+=Math.sin(6*R)*(7*Math.pow(e,3)/120+81/1120*Math.pow(e,4)),N+=Math.sin(8*R)*(4279/161280*Math.pow(e,4)),L.y=N*MARCONI.map.RADIANS_TO_DEGREES;var y=Math.atan(l/(A-c));L.x=(y/m+o)*MARCONI.map.RADIANS_TO_DEGREES;var O=D(N,e);Math.pow(C,m),Math.pow(g,m);return!0}catch(t){throw"Error converting from Lambert to lat-long: "+t}}function M(t,e,a,i){try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal x,y of "+L.x+", "+L.y+", must be numeric";var r=L.x-a,o=L.y-i,n=Math.exp(-o/t),s=.5*Math.PI-2*Math.atan(n),l=e*e,c=l*e,u=l*l,d=s+(.5*e+5*l/24+c/12+13*u/360)*Math.sin(2*s)+(7*l/48.8+29*c/240+811*u/11520)*Math.sin(4*s)+(7*c/120+81*u/1120)*Math.sin(6*s)+4279*u/161280*Math.sin(8*s),h=r/t+0;return L.y=d*MARCONI.map.RADIANS_TO_DEGREES,L.x=h*MARCONI.map.RADIANS_TO_DEGREES,!0}catch(t){throw"Error converting from Mercator to lat-long: "+t}}function A(t,e,a,i){try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal lat-long "+L.y+", "+L.x+", must be numeric";MARCONI.stdlib.log("Converting "+L.y+", "+L.x+" to mercator with origin "+a+", "+i);var r=(L.x-0)*MARCONI.map.DEGREES_TO_RADIANS*t-a,o=Math.sqrt(e),n=Math.sin(L.y*MARCONI.map.DEGREES_TO_RADIANS),s=.5*t*Math.log((1+n)/(1-n)*Math.pow((1-o*n)/(1+o*n),o))-i;return L.y=s,L.x=r,!0}catch(t){throw"Error converting from lat-long to Mercator: "+t}}function S(t,e,a,i,r,o,n){try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal lat-long "+L.y+", "+L.x+", must be numeric";var s=Math.abs(Math.abs(a)-90)<.001,l=Math.sqrt(e);a*=MARCONI.map.DEGREES_TO_RADIANS,i*=MARCONI.map.DEGREES_TO_RADIANS;var c,u,d=L.y*MARCONI.map.DEGREES_TO_RADIANS,h=L.x*MARCONI.map.DEGREES_TO_RADIANS;if(s){d=Math.abs(d);var p=Math.pow((1+l*Math.sin(d))/(1-l*Math.sin(d)),.5*l)*Math.tan(Math.PI/4-d/2),g=n*(2*t/Math.sqrt(1-e)*Math.pow((1-l)/(1+l),.5*l))*p;c=r+g*Math.sin(h),u=0<a?o-g*Math.cos(h):o+g*Math.cos(h)}else{var f=2*Math.atan(Math.tan(Math.PI/4+.5*a)*Math.pow((1-l*Math.sin(a))/(1+l*Math.sin(a)),.5*l))-.5*Math.PI,m=Math.cos(a)/Math.sqrt(1-e*Math.pow(Math.sin(a),2)),M=2*Math.atan(Math.tan(Math.PI/4+.5*d)*Math.pow((1-l*Math.sin(d))/(1+l*Math.sin(d)),.5*l))-.5*Math.PI,A=2*t*n*m/(Math.cos(f)*(1+Math.sin(f)*Math.sin(M)+Math.cos(f)*Math.cos(M)*Math.cos(h-i)));c=r+A*Math.cos(M)*Math.sin(h-i),u=o+A*(Math.cos(f)*Math.sin(M)-Math.sin(f)*Math.cos(M)*Math.cos(h-i))}L.x=c,L.y=u}catch(t){throw"Error converting from lat-long to stereographic: "+t}}function v(t,e,a,i,r,o,n){try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal lat-long "+L.y+", "+L.x+", must be numeric";var s=Math.abs(Math.abs(a)-90)<.001,l=Math.sqrt(e);a*=MARCONI.map.DEGREES_TO_RADIANS,i*=MARCONI.map.DEGREES_TO_RADIANS;var c,u,d=L.x-r,h=L.y-o,p=e*e,g=e*p,f=p*p,m=.5*e+5*p/24+g/12+13*f/360,M=7*p/48+29*g/240+811*f/11520,A=7*g/120+81*f/1120,S=4279*f/161280,C=i;if(s)if(Math.abs(d)<.001&&Math.abs(h)<.001)c=Math.PI/2;else{C+=0<a?Math.atan2(d,-h):Math.atan2(d,h);var R=Math.abs(d/Math.sin(C)),N=2*t/Math.sqrt(1-e)*Math.pow((1-l)/(1+l),.5*l),y=2*Math.atan2(R,n*N);c=(u=Math.PI/2-y)+m*Math.sin(2*u)+M*Math.sin(4*u)+A*Math.sin(6*u)+S*Math.sin(8*u),a<0&&(c*=-1)}else{var O=2*Math.atan(Math.tan(Math.PI/4+.5*a)*Math.pow((1-l*Math.sin(a))/(1+l*Math.sin(a)),.5*l))-.5*Math.PI,v=Math.sqrt(d*d+h*h),I=Math.cos(a)/Math.sqrt(1-e*Math.pow(Math.sin(a),2)),D=2*Math.atan(v*Math.cos(O)/(2*t*n*I));Math.abs(v)<.001?u=O:(u=Math.asin(Math.cos(D)*Math.sin(O)+h*Math.sin(D)*Math.cos(O)/v),C+=Math.atan2(d*Math.sin(D),v*Math.cos(O)*Math.cos(D)-h*Math.sin(O)*Math.sin(D))),c=u+m*Math.sin(2*u)+M*Math.sin(4*u)+A*Math.sin(6*u)+S*Math.sin(8*u)}var w=c*MARCONI.map.RADIANS_TO_DEGREES,E=C*MARCONI.map.RADIANS_TO_DEGREES;L.x=E,L.y=w}catch(t){throw"Error converting from stereographic cartesian to lat-long: "+t}}function C(t,e){if(!t||!t.fromDatumCD||!t.toDatumCD)throw"datumShift passed to shift_General() was null or invalid";if(!e||void 0===e.x||void 0===e.y)throw"point argument passed to shift_General() was null or invalid";if("MRE"==t.datumShiftMethodCD)!function(t,e){try{var a=t.scaleFactor*(e.y-t.shiftY),i=t.scaleFactor*(e.x-t.shiftX),r=null,o=null,n=0;if(t.latitudeCoefficients)for(o=0;o<t.latitudeCoefficients.length;o++)n+=(r=t.latitudeCoefficients[o]).value*Math.pow(a,r.expLat)*Math.pow(i,r.expLong);var s=0;if(t.longitudeCoefficients)for(o=0;o<t.longitudeCoefficients.length;o++)s+=(r=t.longitudeCoefficients[o]).value*Math.pow(a,1*r.expLat)*Math.pow(i,1*r.expLong);e.x+=s/3600,e.y+=n/3600}catch(t){throw"Error "+t+" attempting datum-shift using Multiple Regression Equation"}}(t,e);else if("MOLODENSKY"==t.datumShiftMethodCD)!function(t,e){try{if(void 0===t.shiftX||"null"==typeof t.shiftX)throw"shiftX must be defined for Molodensky transform";if(void 0===t.shiftY||"null"==typeof t.shiftY)throw"shiftY must be defined for Molodensky transform";if(void 0===t.shiftZ||"null"==typeof t.shiftZ)throw"shiftZ must be defined for Molodensky transform";var a=MARCONI.map.datumGivenCode(t.fromDatumCD),i=MARCONI.map.datumGivenCode(t.toDatumCD);if(void 0===a.flatteningInverse&&0<a.eccentricity)throw"flattening inverse for datum "+t.fromDatumCD+" must be defined unless ellipsoid is a perfect sphere";if(void 0===i.flatteningInverse&&0<i.eccentricity)throw"flattening inverse for datum "+t.toDatumCD+" must be defined unless ellipsoid is a perfect sphere";var r=a.flatteningInverse?1/a.flatteningInverse:0,o=i.flatteningInverse?1/i.flatteningInverse:0,n=Math.sin(e.y*MARCONI.map.DEGREES_TO_RADIANS),s=Math.cos(e.y*MARCONI.map.DEGREES_TO_RADIANS),l=Math.cos(e.x*MARCONI.map.DEGREES_TO_RADIANS),c=Math.sin(e.x*MARCONI.map.DEGREES_TO_RADIANS),u=a.equitorialAxisMeters,d=a.polarAxisMeters?a.polarAxisMeters:u*(1-r),h=i.equitorialAxisMeters-a.equitorialAxisMeters,p=null!==a.eccentricitySquared?a.eccentricitySquared:a.eccentricity*a.eccentricity,g=u/Math.sqrt(1-p*n*n),f=u*(1-p)/Math.pow(1-p*n*n,1.5),m=e.z?e.z:0,M=Math.sin(1/3600*MARCONI.map.DEGREES_TO_RADIANS),A=o-r,S=(-1*t.shiftX*n*l-t.shiftY*n*c+t.shiftZ*s+h*(g*p*n*s)/u+A*(f*u/d+g*d/u)*n*s)/((f+m)*M),C=(-t.shiftX*c+t.shiftY*l)/((g+m)*s*M);e.x+=C/3600,e.y+=S/3600}catch(t){throw"Error "+t+" attempting datum-shift using Molodensky transformation matrix method"}}(t,e);else{if("HELMERT"!=t.datumShiftMethodCD)throw t.datumShiftMethodCD+" method is not supported";!function(t,e){try{if(void 0===t.shiftX||"null"==typeof t.shiftX)throw"shiftX must be defined for Helmert transform";if(void 0===t.shiftY||"null"==typeof t.shiftY)throw"shiftY must be defined for Helmert transform";if(void 0===t.shiftZ||"null"==typeof t.shiftZ)throw"shiftZ must be defined for Helmert transform";var a=MARCONI.map.datumGivenCode(t.fromDatumCD),i=MARCONI.map.datumGivenCode(t.toDatumCD);if(void 0===a.equitorialAxisMeters||void 0===a.eccentricitySquared)throw"equitorial axis and eccentricitySquared for datum "+t.fromDatumCD+" must be defined for a Helmert shift";if(void 0===i.equitorialAxisMeters||void 0===i.eccentricitySquared)throw"equitorial axis and eccentricitySquared for datum "+t.toDatumCD+" must be defined for a Helmert shift";var r=a.equitorialAxisMeters,o=e.y*MARCONI.map.DEGREES_TO_RADIANS,n=e.x*MARCONI.map.DEGREES_TO_RADIANS,s=a.eccentricitySquared,l=e.z||0,c=t.shiftX,u=t.shiftY,d=t.shiftZ,h=t.rotationX,p=t.rotationY,g=t.rotationZ,f=1e-6*t.scaleFactor,m=r/Math.sqrt(1-s*Math.sin(o)*Math.sin(o)),M=(m+l)*Math.cos(o)*Math.cos(n),A=(m+l)*Math.cos(o)*Math.sin(n),S=((1-s)*m+l)*Math.sin(o),C=h/3600*MARCONI.map.DEGREES_TO_RADIANS,R=p/3600*MARCONI.map.DEGREES_TO_RADIANS,N=g/3600*MARCONI.map.DEGREES_TO_RADIANS,y=M+M*f-A*N+S*R+c,O=M*N+A+A*f-S*C+u,v=-1*M*R+A*C+S+S*f+d,I=Math.atan(O/y),D=Math.sqrt(y*y+O*O),w=Math.atan(v/(D*(1-i.eccentricitySquared)));m=i.equitorialAxisMeters/Math.sqrt(1-i.eccentricitySquared*(Math.sin(w)*Math.sin(w)));for(var E=1,L=0;1e-7<E;)L=Math.atan((v+i.eccentricitySquared*m*Math.sin(w))/D),E=Math.abs(L-w),w=L;e.y=w*MARCONI.map.RADIANS_TO_DEGREES,e.x=I*MARCONI.map.RADIANS_TO_DEGREES}catch(t){throw"Error "+t+" attempting datum-shift using Helmert transformation matrix method"}}(t,e)}}function I(t,e,a,i,r,o,n){try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal x,y of "+L.x+", "+L.y+", must be numeric";n||(n=.9996),a*=MARCONI.map.DEGREES_TO_RADIANS,i*=MARCONI.map.DEGREES_TO_RADIANS;var s=e/(1-e),l=(MARCONI.map.trueDistanceAlongCentralMeridian(t,e,a)+(parseFloat(L.y)-o)/n)/(t*(1-e/4-3*e*e/64-5*e*e*e/256)),c=(1-Math.sqrt(1-e))/(1+Math.sqrt(1-e)),u=l+(1.5*c-27*Math.pow(c,3)/32)*Math.sin(2*l)+(21*c*c/16-55*Math.pow(c,4)/32)*Math.sin(4*l)+151*Math.pow(c,3)/96*Math.sin(6*l)+1097*Math.pow(c,4)/512*Math.sin(8*l),d=s*Math.pow(Math.cos(u),2),h=Math.pow(Math.tan(u),2),p=t/Math.sqrt(1-e*Math.pow(Math.sin(u),2)),g=t*(1-e)/Math.pow(1-e*Math.pow(Math.sin(u),2),1.5),f=(parseFloat(L.x)-r)/(p*n),m=(u-p*Math.tan(u)/g*(f*f/2-(5+3*h+10*d-4*d*d-9*s)*Math.pow(f,4)/24+(61+90*h+298*d+45*h*h-252*s-3*d*d)*Math.pow(f,6)/720))*MARCONI.map.RADIANS_TO_DEGREES,M=(i+(f-(1+2*h+d)*Math.pow(f,3)/6+(5-2*d+28*h-3*d*d+8*s+24*h*h)*Math.pow(f,5)/120)/Math.cos(u))*MARCONI.map.RADIANS_TO_DEGREES;L.y=m,L.x=M}catch(t){throw"Error converting TM to lat-long: "+t}}function R(t,e,a,i,r,o,n){if(isNaN(L.x)||isNaN(L.y))throw"Illegal lat-long "+L.y+", "+L.x+", must be numeric";if(90<Math.abs(L.y))throw"TM_LatLongToCartesian(): Latitude of "+L.y+" is illegal";if(180<Math.abs(L.x))throw"TM_LatLongToCartesian(): Longitude of "+L.x+" is illegal";var s=L.y*MARCONI.map.DEGREES_TO_RADIANS,l=L.x*MARCONI.map.DEGREES_TO_RADIANS,c=e/(1-e),u=t/Math.sqrt(1-e*Math.pow(Math.sin(s),2)),d=Math.pow(Math.tan(s),2),h=c*Math.pow(Math.cos(s),2),p=(l-MARCONI.map.DEGREES_TO_RADIANS*i)*Math.cos(s),g=MARCONI.map.trueDistanceAlongCentralMeridian(t,e,s),f=MARCONI.map.trueDistanceAlongCentralMeridian(t,e,a*MARCONI.map.DEGREES_TO_RADIANS);L.x=n*u*(p+(1-d+h)*Math.pow(p,3)/6+(5-18*d+d*d+72*h-58*c)*Math.pow(p,5)/120)+r,L.y=n*(g-f+u*Math.tan(s)*(p*p/2+(5-d+9*h+4*h*h)*Math.pow(p,4)/24+(61-58*d+d*d+600*h-330*c)*Math.pow(p,6)/720))+o}function D(t,e){return Math.cos(t)/Math.sqrt(1-e*Math.pow(Math.sin(t),2))}function w(t,e){return Math.tan(Math.PI/4-.5*t)/Math.pow((1-e*Math.sin(t))/(1+e*Math.sin(t)),.5*e)}try{switch(t.coordSysTypeCD){case MARCONI.map.COORDSYS_TYPE_LAMBERT:m(t.equitorialAxis,t.eSquared,t.parallelOne,t.parallelTwo,t.originLatitude,t.originLongitude,t.originX,t.originY);break;case MARCONI.map.COORDSYS_TYPE_TM:I(t.equitorialAxis,t.eSquared,t.originLatitude,t.originLongitude,t.originX,t.originY,t.centralScaleFactor);break;case MARCONI.map.COORDSYS_TYPE_ALBERS:f(t.equitorialAxis,t.eSquared,t.parallelOne,t.parallelTwo,t.originLatitude,t.originLongitude,t.originX,t.originY);break;case MARCONI.map.COORDSYS_TYPE_GRID:!function(t){var e=L.mapGridValue?L.mapGridValue:L.x;if(!e)throw"call setMapGridValue or set x before calling convert()";if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_USNG||t.spatialReferenceCD==MARCONI.map.SPATIALREF_MGRS)!function(t,e){try{var a=MARCONI.map.parseUSNGGridRef(e);if(!a)throw e+" is not a valid USNG value";var i,r,o=a[0],n=a[1],s=!a[0],l=a[2],c=a[3],u=a[4],d=l.substr(0,1),h=l.substr(1,1);if(s){var p="A"==n||"B"==n?"S":"N",g="N"==p?"RSTUXYZABCFGHJ":"KLPQRSTUXYZABCFGHJKLPQ",f="N"==p?"ABCDEFGHJKLMNP":"BCDEFGHJKLMNPQRSTUVWXY";if(g.indexOf(d)<0)throw"Illegal grid letter "+d;if(f.indexOf(h)<0)throw"Illegal grid letter "+h;i=g.indexOf(d)-g.indexOf("A"),r=f.indexOf(h)-f.indexOf("N"==p?"H":"N"),t.originX=2e6,t.originY=2e6,t.centralScaleFactor=.994;var m=1e5*i+O(c)+2e6,M=1e5*r+O(u)+2e6;L.x=m,L.y=M,function(t,e,a,i,r,o){try{if(isNaN(L.x)||isNaN(L.y))throw"Illegal lat-long "+L.y+", "+L.x+", must be numeric";if("N"!=o&&"S"!=o)throw"Must provide hemisphere as N or S";var n="N"==o?90:-90;r||(r=.994),v(t,e,n,0,a,i,r)}catch(t){throw"Error converting polar coordinates to lat-long: "+t}}(t.equitorialAxisMeters,t.eSquared,t.originX,t.originY,t.centralScaleFactor,p)}else{if(1!=n.length||"CDEFGHJKLMNPQRSTUVWX".indexOf(n)<0)throw"Grid value "+e+" is not a valid grid reference, UTM latitude bands run from C to X";r=o%2?"ABCDEFGHJKLMNPQRSTRUV".indexOf(h):"FGHJKLMNPQRSTUVABCDE".indexOf(h);var A="CDEFGHJKLMNPQRSTUVWX".indexOf(n),S=[1.1,2,2.9,3.8,4.7,5.6,6.5,7.3,8.2,9.1,0,.8,1.7,2.6,3.5,4.4,5.3,6.2,7,7.9][A],C=[0,2,2,2,4,4,6,6,8,8,0,0,0,2,2,4,4,6,6,6][A]+r/10;C<S&&(C+=2);var R=1e6*C+O(u);t.originY=n<"N"?1e7:0,t.originX=5e5;var N=1e5*(1+(i="ABCDEFGHJKLMNPQRSTUVWXYZ".indexOf(d))%8),y=N+O(c);if(L.x=y,L.y=R,t.originLongitude=6*(o-1)-180+3,t.originLatitude=0,t.centralScaleFactor=.9996,isNaN(t.originLongitude))throw"origin of UTM zone could not be determined from zone "+o;I(t.equitorialAxisMeters,t.eSquared,t.originLatitude,t.originLongitude,t.originX,t.originY,t.centralScaleFactor)}}catch(t){throw"Error "+t+" attempting to convert USNG value "+e+" to lat-long"}}(t,e);else if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_GARS)!function(e){try{var t=0,a=0,i=1/12;if(!e)return;if(e.length<5)throw"GARS code must be at least five characters";var r="ABCDEFGHJKLMNPQRSTUVWXYZ",o=e.substring(0,3),n=e.substring(3,5).toUpperCase();if(a=(parseFloat(o)-1)/2-180,t=.5*(r.indexOf(n.substring(0,1))*r.length+r.indexOf(n.substring(1)))-90,7<=e.length){var s=0,l=0;try{var c,u;if(e.indexOf(" ",5)<0)c=e.substring(5,6),u=e.substring(6);else{var d=e.substring(5).split(" ");c=d[0],u=d[1]}s=parseInt(c,10),l=parseInt(u,10)}catch(t){throw"Error parsing quadrant and keypad as single-digit integers: "+t}1!=s&&2!=s||(t+=.25),2!=s&&4!=s||(a+=.25),l%3==0?a+=2*i:l%3==2&&(a+=i),l<4?t+=2*i:l<7&&(t+=i),a+=.5*i,t+=.5*i}else t+=.25,a+=.25;L.x=a,L.y=t}catch(t){throw"Error "+t.toString()+" attempting to convert GARS value "+e+" to lat-long"}}(e);else if(t.coordSysCD==MARCONI.map.COORDSYS_UTM)!function(t,e){try{var a=MARCONI.map.parseUTMGridRef(e);if(!a)throw e+" is not a valid UTM grid reference. UTM grid refs take the form zza xxxx yyyy where zz is a zone number, a is a letter from C-X, North, or South, and xxxx and yyyy are x and y values in meters";var i=a[0],r=a[1].toUpperCase(),o=parseFloat(a[2].replace(/,/g,"")),n=parseFloat(a[3].replace(/,/g,"")),s=!0;if(1<r.length){if("NORTH"!==r&&"SOUTH"!==r)throw i+r+" is not a valid UTM zone designation.  Zone designation must be either a UTM letter code C-X, or the word North or South spelled out";s=r.startsWith("N")}else s="N"<=r;if(t.originY=s?0:1e7,t.originX=5e5,L.x=o,L.y=n,t.originLongitude=6*(i-1)-180+3,t.originLatitude=0,t.centralScaleFactor=.9996,isNaN(t.originLongitude))throw"origin of UTM zone could not be determined from zone "+i;if(I(t.equitorialAxisMeters,t.eSquared,t.originLatitude,t.originLongitude,t.originX,t.originY,t.centralScaleFactor),isNaN(t.originLongitude))throw"origin of UTM zone could not be determined from zone "+i}catch(t){throw"Error "+t+" attempting to convert UTM value "+e+" to lat-long"}}(t,e);else if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_CAP_CLASSIC)!function(e){try{var t=function(e){try{if("string"!=typeof e||0===e.length)return null;var t=new RegExp("^([a-z,_]{1,7})[\\s]*([0-9]{1,3})[\\s]*([a-z]?)$","i"),a=t.exec(e);if(!a)return null;var i=[];return i.push(a[1].toUpperCase()),i.push(a[2]),i.push(a[3].toUpperCase()),i}catch(t){throw"Error parsing "+e+" as a CAP gridvalue, error is "+t}}(e);if(!t)throw e+" is not a valid CAP gridvalue";for(var a=t[0],i=function(t){var e=MARCONI.map.getCAPClassicGridSections();if(e)for(var a=0;a<e.length;a++)if(e[a].code==t)return e[a];return null}(a),r=t[1],o=t[2],n=(i.widthMinutes,i.heightMinutes,"ALA_"==i.code.substr(0,4)?1:4),s="ALA_"==i.code.substr(0,4)?2:4,l=n*Math.round(i.east-i.west),c=(r-1)%l,u=Math.floor((r-1)/l),d=i.north-(1+u)/s,h=i.west+(1+c)/n,p=0,g=0,f=1/n/2,m=1/s/2,M=0;M<o.length;M++){var A=o.substr(M,1);switch(A){case"A":p+=1.5*f,g+=1.5*m;break;case"B":p+=.5*f,g+=1.5*m;break;case"C":p+=1.5*f,g+=.5*m;break;case"D":p+=.5*f,g+=.5*m;break;default:throw"Unrecognized grid letter "+A}}d+=g,h-=p,L.x=h,L.y=d}catch(t){throw"Error converting CAP gridvalue "+e+" to lat-long: "+t}}(e);else if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_CAP_CELL)!function(e){try{var t=function(t){if("string"!=typeof t||0===t.length)return null;var e=new RegExp("^([\\d]{2})([\\d]{3})[\\s]*([a-z]{0,3})$","i").exec(t);if(!e)return null;var a=[];return a.push(e[1]),a.push(e[2].toUpperCase()),a.push(e[3].toUpperCase()),a}(e);if(!t)throw e+" is not a valid CAP gridvalue";for(var a=.5,i=parseFloat(t[0])+a,r=-1*parseFloat(t[1])-a,o=t[2],n=0;n<o.length;n++){var s=o.substr(n,1);r+=("A"==s||"C"==s?-.5:.5)*a,i+=("C"==s||"D"==s?-.5:.5)*a,a*=.5}L.x=r,L.y=i}catch(t){throw"Error converting CAP cell-style gridvalue "+e+" to lat-long: "+t}}(e);else if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_OSGB)!function(t,e){try{if(!e)return;var a=function(e){try{if("string"!=typeof e||0===e.length)return null;var t=new RegExp("^([a-z]{0,2})[\\s]*([0-9]*)[\\s,]*([0-9]*)$","i"),a=t.exec(e);if(!a)return null;var i=a[1].toUpperCase(),r=a[2],o=a[3];if(i&&!o.length&&""!==r&&r.length){if(r.length%2!=0)return null;o=r.substr(r.length/2),r=r.substr(0,r.length/2)}var n={letters:i,x:""===r?0:parseInt(r,10),y:""===o?0:parseInt(o,10),precision:i.length?r.length:5};return n}catch(t){throw"Error parsing "+e+" as OSGB gridvalue, error is "+t}}(e);if(!a)throw"Gridvalue "+e+" is not a valid OSGB grid value";var i=function(t){for(var e=0,a=0,i=0;i<t.length;i++){var r=t.substr(i,1),o="ABCDEFGHJKLMNOPQRSTUVWXYZ".indexOf(r);if(o<0)throw"Letter "+r+" is not a valid OSGB grid letter";var n=0==i?5e5:1e5,s=o%5,l=4-Math.floor(o/5);e+=s*n,a+=l*n}return t&&(e-=1e6,a-=5e5),{x:e,y:a}}(a.letters);a.x=a.x*Math.pow(10,5-a.precision),a.y=a.y*Math.pow(10,5-a.precision),a.precision<5&&(a.x+=.5*Math.pow(10,5-a.precision),a.y+=.5*Math.pow(10,5-a.precision));var r=a.x+i.x,o=a.y+i.y,n=t.eSquared||t.eccentricity*t.eccentricity;L.x=r,L.y=o,I(t.equitorialAxisMeters,n,t.originLatitude,t.originLongitude,t.originX,t.originY,t.centralScaleFactor)}catch(t){throw"Error "+t+" attempting to convert OSGB value "+e+" to lat-long"}}(t,e);else if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_IRISH)!function(t,e){try{if(!e)return;var a=function(e){try{if("string"!=typeof e||0===e.length)return null;var t=new RegExp("^([a-z]{0,1})[\\s]*([0-9]*)[\\s,]*([0-9]*)$","i"),a=t.exec(e);if(!a)return null;var i=a[1].toUpperCase(),r=a[2],o=a[3];if(i&&!o.length&&""!==r&&r.length){if(r.length%2!=0)return null;o=r.substr(r.length/2),r=r.substr(0,r.length/2)}var n={letter:i,x:""===r?0:parseInt(r,10),y:""===o?0:parseInt(o,10),precision:i.length?r.length:5};return n}catch(t){throw"Error parsing "+e+" as Irish gridvalue, error is "+t}}(e);if(!a)throw"Gridvalue "+e+" is not a valid Irish grid value";var i=function(t){if(!t)return{x:0,y:0};var e="ABCDEFGHJKLMNOPQRSTUVWXYZ".indexOf(t);if(e<0)throw"Letter "+t+" is not a valid Irish grid letter";var a=e%5,i=4-Math.floor(e/5);return{x:1e5*a,y:1e5*i}}(a.letter);a.x=a.x*Math.pow(10,5-a.precision),a.y=a.y*Math.pow(10,5-a.precision),a.precision<5&&(a.x+=.5*Math.pow(10,5-a.precision),a.y+=.5*Math.pow(10,5-a.precision));var r=a.x+i.x,o=a.y+i.y,n=t.eSquared||t.eccentricity*t.eccentricity;L.x=r,L.y=o,I(t.equitorialAxisMeters,n,t.originLatitude,t.originLongitude,t.originX,t.originY,t.centralScaleFactor)}catch(t){throw"Error "+t+" attempting to convert Irish grid value "+e+" to lat-long"}}(t,e);else{if(t.coordSysTypeCD!=MARCONI.map.COORDSYS_TYPE_GRID||!t.baseCoordSysCD)throw"Unrecognized grid type "+t.spatialReferenceCD;!function(t,e){try{var a=new MARCONI.map.SpatialReference(t.baseCoordSysCD,t.datumCD,t.inputResolutionUnitCD);if(!a)throw"Cannot determine underlying spatial reference for grid reference frame "+t.spatialReferenceCD;var i=function(t){var e=new RegExp("(.*)(\\{.*\\})([^\\d]*)(\\{.*\\})(.*)").exec(t);if(e&&1<e.length){var a=e[1],i=e[2],r=e[3],o=e[4],n=e[5],s="([\\d]*)",l=2<i.length?i.substring(1,i.length-1).split(","):null,c=2<o.length?o.substring(1,o.length-1).split(","):null,u=!0;null!==l&&null!==c&&"1"==l[0]&&(u=!1);var d="("+(0===a.length?"[\\s\\D]*":"[\\s]*"+a+"[\\s]*")+")"+s+"("+(0===r.length?"[\\s\\D]*":"[\\s]*"+r+"[\\s]*")+")"+s+"("+(0===n.length?"[\\s\\D]*":"[\\s]*"+n+"[\\s]*")+")";return{regExPattern:d,isFirstComponentEasting:u}}return null}(t.gridTemplate),r="([\\D]*)([\\d]*)([\\D]*)([\\d]*)([\\D]*)";i&&i.regExPattern&&(r=i.regExPattern);var o=!0;i&&void 0!==i.isFirstComponentEasting&&(o=i.isFirstComponentEasting);var n=new RegExp(r,"i"),s=n.exec(e);if(!s||6!=s.length)throw"Illegal grid value passed, must match regular expression "+r+" which was formulated based on the GridTemplate of "+t.gridTemplate+" associated with the coordinate system in database table coordsys with code "+t.coordSysCD;var l,c,u=o?s[2]:s[4],d=o?s[4]:s[2];try{l=parseInt(u,10),c=parseInt(d,10)}catch(t){throw"Cannot parse grid value "+L.x}var h=t.inputResolution?t.inputResolution:1e3,p=h*l+.5*t.gridCellSizeHorizontal,g=h*c+.5*t.gridCellSizeVertical;switch(L.x=p,L.y=g,a.coordSysTypeCD){case MARCONI.map.COORDSYS_TYPE_LAMBERT:m(a.equitorialAxis,a.eSquared,a.parallelOne,a.parallelTwo,a.originLatitude,a.originLongitude,a.originX,a.originY);break;case MARCONI.map.COORDSYS_TYPE_TM:I(a.equitorialAxis,a.eSquared,a.originLatitude,a.originLongitude,a.originX,a.originY,a.centralScaleFactor);break;case MARCONI.map.COORDSYS_TYPE_ALBERS:f(a.equitorialAxis,a.eSquared,a.parallelOne,a.parallelTwo,a.originLatitude,a.originLongitude,a.originX,a.originY);break;case MARCONI.map.COORDSYS_TYPE_STEREO:v(a.equitorialAxis,a.eSquared,a.originLatitude,a.originLongitude,a.originX,a.originY,a.centralScaleFactor);break;case MARCONI.map.COORDSYS_TYPE_MERCATOR:M(a.equitorialAxis,a.eSquared,a.originX,a.originY);break;default:throw"Stateplane grid does not work with base coordsys of type "+a.coordSysTypeCD}}catch(t){throw"Error "+t+" attempting to convert grid value "+e+" to lat-long"}}(t,e)}}(t);break;case MARCONI.map.COORDSYS_TYPE_ATLAS:!function(t){function e(t,e,a,i,r){var o=null;if(r){var n=r.indexOf(e),s=r.indexOf(t);if(n<0||s<0)throw"Grid-cell designation of "+t+" with base value of "+e+" illegal with given range of grid values "+r;o=Math.abs(s-n)/a}else o=(MARCONI.stdlib.isDigit(e)?(t-e)/a:(t.charCodeAt(0)-e.charCodeAt(0)-(t.toUpperCase()<"J"?0:1))/a)+.5/a;if(o<0||1<o)throw"Grid-cell designation of "+t+" with base value of "+e+" and "+a+" cells results in illegal ratio of "+o+(r?" using possibleGridValues of "+r:"");return i||(o=1-o),o}try{var a=MARCONI.map.coordSysGivenCode(t.coordSysCD);if(!a||!a.atlasGN)throw"Coordinate system is of type atlas, but atlasGN is not known for coord sys with code "+t.coordSysCD;if(!MARCONI.map.isAtlasLoaded(a.atlasGN))throw MARCONI.map.getAtlasByAjax({atlasGN:a.atlasGN}),"BUSY -- atlas "+a.atlasGN+" is being loaded.";var i=MARCONI.map.getAtlas(a.atlasGN);if(!i)throw"Atlas "+a.atlasGN+" is not available";if(0===i.length)throw"Atlas "+a.atlasGN+" has no pages -- you have no hope of computing coordinates from it";var r=L.x.toUpperCase().split(" ");if(!r||0===r.length)throw"Atlas page designation not given";var o=r[0],n=1<r.length?r[1].toUpperCase():"",s=2<r.length?r[2].toUpperCase():"";n&&!s&&1<n.length&&(s=n.substr(1),n=n.substr(0,1));for(var l=0;l<i.length;l++)if(i[l].pageIdentifier==o){var c=i[l].hasGridOnPage&&n?e(n,i[l].gridFirstHorizontal,i[l].gridCellCountHorizontal,!0,i[l].horizontalGridValueList):.5,u=i[l].hasGridOnPage&&s?e(s,i[l].gridFirstVertical,i[l].gridCellCountVertical,!i[l].gridIncreasesDownPage,i[l].verticalGridValueList):.5;return L.x=i[l].longitudeMin+c*(i[l].longitudeMax-i[l].longitudeMin),L.y=i[l].latitudeMin+u*(i[l].latitudeMax-i[l].latitudeMin)}throw"Cannot find page "+o+" in atlas "+a.atlasGN}catch(t){throw t.startsWith("BUSY")?t:"Error determining lat-long from grid value: "+t}}(t);break;case MARCONI.map.COORDSYS_TYPE_MERCATOR:M(t.equitorialAxis,t.eSquared,t.originX,t.originY);break;case MARCONI.map.COORDSYS_TYPE_STEREO:v(t.equitorialAxis,t.eSquared,t.originLatitude,t.originLongitude,t.originX,t.originY,t.centralScaleFactor);break;default:this.x=MARCONI.map.DMStoDecimalDegrees(this.x),this.y=MARCONI.map.DMStoDecimalDegrees(this.y)}switch(t.datumCD!=e.datumCD&&(!function(t,e,a){var i="";try{var r=1/3600*.001,o=MARCONI.map.canonicalDatum(t),n=MARCONI.map.canonicalDatum(e);if(o==n)return;i="looking for suitable datum shift from "+o+" to "+n+(a?", method "+a:", any method");var s=a&&0<a.indexOf(" "),l=s?null:L,c=MARCONI.map.getDatumShift(o,n,a,l),u="";if(c&&!MARCONI.map.isDatumShiftOkayForGivenPoint(c,L)){if(u="Datum shift "+c.datumShiftMethodCD+" ["+c.datumShiftName+"] is valid only for bounds of "+c.latitudeMin+", "+c.longitudeMin+" by "+c.latitudeMax+", "+c.longitudeMax+", not suitable for lat,long of "+L.y+", "+L.x,s)throw u;c=null}var d=c?null:MARCONI.map.getDatumShift(n,o,a,l);if(d&&!MARCONI.map.isDatumShiftOkayForGivenPoint(d,L)){if(s)throw"Datum shift "+d.datumShiftMethodCD+" ["+d.datumShiftName+"] is valid only for bounds of "+d.latitudeMin+", "+d.longitudeMin+" by "+d.latitudeMax+", "+d.longitudeMax+", not suitable for lat,long of "+L.y+", "+L.x;d=null}if(i="",a&&!c&&!d)throw"Cannot find a valid datum shift of type "+a+" for point "+L.y+", "+L.x+".  "+(0==a.indexOf("GRID")?"Note that typically a GRID-type shift is not available for client-side calcs!":"Verify the bounding box criteria for datum shifts are correct.")+u;if(c)i="performing direct shift",C(c,L);else{if(!d)throw i="","Could not find a valid datum shift method to convert lat,long "+L.y+", "+L.x+" from datum "+t+" to datum "+e+", which were mapped to canonical datums "+o+" and "+n;i="iteratively performing reverse shift";for(var h=new MARCONI.map.GeoPoint(L.x,L.y),p=new MARCONI.map.GeoPoint(L.x,L.y),g=new MARCONI.map.GeoPoint(L.x,L.y),f=0;f<50;f++){g.x=p.x,g.y=p.y,i="reverse shift "+d,C(d,g);var m=g.x-h.x,M=g.y-h.y;if(Math.abs(m)<r&&Math.abs(M)<r)return L.x=p.x,L.y=p.y;Math.abs(M)>r&&(p.y=p.y-.5*M),Math.abs(m)>r&&(p.x=p.x-.5*m)}if(50<=f)throw"Maximum iteration count exceeded converting iteratively from datum "+o+" to datum "+n+" using method "+d.datumShiftMethodCD}}catch(t){throw"convertToNewHorizDatum() error: "+t+(i?", at stage "+i:"")}}(t.datumCD,e.datumCD,a),window.YAHOO),e.coordSysTypeCD){case MARCONI.map.COORDSYS_TYPE_LAMBERT:p(e.equitorialAxis,e.eSquared,e.parallelOne,e.parallelTwo,e.originLatitude,e.originLongitude,e.originX,e.originY);break;case MARCONI.map.COORDSYS_TYPE_TM:R(e.equitorialAxis,e.eSquared,e.originLatitude,e.originLongitude,e.originX,e.originY,e.centralScaleFactor);break;case MARCONI.map.COORDSYS_TYPE_ALBERS:d(e.equitorialAxis,e.eSquared,e.parallelOne,e.parallelTwo,e.originLatitude,e.originLongitude,e.originX,e.originY);break;case MARCONI.map.COORDSYS_TYPE_GRID:!function(t,e){try{if(L.x<-180||180<L.x||L.y<-90||90<L.y)throw"Cannot determine grid value since given lat-long of "+L.y+", "+L.x+" is not a valid lat-long";if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_USNG)r(!1);else if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_MGRS)r(!0);else if(t.coordSysCD==MARCONI.map.COORDSYS_UTM)!function(t,e){try{if(!t)throw"Must provide spatial reference to convert from lat-long to UTM, since conversion depends on datum";if(84<L.y||L.y<-80)throw"Latitude "+L.y+" out of UTM bounds (-80 to +84)";var a=L.y,i=L.x,r=MARCONI.map.getUTMZoneFromLatLong(a,i),o=e?0<a?"North":"South":h(a,i),n=6*(r-1)-180+3,s=a<0?1e7:0;R(t.equitorialAxisMeters,t.eSquared,0,n,5e5,s,.9996);var l=L.x,c=L.y;L.x=r+o+" "+MARCONI.stdlib.fixedFormatNumber(l,1,1,!0)+" "+MARCONI.stdlib.fixedFormatNumber(c,1,1,!0),L.y="",L.x}catch(t){throw"Error computing UTM from lat-long: "+t}}(t,"hemisphere"==L.getUTMzoneStyle().toLowerCase());else if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_GARS)!function(){try{var t=L.y,e=L.x,a=function(t){if(!t)return null;var e=1+Math.floor(2*(t+180));return MARCONI.stdlib.padLeft(e,3)}(e),i=function(t){var e="ABCDEFGHJKLMNPQRSTUVWXYZ";if(!t)return null;var a=Math.floor(2*(t+90));if(a<0||719<a)throw"Latitude band of "+a+" is outside bounds 0-719 for latitude "+t;var i=a/e.length,r=a%e.length;if(i<0||e.length<=i)throw"Cannot compute band (letter code) for latitude "+t;return e.substring(i,i+1)+e.substring(r,r+1)}(t),r=function(t,e){if(!t||!e)return null;var a=Math.floor(4*(t+90))%2,i=Math.floor(4*(e+180))%2;if(a<0||1<a)throw"Cannot compute quadrant for latitude "+t;if(i<0||1<i)throw"Cannot compute quadrant for longitude "+e;return 0==a&&0==i?"3":1==a&&0==i?"1":1==a&&1==i?"2":0==a&&1==i?"4":""}(t,e),o=function(t,e){if(!t||!e)return null;var a=Math.floor(12*(t+90))%12;a%=3;var i=Math.floor(12*(e+180))%12;if(i%=3,a<0||2<a)throw"Cannot compute keypad for latitude "+t;if(i<0||2<i)throw"Cannot compute keypad for longitude "+e;switch(a){case 0:return"789".substring(i,i+1);case 1:return"456".substring(i,i+1);case 2:return"123".substring(i,i+1);default:return null}}(t,e);L.x=""+a+i+r+o,L.y=""}catch(t){throw"Error computing GARS from lat-long: "+t}}();else if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_CAP_CLASSIC)!function(){try{var t=function(t,e){if(void 0===t||void 0===e||null===t||null===e)return null;var a,i=MARCONI.map.getCAPClassicGridSections();for(a=0;a<i.length;a++)if(i[a].north>=t&&i[a].south<=t&&i[a].west<=e&&i[a].east>=e)return i[a];return null}(L.y,L.x);if(!t)return L.x="",L.y="";var e=t.widthMinutes||15,a=t.heightMinutes||15,i=60/e,r=60/a,o=i*Math.round(t.east-t.west),n=Math.floor((L.x-t.west)*i),s=Math.floor((t.north-L.y)*r),l=s*o+n+1,c=t.north-(1+s)/r,u=t.west+(1+n)/i,d=60*Math.abs(L.x-u),h=60*Math.abs(L.y-c),p=d<30/i?h<30/r?"D":"B":h<30/r?"C":"A";L.x=t.code+" "+l+p,L.y=""}catch(t){throw"Error converting lat-long to CAP classic grid value, error: "+t}}();else if(t.spatialReferenceCD==MARCONI.map.SPATIALREF_CAP_CELL)!function(){try{var t=L.x,e=L.y,a=Math.floor(e),i=Math.floor(t);e-=a,t-=i;for(var r=.5,o=[],n=0;n<3;n++){var s=r<e?t<r?"A":"B":t<r?"C":"D";o.push(s),t%=r,e%=r,r/=2}var l=""+MARCONI.stdlib.fixedFormatNumber(Math.abs(a),2,0,!0)+MARCONI.stdlib.fixedFormatNumber(Math.abs(i+1),3,0,!0)+o.join("");L.x=l,L.y=""}catch(t){throw"Error converting lat-long to CAP cell grid value, error: "+t}}();else if(t.coordSysTypeCD==MARCONI.map.COORDSYS_TYPE_GRID&&t.baseCoordSysCD)!function(t){try{if(l=t,c=L.y,u=L.x,l.latitudeMin&&l.latitudeMax&&l.longitudeMin&&l.longitudeMax&&!(c>l.latitudeMin&&c<l.latitudeMax&&u>l.longitudeMin&&u<l.longitudeMax))return L.x="",L.y="";if(!t.baseCoordSysCD)throw"Coord sys "+t.coordSysCD+" needs to define a base coord sys in order to compute grid values";var e=new MARCONI.map.SpatialReference(t.baseCoordSysCD,t.datumCD,t.inputResolutionUnitCD);if(!e)throw"Cannot determine underlying spatial reference for grid reference frame "+t.spatialReferenceCD;if(e.coordSysTypeCD==MARCONI.map.COORDSYS_TYPE_LAMBERT)p(e.equitorialAxis,e.eSquared,e.parallelOne,e.parallelTwo,e.originLatitude,e.originLongitude,e.originX,e.originY);else if(e.coordSysTypeCD==MARCONI.map.COORDSYS_TYPE_TM)R(e.equitorialAxis,e.eSquared,e.originLatitude,e.originLongitude,e.originX,e.originY,e.centralScaleFactor);else if(e.coordSysTypeCD==MARCONI.map.COORDSYS_TYPE_ALBERS)d(e.equitorialAxis,e.eSquared,e.parallelOne,e.parallelTwo,e.originLatitude,e.originLongitude,e.originX,e.originY);else if(e.coordSysTypeCD==MARCONI.map.COORDSYS_TYPE_STEREO)S(e.equitorialAxis,e.eSquared,e.originLatitude,e.originLongitude,e.originX,e.originY,e.centralScaleFactor);else{if(e.coordSysTypeCD!=MARCONI.map.COORDSYS_TYPE_MERCATOR)throw"Unable to process grid based on coord sys of other than TM, Lambert or Albers";A(e.equitorialAxis,e.eSquared,e.originX,e.originY)}var a=t.inputResolution?t.inputResolution:1e3,i=t.gridCellSizeHorizontal/a,r=t.gridCellSizeVertical/a,o=i*Math.floor(L.x/t.gridCellSizeHorizontal),n=r*Math.floor(L.y/t.gridCellSizeVertical),s=function(t,e,a){function i(t,e){var a="string"==typeof e?e.length:4;return MARCONI.stdlib.fixedFormatNumber(t,a,0)}t=t.trim();var r="(.*)(\\{.*\\})([^\\d]*)(\\{.*\\})(.*)",o=new RegExp(r).exec(t);if(o&&1<o.length){var n=o[1],s=o[2],l=o[3],c=o[4],u=o[5],d=2<s.length?s.substring(1,s.length-1).split(","):null,h=2<c.length?c.substring(1,c.length-1).split(","):null,p=!0,g=d?d[2]:null,f=h?h[2]:null;return null!==d&&null!==h&&"1"==d[0].trim()&&(p=!1),n+i(p?e:a,g)+l+i(p?a:e,f)+u}return MARCONI.stdlib.log("template ",t,", "," does not match ",r),""}(t.gridTemplate,o,n);return L.x=s,L.y=""}catch(t){throw"Error getting generic grid from lat-long of "+L.y+", "+L.x+", err is "+t.toString()}var l,c,u}(t);else if(t.spatialReferenceCD==MARCONI.map.COORDSYS_OSGB)!function(t,e){function a(t,e){var a=5*(e=4-e%5)+t%5,i="ABCDEFGHJKLMNOPQRSTUVWXYZ".substr(a,1);return i}try{var i=t.eSquared||t.eccentricity*t.eccentricity;R(t.equitorialAxisMeters,i,t.originLatitude,t.originLongitude,t.originX,t.originY,t.centralScaleFactor);var r=Math.round(L.x),o=Math.round(L.y);if(r<0||o<0)L.x="";else if(e&&"alpha"!=e.toLowerCase())r-=2e6,o-=1e6,L.x=MARCONI.stdlib.fixedFormatNumber(r,5,0,!1)+" "+MARCONI.stdlib.fixedFormatNumber(o,5,0,!1);else{var n=Math.floor(r/5e5)+2,s=Math.floor(o/5e5)+1,l=a(n,s),c=Math.floor(r/1e5),u=Math.floor(o/1e5),d=a(c,u);r%=1e5,o%=1e5,L.x=l+d+" "+MARCONI.stdlib.fixedFormatNumber(r,5,0,!1)+" "+MARCONI.stdlib.fixedFormatNumber(o,5,0,!1)}L.y=""}catch(t){throw"Error computing OSGB from lat-long: "+t}}(t,e);else{if(t.spatialReferenceCD!=MARCONI.map.COORDSYS_IRISH)throw"Unrecognized grid coordinate system "+t.coordSysCD;!function(t,e){try{var a=t.eSquared||t.eccentricity*t.eccentricity;R(t.equitorialAxisMeters,a,t.originLatitude,t.originLongitude,t.originX,t.originY,t.centralScaleFactor);var i=Math.round(L.x),r=Math.round(L.y);if(i<0||r<0)L.x="";else if(e&&"alpha"!=e.toLowerCase())L.x=MARCONI.stdlib.fixedFormatNumber(i,5,0,!1)+" "+MARCONI.stdlib.fixedFormatNumber(r,5,0,!1);else{var o=Math.floor(i/1e5),n=Math.floor(r/1e5),s="ABCDEFGHJKLMNOPQRSTUVWXYZ".substr(5*(4-n%5)+o%5,1);i%=1e5,r%=1e5,L.x=s+" "+MARCONI.stdlib.fixedFormatNumber(i,5,0,!1)+" "+MARCONI.stdlib.fixedFormatNumber(r,5,0,!1)}L.y=""}catch(t){throw"Error computing Irish grid from lat-long: "+t}}(t,e)}}catch(t){throw"Error trying to get grid value from lat-long: "+t}}(e,i);break;case MARCONI.map.COORDSYS_TYPE_ATLAS:!function(t){function e(e,a,t,i,r,o,n){try{var s=(i-r)/(o-r);t||(s=1-s);var l=null;return n?(l=Math.floor(s*e),0<=(l=n.indexOf(a)+l)&&l<=n.length?n.charCodeAt(l):""):(l=Math.floor(s*e),MARCONI.stdlib.isDigit(a)?1*a+l:String.fromCharCode(a.charCodeAt(0)+l+(l<8?0:1)))}catch(t){throw"Error computing grid component value from real-world coordinate of "+i+", min-max of "+r+" and "+o+" using cellcount of "+e+", baseGridValue of "+a+(n?" and possible gridvals of "+n:"")+", error is: "+t}}try{var a=MARCONI.map.coordSysGivenCode(t.coordSysCD);if(!a||!a.atlasGN)throw"Coordinate system is of type atlas, but atlasGN is not known for coord sys with code "+t.coordSysCD;if(!MARCONI.map.isAtlasLoaded(a.atlasGN))throw MARCONI.stdlib.log("Auto-loading atlasGN "+a.atlasGN),MARCONI.map.getAtlasByAjax({atlasGN:a.atlasGN}),"BUSY -- atlas "+a.atlasGN+" is being loaded.";var i=MARCONI.map.getAtlas(a.atlasGN);if(void 0===i)throw"Atlas "+a.atlasGN+" is not available";if(0===i.length)throw"Atlas "+a.atlasGN+" has no pages -- you have no hope of computing coordinates from it";for(var r=0;r<i.length;r++)if(i[r].latitudeMin<L.y&&i[r].longitudeMin<L.x&&i[r].latitudeMax>L.y&&i[r].longitudeMax>L.x)return L.x=i[r].pageIdentifier+(i[r].hasGridOnPage?" "+e(i[r].gridCellCountHorizontal,i[r].gridFirstHorizontal,!0,L.x,i[r].longitudeMin,i[r].longitudeMax,i[r].horizontalGridValueList)+" "+e(i[r].gridCellCountVertical,i[r].gridFirstVertical,!i[r].gridIncreasesDownPage,L.y,i[r].latitudeMin,i[r].latitudeMax,i[r].verticalGridValueList):""),L.y="";L.x="",L.y=""}catch(t){throw t.startsWith("BUSY")?t:"Error getting atlas page from lat-long value: "+t}}(e);break;case MARCONI.map.COORDSYS_TYPE_MERCATOR:A(e.equitorialAxis,e.eSquared,e.originX,e.originY);break;case MARCONI.map.COORDSYS_TYPE_STEREO:S(e.equitorialAxis,e.eSquared,e.originLatitude,e.originLongitude,e.originX,e.originY,e.centralScaleFactor)}}catch(t){throw t.startsWith("BUSY")?t:"MARCONI.map.GeoPoint.convert(): "+t}},MARCONI.map.decimalDegreesToDMS=function(t,e){null==e&&(e=3);var a=Math.pow(10,-1*(e+1)),i=0<t?1:-1;if(360<Math.abs(t))throw"decimalDegreesToDMS(): angle of "+t+" out of bounds";var r=i*Math.floor(Math.abs(t));t=Math.abs(t)-Math.abs(r);var o=Math.floor(60*t),n=3600*(t-o/60);return Math.abs(n-60)<a&&(n=0,o+=1),60<=o&&(o-=60,r+=i),360<=Math.abs(r)&&(r-=360*i),r+"° "+o+"' "+n.toFixed(e)+'"'},MARCONI.map.decimalDegreesToDM=function(t,e){null==e&&(e=5);var a=0<t?1:-1;if(360<Math.abs(t))throw"decimalDegreesToDM(): angle of "+t+" out of bounds";var i=a*Math.floor(Math.abs(t)),r=60*(t=Math.abs(t)-Math.abs(i));return 60<=r&&(r-=60,i+=a),360<=Math.abs(i)&&(i-=360*a),i+"° "+r.toFixed(e)+"'"},MARCONI.map.greatCircleArcLengths=function(t,e,a,i,r,o,n){try{if(!(n&&n instanceof MARCONI.map.GeoPoint))throw"Parameter ptDelta must be an object of type GeoPoint";var s=.5*(a+r)*MARCONI.map.DEGREES_TO_RADIANS;n.y=MARCONI.map.DEGREES_TO_RADIANS*Math.abs(t*(1-e)/Math.pow(1-e*Math.sin(s)*Math.sin(s),1.5)*Math.abs(r-a)),n.x=Math.abs(t*Math.cos(s)/Math.sqrt(1-e*Math.sin(s)*Math.sin(s))*Math.abs(o-i)*MARCONI.map.DEGREES_TO_RADIANS),i<0?o<i&&(n.x=-1*n.x):i<o&&(n.x=-1*n.x),0<a?r<a&&(n.y=-1*n.y):a<r&&(n.y=-1*n.y)}catch(t){alert("Error in MARCONI.map.greatCircleArcLengths(): "+t)}},MARCONI.map.linearUnitsConversion=function(t,e,a){try{var i=t,r=!1;switch(e){case MARCONI.map.UNITS_SURVEYFEET:i=t*MARCONI.map.SURVEY_FEET_TO_METERS;break;case MARCONI.map.UNITS_INTERNATIONALFEET:i=t*MARCONI.map.INTERNATIONAL_FEET_TO_METERS;break;case MARCONI.map.UNITS_MILES:i=t*MARCONI.map.SURVEY_FEET_TO_METERS*5280;break;case MARCONI.map.UNITS_METERS:break;case MARCONI.map.UNITS_KILOMETERS:i=1e3*t;break;default:r=!0}if(r)throw"Unrecognized input unit code "+e;switch(a){case MARCONI.map.UNITS_SURVEYFEET:i/=MARCONI.map.SURVEY_FEET_TO_METERS;break;case MARCONI.map.UNITS_INTERNATIONALFEET:i/=MARCONI.map.INTERNATIONAL_FEET_TO_METERS;break;case MARCONI.map.UNITS_MILES:i=i/MARCONI.map.SURVEY_FEET_TO_METERS/5280;break;case MARCONI.map.UNITS_METERS:break;case MARCONI.map.UNITS_KILOMETERS:i/=1e3;break;default:r=!0}if(r)throw"Unrecognized output unit code "+a;return i}catch(t){throw"MARCONI.map.linearUnitsConversion() error: "+t}},MARCONI.map.isDegrees=function(t){try{var e=MARCONI.map.DMStoDecimalDegrees(t);return"number"==typeof e&&Math.abs(e)<=360.0001}catch(t){return!1}},MARCONI.map.DMStoDecimalDegrees=function(e){var t="";try{if("string"!=typeof e||0===e.length)return e;e=e.trim();var a=new RegExp("^([\\d\\+\\-.]+)[\\^d°]?[\\s]*([\\d.]*)['′]?[\\s]*([\\d.]*)[\"″]?[\\s]*(West?|East?|North?|South?|W?|E?|N?|S?)$","i").exec(e);if(!a||5!=a.length)throw"Invalid format in "+e+".  Acceptable formats include decimal degrees, degrees minutes, degrees minutes seconds.  W and S suffix indicates negative values.";var i=0<=a[1].indexOf("-");if(360<(t=Math.abs(parseFloat(a[1]))))throw"Degrees of "+a[1]+" out of bounds, absolute value must be [0-360]";if(a[4]){if(i)throw"Illegal format, either sign or letter (W,E,S,N) may be specified to indicate direction, but not both.";switch(a[4].toUpperCase().substring(0,1)){case"W":case"S":i=!0}}var r=a[2],o=a[3];if(0<=a[1].indexOf(".")&&(r||o))throw"If decimal degrees are used, may not supply minutes or seconds";if(0<=r.indexOf(".")&&o)throw"If decimal minutes are used, may not supply seconds";if(r){var n=parseFloat(r);if(60<n)throw"Minutes of "+r+" out of bounds, must be [0-60]";t+=n/60}if(o){var s=parseFloat(o);if(60<s)throw"Seconds of "+r+" out of bounds, must be [0-60]";t+=s/3600}i&&(t*=-1)}catch(t){throw"Unable to convert "+e+" to decimal degrees, error is "+t}return t},MARCONI.map.trueDistanceAlongCentralMeridian=function(t,e,a){return t*((1-e/4-3*e*e/64-5*Math.pow(e,3)/256)*a-(3*e/8+3*e*e/32+45*Math.pow(e,3)/1024)*Math.sin(2*a)+(15*e*e/256+45*Math.pow(e,3)/1024)*Math.sin(4*a)-35*Math.pow(e,3)/3072*Math.sin(6*a))},MARCONI.map.metersBetween=function(t,e,a,i){if(!t||!e||void 0===t.x||void 0===e.x||void 0===t.y||void 0===e.y)throw"Missing inputs to metersBetween() -- it needs two GeoPoints holding lat-longs";return a||(a=MARCONI.map.RADIUS_WGS84_METERS),a*MARCONI.map.radiansBetween(t,e,i)},MARCONI.map.toRadians=function(t){return t*MARCONI.map.DEGREES_TO_RADIANS},MARCONI.map.radiansBetween=function(e,a,t){function i(t){var e=Math.sin(.5*MARCONI.map.toRadians(t));return e*e}try{if(!e||!a||void 0===e.x||void 0===a.x||void 0===e.y||void 0===a.y)throw"Missing inputs to radiansBetween() -- it needs two GeoPoints holding lat-longs";var r=null;switch(t){case"LAW_OF_COSINES":r=Math.acos(Math.sin(e.y*MARCONI.map.DEGREES_TO_RADIANS)*Math.sin(a.y*MARCONI.map.DEGREES_TO_RADIANS)+Math.cos(e.y*MARCONI.map.DEGREES_TO_RADIANS)*Math.cos(a.y*MARCONI.map.DEGREES_TO_RADIANS)*Math.cos((a.x-e.x)*MARCONI.map.DEGREES_TO_RADIANS));break;case"HAVERSINE":s=e,l=a,r=2*Math.asin(Math.sqrt(i(s.y-l.y)+Math.cos(MARCONI.map.toRadians(s.y))*Math.cos(MARCONI.map.toRadians(l.y))*i(s.x-l.x)));break;case"VINCENTY":default:o=Math.sqrt(Math.pow(Math.cos(MARCONI.map.toRadians(a.y))*Math.sin(MARCONI.map.toRadians(e.x-a.x)),2)+Math.pow(Math.cos(MARCONI.map.toRadians(e.y))*Math.sin(MARCONI.map.toRadians(a.y))-Math.sin(MARCONI.map.toRadians(e.y))*Math.cos(MARCONI.map.toRadians(a.y))*Math.cos(MARCONI.map.toRadians(a.x-e.x)),2)),n=Math.sin(MARCONI.map.toRadians(e.y))*Math.sin(MARCONI.map.toRadians(a.y))+Math.cos(MARCONI.map.toRadians(e.y))*Math.cos(MARCONI.map.toRadians(a.y))*Math.cos(MARCONI.map.toRadians(a.x-e.x)),r=Math.atan2(o,n)}return r}catch(t){throw"Error computing radian distance between two points of lat-long "+e.y+", "+e.x+" and "+a.y+", "+a.x+", error is: "+t}var o,n,s,l},MARCONI.map.polygonPerimeter=function(t,e){if(!t)throw"Missing required array of GeoPoints to polygonPerimeter";e||(e=MARCONI.map.RADIUS_WGS84_METERS);for(var a=0,i=0;i<t.length-1;i++)a+=this.radiansBetween(t[i],t[i+1]);return e*a},MARCONI.map.haverSine=function(t){return.5*(1-Math.cos(t))},MARCONI.map.polygonArea=function(t,e){if(!t)throw"Missing required array of GeoPoints to polygonArea";e||(e=MARCONI.map.RADIUS_WGS84_METERS);for(var a=0,i=t.length-1,r=1;r<=i;r++){var o=t[r].y,n=(r+1)%i,s=t[r-1].x;a+=(t[n].x-s)*Math.sin(MARCONI.map.DEGREES_TO_RADIANS*o)}return a=Math.abs(MARCONI.map.DEGREES_TO_RADIANS*a*e*e*.5)},MARCONI.map.polygonArea2=function(t,e){if(!t)throw"Missing required array of GeoPoints to polygonArea";e||(e=MARCONI.map.RADIUS_WGS84_METERS);for(var a,i,r,o,n,s,l=0,c=t.length-1,u=0;u<c;u++){if(0==u)a=t[u].x*MARCONI.map.DEGREES_TO_RADIANS,r=t[u].y*MARCONI.map.DEGREES_TO_RADIANS,i=t[u+1].x*MARCONI.map.DEGREES_TO_RADIANS,o=t[u+1].y*MARCONI.map.DEGREES_TO_RADIANS,n=Math.cos(r),s=Math.cos(o);else{var d=(u+1)%c;a=i,r=o,i=t[d].x*MARCONI.map.DEGREES_TO_RADIANS,o=t[d].y*MARCONI.map.DEGREES_TO_RADIANS,n=s,s=Math.cos(o)}if(a!=i){var h=this.haverSine(o-r)+n*s*this.haverSine(i-a),p=2*Math.asin(Math.sqrt(h)),g=.5*Math.PI-o,f=.5*Math.PI-r,m=.5*(p+g+f),M=Math.tan(.5*m)*Math.tan(.5*(m-p))*Math.tan(.5*(m-g))*Math.tan(.5*(m-f)),A=Math.abs(4*Math.atan(Math.sqrt(Math.abs(M))));i<a&&(A*=-1),l+=A}}return l=Math.abs(l)*e*e},MARCONI.map.unitsConversion=function(t,e,a){try{var i="string"==typeof e?MARCONI.map.mapUnitGivenCode(e):e,r="string"==typeof a?MARCONI.map.mapUnitGivenCode(a):a;if(!i)throw"Unknown input units "+e+" passed";if(!r)throw"Unknown output units "+a+" passed";if(!r)throw"Unknown output units passed";if(i.isLinear&&!r.isLinear||!i.isLinear&&r.isLinear||i.isAreal&&!r.isAreal||!i.isAreal&&r.isAreal)throw"Units mismatched between linear and aerial, input is "+e+" and output is "+a;if(!i.metersPerUnit||!r.metersPerUnit)throw"Units in conversion lack metersPerUnit definitions";return t*i.metersPerUnit/r.metersPerUnit}catch(t){throw"MARCONI.map.unitsConversion() error: "+t}},MARCONI.map.toMeters=function(e,a){try{return MARCONI.map.unitsConversion(e,a,MARCONI.map.UNITS_METERS)}catch(t){throw"Error converting "+e+" "+a+" to meters: "+t}},MARCONI.map.fromMeters=function(e,a){try{return MARCONI.map.unitsConversion(e,MARCONI.map.UNITS_METERS,a)}catch(t){throw"Error converting "+e+" meters to "+a+": "+t}},USNG=function(){var o=new MARCONI.map.SpatialReference(MARCONI.map.COORDSYS_WORLD,MARCONI.map.DATUM_HORIZ_WGS84,MARCONI.map.UNITS_DEGREES),i=MARCONI.map.spatialRefGivenCode(MARCONI.map.SPATIALREF_USNG),n=new MARCONI.map.GeoPoint;return{LLtoUSNG:function(e,a,t){try{return n.x=a,n.y=e,n.convert(o,i),n.x}catch(t){throw"LLtoUSNG(): Error converting lat-long "+e+", "+a+" to USNG, err is "+t}},USNGtoLL:function(e){try{return n.x=e,n.convert(i,o),new google.maps.LatLng(n.y,n.x)}catch(t){throw"USNGtoLL(): Error converting grid value "+e+" to lat-long, err is "+t}},LLtoUTM:function(e,a,t,i){try{i=i||MARCONI.map.getUTMZoneFromLatLong(e,a);var r=MARCONI.map.UTMSpatialRef(i);n.x=a,n.y=e,n.convert(o,r),t[0]=n.x,t[1]=n.y,t[2]=i}catch(t){throw"LLtoUTM(): Error converting lat-long "+e+", "+a+" zone "+i+" to UTM, err is "+t}},UTMtoLL_GeoPoint:function(e,a,i){try{var t=MARCONI.map.UTMSpatialRef(i);return n.x=e,n.y=a,n.convert(t,o),n}catch(t){throw"UTMtoLL_GeoPoint(): Error converting utm "+e+", "+a+" zone "+i+" to lat-long, err is "+t}},UTMtoLL:function(e,a,i){try{var t=MARCONI.map.UTMSpatialRef(i);return n.x=e,n.y=a,n.convert(t,o),new google.maps.LatLng(n.y,n.x)}catch(t){throw"UTMtoLL(): Error converting utm "+e+", "+a+" zone "+i+" to lat-long, err is "+t}}}}(),USNGGraticule.prototype=new google.maps.OverlayView,USNGGraticule.prototype.onAdd=function(){},USNGGraticule.prototype.onRemove=function(t){try{this.zoneLines&&(this.zoneLines.remove(),this.zoneLines=null),this.grid100k&&(this.grid100k.remove(),this.grid100k=null),this.grid1k&&(this.grid1k.remove(),this.grid1k=null),this.grid100m&&(this.grid100m.remove(),this.grid100m=null),!0!==t&&(google.maps.event.removeListener(this.resizeListener),google.maps.event.removeListener(this.dragListener))}catch(t){MARCONI.stdlib.log("Error "+t+" removing USNG graticule")}},USNGGraticule.prototype.draw=function(){try{this.onRemove(!0),MARCONI.stdlib.log("drawing USNG grid, zoom is "+this._map.getZoom()),this.view=new USNGViewport(this._map);var t=this._map.getZoom();t<6?this.zoneLines=new USNGZonelines(this._map,this.view,this,this.gridStyle.majorLineColor,this.gridStyle.majorLineWeight,this.gridStyle.majorLineOpacity):(this.grid100k=new Grid100klines(this._map,this.view,this,this.gridStyle.semiMajorLineColor,this.gridStyle.semiMajorLineWeight,this.gridStyle.semiMajorLineOpacity),10<t&&(this.grid1k=new Grid1klines(this._map,this.view,this,this.gridStyle.minorLineColor,this.gridStyle.minorLineWeight,this.gridStyle.minorLineOpacity),13<t&&(this.grid100m=new Grid100mlines(this._map,this.view,this,this.gridStyle.fineLineColor,this.gridStyle.fineLineWeight,this.gridStyle.fineLineOpacity))))}catch(t){MARCONI.stdlib.warn("Error "+t+" drawing USNG graticule")}},USNGGraticule.prototype.gridValueFromPt=function(t){return USNG.LLtoUSNG(t.lat(),t.lng())},USNGViewport.prototype.lats=function(){return this.lat_coords},USNGViewport.prototype.lngs=function(){return this.lng_coords},USNGViewport.prototype.geoextents=function(){return this.georectangle},USNGZonelines.prototype.remove=function(){try{var t;if(this.lat_line){for(t=0;t<this.lat_line.length;t++)this.lat_line[t].setMap(null);this.lat_line=null}if(this.lng_line){for(t=0;t<this.lng_line.length;t++)this.lng_line[t].setMap(null);this.lng_line=null}if(this.marker){for(t=0;t<this.marker.length;t++)this.marker[t].parentNode.removeChild(this.marker[t]);this.marker=null}}catch(t){alert("Error removing zone lines: "+t)}},USNGZonelines.prototype.zonemarkerdraw=function(){function t(t,e,a,i){try{var r=t.getProjection().fromLatLngToDivPixel(e),o=document.createElement("div"),n=r.x,s=r.y;return o.style.position="absolute",o.style.width="50px",o.style.height="20px",o.innerHTML=a,i?o.className=i:(o.style.color="#000000",o.style.fontFamily="Arial",o.style.fontSize="small",o.style.backgroundColor="white",o.style.opacity=.5),o.style.textAlign="center",o.style.verticalAlign="middle",o.style.left=(n-25).toString()+"px",o.style.top=(s-10).toString()+"px",t&&t.getPanes&&t.getPanes().overlayLayer?t.getPanes().overlayLayer.appendChild(o):MARCONI.stdlib.warn("parent is "+t+" drawing label"),o}catch(t){throw"Error making zone label "+a+": "+t}}for(var e=0;e<this.gzd_rectangles.length;e++){var a=this.gzd_rectangles[e].getCenter().lat(),i=this.gzd_rectangles[e].getCenter().lng(),r=USNG.LLtoUSNG(a,i,1);r=r.substring(0,3),this.marker.push(t(this.parent,this.gzd_rectangles[e].getCenter(),r,this.parent.gridStyle.majorLabelClass))}},Grid100klines.prototype.remove=function(){try{if(this.zonelines&&this.zonelines.remove(),this.Gridcell_100k){for(var t=0;t<this.Gridcell_100k.length;t++)this.Gridcell_100k[t].remove();this.Gridcell_100k=null}}catch(t){alert("Error "+t+" trying to remove 100k gridlines")}},Grid1klines.prototype.remove=function(){for(var t=0;t<this.zones.length;t++)this.Gridcell_1k[t].remove();this.Gridcell_1k=null},Grid100mlines.prototype.remove=function(){for(var t=0;t<this.zones.length;t++)this.Gridcell_100m[t].remove()},usng_georectangle.prototype.assignCorners=function(t,e,a,i){this.nlat=e,this.slat=t,this.elng=56==t&&0==a?(this.wlng=a,i-3):56==t&&6==a?(this.wlng=a-3,i):72==t&&0==a?(this.wlng=a,i+3):72==t&&12==a?(this.wlng=a-3,i+3):(this.wlng=72==t&&36==a?a-3:a,i)},usng_georectangle.prototype.assignCenter=function(){this.centerlat=(this.nlat+this.slat)/2,this.centerlng=(this.wlng+this.elng)/2},usng_georectangle.prototype.getCenter=function(){return new google.maps.LatLng(this.centerlat,this.centerlng)},usng_georectangle.prototype.getNW=function(){return new google.maps.LatLng(this.nlat,this.wlng)},usng_georectangle.prototype.getSW=function(){return new google.maps.LatLng(this.slat,this.wlng)},usng_georectangle.prototype.getSE=function(){return new google.maps.LatLng(this.slat,this.elng)},usng_georectangle.prototype.getNE=function(){return new google.maps.LatLng(this.nlat,this.elng)},Gridcell.prototype.drawOneCell=function(){try{var t,e,a,i,r,o,n=[],s=MARCONI.map.getUTMZoneFromLatLong((this.slat+this.nlat)/2,(this.wlng+this.elng)/2);USNG.LLtoUTM(this.slat,this.wlng,n,s);var l=Math.floor(n[0]/this.interval)*this.interval-this.interval,c=Math.floor(n[1]/this.interval)*this.interval-this.interval;USNG.LLtoUTM(this.nlat,this.elng,n,s);var u=Math.floor(n[0]/this.interval+1)*this.interval+10*this.interval,d=Math.floor(n[1]/this.interval+1)*this.interval+10*this.interval;if(d<c||u<l)throw"Error, northeast of cell less than southwest";var h,p=null,g=null,f=null,m=[],M=[];h=this._map.getZoom()<12?1e4:15<this._map.getZoom()?100:1e3,(h*=10)>5*this.interval&&(h=5*this.interval),d-c<h&&(h=d-c),u-l<h&&(h=u-l);var A=1;if(1e3==this.interval&&11==this._map.getZoom()&&(A=2),m[0]=this.slat,!m[0])throw"Southern latitude is "+m[0];for(a=1,t=c,e=0;t<d;t+=this.interval*A,e++){for((p=USNG.UTMtoLL_GeoPoint(l+2*this.interval,t,s)).y>this.slat&&p.y<this.nlat&&(m[a++]=p.y),g=[],i=l;i<=u;i+=h)g.push(USNG.UTMtoLL(i,t,s));var S=!(f=[]);for(o=0;o<g.length-1;o++)(S=this.checkClip(g,o)).constructor==Array&&f.push.apply(f,S);1e5==this.interval?this.gridlines.push(new google.maps.Polyline({path:f,strokeColor:this.parent.gridStyle.semiMajorLineColor,strokeWeight:this.parent.gridStyle.semiMajorLineWeight,strokeOpacity:this.parent.gridStyle.semiMajorLineOpacity,map:this._map})):1e3==this.interval?this.gridlines.push(new google.maps.Polyline({path:f,strokeColor:this.parent.gridStyle.minorLineColor,strokeWeight:this.parent.gridStyle.minorLineWeight,strokeOpacity:this.parent.gridStyle.minorLineOpacity,map:this._map})):100==this.interval&&this.gridlines.push(new google.maps.Polyline({path:f,strokeColor:this.parent.gridStyle.fineLineColor,strokeWeight:this.parent.gridStyle.fineLineWeight,strokeOpacity:this.parent.gridStyle.fineLineOpacity,map:this._map}))}for(m[a++]=this.nlat,M[0]=this.wlng,a=1,t=l;t<u;t+=this.interval*A,e++){for((p=USNG.UTMtoLL_GeoPoint(t,c+2*this.interval,s)).x>this.wlng&&p.x<this.elng&&(M[a++]=p.x),g=[],i=c,r=0;i<=d;i+=h,r++)g.push(USNG.UTMtoLL(t,i,s));S=!(f=[]);for(o=0;o<g.length-1;o++)(S=this.checkClip(g,o)).constructor==Array&&f.push.apply(f,S);1e5==this.interval?this.gridlines.push(new google.maps.Polyline({path:f,strokeColor:this.parent.gridStyle.semiMajorLineColor,strokeWeight:this.parent.gridStyle.semiMajorLineWeight,strokeOpacity:this.parent.gridStyle.semiMajorLineOpacity,map:this._map})):1e3==this.interval?this.gridlines.push(new google.maps.Polyline({path:f,strokeColor:this.parent.gridStyle.minorLineColor,strokeWeight:this.parent.gridStyle.minorLineWeight,strokeOpacity:this.parent.gridStyle.minorLineOpacity,map:this._map})):100==this.interval&&this.gridlines.push(new google.maps.Polyline({path:f,strokeColor:this.parent.gridStyle.fineLineColor,strokeWeight:this.parent.gridStyle.fineLineWeight,strokeOpacity:this.parent.gridStyle.fineLineOpacity,map:this._map}))}M[a]=this.elng,1e5==this.interval?this.place100kLabels(M,m):1e3==this.interval?this.place1kLabels(M,m):100==this.interval&&this.place100mLabels(M,m)}catch(t){throw"Error drawing a cell: "+t}},Gridcell.prototype.remove=function(){try{if(this.gridlines){for(var t=0;t<this.gridlines.length;t++)this.gridlines[t].setMap(null);this.gridlines=[]}if(this.label_100k){for(t=0;this.label_100k[t];t++)this.label_100k[t].parentNode.removeChild(this.label_100k[t]);this.label_100k=[]}if(this.label_1k){for(t=0;this.label_1k[t];t++)this.label_1k[t].parentNode.removeChild(this.label_1k[t]);this.label_1k=[]}if(this.label_100m){for(t=0;this.label_100m[t];t++)this.label_100m[t].parentNode.removeChild(this.label_100m[t]);this.label_100m=[]}}catch(t){alert("Error removing old USNG graticule: "+t)}},Gridcell.prototype.makeLabel=function(t,e,a,i,r,o){var n=this.parent.getProjection().fromLatLngToDivPixel(e),s=document.createElement("div"),l=n.x,c=n.y;return s.style.position="absolute",s.style.width="50px",s.style.height="30px",o?s.className=o:(s.style.color="#000000",s.style.fontFamily="Arial",s.style.fontSize="small"),s.innerHTML=a,s.style.textAlign=i||"center",s.style.verticalAlign=r||"middle",s.style.left=("center"==(i||"center")?l-25:l).toString()+"px",s.style.top=("middle"==(r||"middle")?c-15:c).toString()+"px",t.getPanes().overlayLayer.appendChild(s),s},Gridcell.prototype.place100kLabels=function(t,e){try{for(var a,i,r,o,n=0;t[n+1];n++)for(var s=0;e[s+1];s++)a=MARCONI.map.getUTMZoneFromLatLong((e[s]+e[s+1])/2,(t[n]+t[n+1])/2),r=(e[s]+e[s+1])/2,o=(t[n]+t[n+1])/2,i=USNG.LLtoUSNG(r,o),i=this._map.getZoom()<10||13<this._map.getZoom()?9<a?i.substring(4,6):i.substring(3,5):9<a?i.substring(0,3)+i.substring(4,6):i.substring(0,2)+i.substring(3,5),this.label_100k.push(this.makeLabel(this.parent,new google.maps.LatLng(r,o),i,"center","bottom",this.parent.gridStyle.semiMajorLabelClass))}catch(t){throw"Error placing 100k markers: "+t}},Gridcell.prototype.place1kLabels=function(t,e){try{var a,i;if(15<this._map.getZoom())return;for(var r=1;t[r+1];r++){!t[r]||t[r+1];for(var o=1;o<2&&o+1<e.length;o++){!e[o]||e[o+1],a=(e[o]+e[o+1])/2,i=t[r],a||MARCONI.stdlib.warn("x-axis latitude is "+a+" when j="+o),i||MARCONI.stdlib.warn("longitude is "+i);var n=USNG.LLtoUSNG(a,i),s=n.split(" "),l=parseFloat(s[2].substr(0,2)),c=parseFloat(s[2].substr(2,3));500<c&&(l++,c=0);var u=l+"k",d=this.makeLabel(this.parent,new google.maps.LatLng(a,i),u,"left","top",this.parent.gridStyle.minorLabelClass);this.label_1k.push(d)}}for(r=1;r<2;r++)for(o=1;e[o+1];o++){a=e[o],i=(t[r]+t[r+1])/2,a||MARCONI.stdlib.warn("y-axis latitude is "+a),i||MARCONI.stdlib.warn("y-axis longitude is "+i),s=(n=USNG.LLtoUSNG(a,i)).split(" ");var h=parseFloat(s[3].substr(0,2));500<(c=parseFloat(s[3].substr(2,3)))&&(h++,c=0),u=h+"k",d=this.makeLabel(this.parent,new google.maps.LatLng(a,i),u,"center","top",this.parent.gridStyle.minorLabelClass),this.label_1k.push(d)}}catch(t){throw"Error placeing 1k markers: "+t}},Gridcell.prototype.place100mLabels=function(t,e){try{if(this._map.getZoom()<14)return;if(t.length<2||e.length<2)return;for(var a=15<this._map.getZoom()?1:2,i=e.length,r=t.length,o=1;t[o+1];o+=1)for(var n=1;n<2;n++){if(2==i)var s=(e[0]+e[1])/2;else s=(e[n]+e[n+1])/2;var l=USNG.LLtoUSNG(s,t[o]),c=l.split(" "),u=parseFloat(c[2].substr(0,3)),d=parseFloat(c[2].substr(3,2));if(50<d&&(u++,d=0),!(u%a)){var h=1!=a&&u%10?"":"<sup>00</sup>";this.label_100m.push(this.makeLabel(this.parent,new google.maps.LatLng(s,t[o]),MARCONI.stdlib.fixedFormatNumber(u,1,0,!0)+h,"left","top",this.parent.gridStyle.fineLabelClass))}}for(o=1;o<2;o++)for(n=1;e[n+1];n++){if(2==r)var p=(t[0]+t[1])/2;else p=(t[o]+t[o+1])/2;c=(l=USNG.LLtoUSNG(e[n],p,4)).split(" ");var g=parseFloat(c[3].substr(0,3));50<(d=parseFloat(c[3].substr(3,2)))&&(g++,d=0),this.label_100m.push(this.makeLabel(this.parent,new google.maps.LatLng(e[n],p),MARCONI.stdlib.fixedFormatNumber(g,1,0,!0)+"<sup>00</sup>","center","top",this.parent.gridStyle.fineLabelClass))}}catch(t){throw MARCONI.stdlib.log("Error placing 100-meter markers: "+t),"Error placing 100-meter markers: "+t}},Gridcell.prototype.checkClip=function(t,e){var o,n,s=this,r=[],a=t[e].lng(),i=t[e].lat(),l=t[e+1].lng(),c=t[e+1].lat(),u=!1,d=!1;function h(t,e){var a=0;return t<s.slat&&(a|=4),t>s.nlat&&(a|=8),e<s.wlng&&(a|=1),e>s.elng&&(a|=2),a}var p=h(i,a),g=h(c,l);function f(t,e,a,i){return 0!=(p&g)?null:u=0!=(p|g)||(r[0]=new google.maps.LatLng(t,e),u&&(r[1]=new google.maps.LatLng(a,i)),!1)}function m(t,e){return t<s.slat||t>s.nlat?0:e<s.wlng||e>s.elng?0:1}return f(i,a,c,l)&&function t(e,a,i,r){m(e,a)&&(o=a,a=r,r=o,o=e,e=i,i=o,o=p,p=g,g=o,d=!0);8&p?(n=(s.nlat-e)/(i-e),a+=n*(r-a),e=s.nlat):4&p?(n=(s.slat-e)/(i-e),a+=n*(r-a),e=s.slat):1&p?(n=(s.wlng-a)/(r-a),e+=n*(i-e),a=s.wlng):2&p&&(n=(s.elng-a)/(r-a),e+=n*(i-e),a=s.elng);d&&(o=a,a=r,r=o,o=e,e=i,i=o,d=!1);p=h(e,a);g=h(i,r);f(e,a,i,r)&&t(e,a,i,r)}(i,a,c,l),0!=r.length&&r};var map,geocoder,curr_usng_view,debug=!(window.USNG2=function(){for(var x=["A","B","C","D","E","F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V"],b=["F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V","A","B","C","D","E"],_=["A","B","C","D","E","F","G","H"],T=["J","K","L","M","N","P","Q","R"],U=["S","T","U","V","W","X","Y","Z"],G=["C","D","E","F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V","W","X","X"],t=[-80,-72,-64,-56,-48,-40,-32,-24,-16,-8,0,8,16,24,32,40,48,58,64,72,80],R=new Array(20),e=0;e<20;e++)R[e]=110946.259*t[e];var P=["A","B","C","F","G","H","J","K","L","P","Q","R","S","T","U","X","Y","Z"],Y=["H","J","K","L","M","N","P","A","B","C","D","E","F","G"],k=["N","P","Q","R","S","T","U","V","W","X","Y","Z","A","B","C","D","E","F","G","H","J","K","L","M"];this.llDistance=function(t,e){var a=t.lat*Math.PI/180,i=e.lat*Math.PI/180,r=(e.lon-t.lon)*Math.PI/180;return Math.atan2(Math.sqrt(Math.pow(Math.cos(i)*Math.sin(r),2)+Math.pow(Math.cos(a)*Math.sin(i)-Math.sin(a)*Math.cos(i)*Math.cos(r),2)),Math.sin(a)*Math.sin(i)+Math.cos(a)*Math.cos(i)*Math.cos(r))},this.fromUTM=function(t,e,a,i,r){var o,n,s,l=t%6,c=Math.floor(a/1e5)-1,u=Math.floor(i%2e6/1e5);switch(u<0&&(u+=20),l){case 1:o=_[c]+x[u];break;case 2:o=T[c]+b[u];break;case 3:o=U[c]+x[u];break;case 4:o=_[c]+b[u];break;case 5:o=T[c]+x[u];break;case 0:o=U[c]+b[u];break;default:throw"USNG: can't get here"}var d=Math.floor(a%1e5).toString(),h=Math.floor(i%1e5);for(h<0&&(h+=1e5),h=h.toString();d.length<5;)d="0"+d;for(;h.length<5;)h="0"+h;if(5<r){var p=r-5;n=d+(a%1).toFixed(p).substr(2,p),s=h+(i%1).toFixed(p).substr(2,p)}else n=d.substr(0,r),s=h.substr(0,r);return String(t)+e+" "+o+" "+n+" "+s},this.toUTMFromFullParsedUSNG=function(t,e,a,i,r,o,n){var s,l,c,u=0;switch(t%6){case 1:l=x,c=_;break;case 2:l=b,c=T;break;case 3:l=x,c=U;break;case 4:l=b,c=_;break;case 5:l=x,c=T;break;case 0:l=b,c=U;break;default:throw"Can't get here"}var d=c.indexOf(a[0]),h=l.indexOf(a[1]);if(-1==d||-1==h)throw"USNG: Invalid USNG 100km grid designator for UTM zone "+t+".";s=1e5*(d+1)+i,u=1e5*(h+0)+r;var p=R[G.indexOf(e)];u+=2e6*Math.ceil((p-u)/2e6);var g=N.invProj(t,s,u),f=Math.floor((g.lon- -180)/6)+1,m=G[Math.floor((g.lat- -80)/8)];if(m!=e&&(u-=2e6,g=N.invProj(t,s,u),f=Math.floor((g.lon- -180)/6)+1,m=G[Math.floor((g.lat- -80)/8)]),n){if(84<g.lat||g.lat<-80)throw"USNG: Latitude "+g.lat+" outside valid UTM range.";if(f!=t)throw"USNG: calculated coordinate not in correct UTM zone! Supplied: "+t+e+" Calculated: "+f+m;if(m!=e)throw"USNG: calculated coordinate not in correct grid zone! Supplied: "+t+e+" Calculated: "+f+m}else{if(84.5<g.lat||g.lat<-79.5)throw"USNG: Latitude "+g.lat+" outside valid UTM range.";if(s<1e5||9e5<s)throw"USNG: calculated coordinate not in correct UTM zone! Supplied: "+t+e+" Calculated: "+f+m;var M=Math.abs(f-t);if(2<M&&M<58)throw"USNG: calculated coordinate not in correct UTM zone! Supplied: "+t+e+" Calculated: "+f+m;var A=x.indexOf(m),S=x.indexOf(e),C=Math.abs(A-S);if(1<C&&C<19)throw"USNG: calculated coordinate not in correct grid zone! Supplied: "+t+e+" Calculated: "+f+m}return{zone:t,easting:s,northing:u,precision:o,usng:String(t)+e+" "+a+" "+i+" "+r}},this.toUTM=function(t,e,a){var i=0,r=0,o=0,n="",s=null,l=null,c=null;if(t=t.replace(/ /g,""),h=(d=new RegExp("([0-9]+)$")).exec(t)){o=(n=h[0]).length/2;var u=Math.pow(10,5-o);i=Number(n.substr(0,o))*u,r=Number(n.substr(o,o))*u}t=t.substr(0,t.length-2*o);var d=new RegExp("([A-Z][A-Z]$)"),h=d.exec(t);if(h&&(s=h[0]),t=t.substr(0,t.length-2),(h=(d=new RegExp("([0-9]+)([A-Z])")).exec(t))&&(c=h[1],l=h[2]),c||(h=(d=new RegExp("([A-Z])")).exec(t))&&(l=h[1]),c&&l&&s);else if("A"!=l&&"B"!=l&&"Y"!=l&&"Z"!=l||!s)if(s&&e){var p=1e3,g=null,f=null,m=Math.floor((e.lon- -180)/6)+1,M=Math.floor((e.lat- -80)/8);for(c=m-1;c<=m+1;c++)for(var A=0;A<20;A++){l=G[A];try{var S=this.toLonLat(c%60+l+s+n,null,!0);(L=this.llDistance(e,S))<p&&(p=L,g=c%60,f=l)}catch(t){}}for(var A in C=0<e.lat?["Y","Z"]:["A","B"]){l=C[A];try{S=this.toLonLat(l+s+n,null,!0);(L=this.llDistance(e,S))<p&&(p=L,g=null,f=l)}catch(t){}}if(!f)throw"USNG: Couldn't find a match";c=g,l=f}else{if(!e)throw"USNG: Not enough information to locate point.";p=1e3,g=null,f=null;var C,R,N,y=null;m=Math.floor((e.lon- -180)/6)+1,M=Math.floor((e.lat- -80)/8);for(c=m-1;c<=m+1;c++)for(A=M-1;A<=M+1;A++){var O,v;switch(l=G[A],c%6){case 1:O=x,v=_;break;case 2:O=b,v=T;break;case 3:O=x,v=U;break;case 4:O=b,v=_;break;case 5:O=x,v=T;break;case 0:O=b,v=U;break;default:throw"Can't get here"}for(var I=0;I<20;I++)for(var D=0;D<8;D++)try{s=v[D]+O[I];S=this.toLonLat(c%60+l+s+n,null,!0);(L=this.llDistance(e,S))<p&&(p=L,g=c%60,f=l,y=s)}catch(t){}}for(var A in N=0<e.lat?(C=["Y","Z"],R=Y,14):(C=["A","B"],R=k,24),C){l=C[A];for(var w=0;w<N;w++)for(var E=0;E<18;E++)try{s=P[E]+R[w];var L;S=this.toLonLat(l+s+n,null,!0);(L=this.llDistance(e,S))<p&&(p=L,g=null,f=l,y=s)}catch(t){}}if(!f)throw"USNG: Couldn't find a match";c=g,l=f,s=y}else;return"A"==l||"B"==l||"Y"==l||"Z"==l?this.toUPSFromFullParsedUSNG(l,s,i,r,o):this.toUTMFromFullParsedUSNG(c,l,s,i,r,o,a)},this.fromUPS=function(t,e,a,i){if("A"!=t&&"B"!=t&&"Y"!=t&&"Z"!=t)throw"UPS only valid in zones A, B, Y, and Z";var r,o=Math.floor((e-2e6)/1e5),n=Math.floor((a-2e6)/1e5);o<0&&(o+=18),r="A"==t||"B"==t?(n<0&&(n+=24),P[o]+k[n]):(n<0&&(n+=14),P[o]+Y[n]);for(var s=Math.floor(e%1e5).toString(),l=Math.floor(a%1e5).toString();s.length<5;)s="0"+s;for(;l.length<5;)l="0"+l;if(5<i){var c=i-5;grid_x=s+(e%1).toFixed(c).substr(2,c),grid_y=l+(a%1).toFixed(c).substr(2,c)}else grid_x=s.substr(0,i),grid_y=l.substr(0,i);return t+" "+r+" "+grid_x+" "+grid_y},this.toUPSFromFullParsedUSNG=function(t,e,a,i,r){if(!Proj4js)throw"USNG: Zones A,B,Y, and Z require Proj4js.";var o,n=2e6,s=2e6,l=P.indexOf(e[0]);if(l<0)throw"USNG: Invalid grid square.";switch(t){case"A":l-=18;case"B":if(o=k.indexOf(e[1]),l<-12||11<l||o<0)throw"USNG: Invalid grid square.";11<o&&(o-=24);break;case"Y":l-=18;case"Z":if(o=Y.indexOf(e[1]),l<-7||6<l||o<0)throw"USNG: Invalid grid square.";6<o&&(o-=14);break;default:throw"UPS only valid in zones A, B, Y, and Z"}n+=1e5*l,s+=1e5*o;var c={x:n+=a,y:s+=i};if("A"==t||"B"==t){if(Proj4js.transform(d,h,c),-80<c.y)throw"USNG: Grid Zone A or B but Latitude > -80."}else if(Proj4js.transform(u,h,c),c.y<84)throw"USNG: Grid Zone Y or Z but Latitude < 84.";return{grid_zone:t,x:n,y:s,precision:r,usng:t+" "+e+" "+a+" "+i}},this.fromLonLat=function(t,e){for(var a=t.lon,i=t.lat;a<-180;)a+=180;for(;180<a;)a-=180;var r=Math.floor((a- -180)/6)+1;if(!(-80<i&&i<84)){if(!u)throw"USNG: Latitude must be between -80 and 84. (Zones A,B,Y, and Z require Proj4js.)";var o=new Proj4js.Point(a,i);return n=0<i?(Proj4js.transform(h,u,o),a<0?"Y":"Z"):(Proj4js.transform(h,d,o),a<0?"A":"B"),this.fromUPS(n,o.x,o.y,e)}var n=G[Math.floor((i- -80)/8)],s=N.proj(r,a,i);return this.fromUTM(r,n,s.utm_easting,s.utm_northing,e)},this.toLonLat=function(t,e,a){var i,r=this.toUTM(t,e,a),o=r.grid_zone;if(!d||"A"!=o&&"B"!=o)if(!u||"Y"!=o&&"Z"!=o)(i=N.invProj(r.zone,r.easting,r.northing)).precision=r.precision,i.usng=r.usng;else{n={x:r.x,y:r.y};Proj4js.transform(u,h,n),i={lon:n.x,lat:n.y,precision:r.precision,usng:r.usng}}else{var n={x:r.x,y:r.y};Proj4js.transform(d,h,n),i={lon:n.x,lat:n.y,precision:r.precision,usng:r.usng}}return i},this.UTM=function(){var E=6378137,L=.006694384442042606,x=L/(1-L),b=.9996,_=Math.PI/180;this.proj=function(t,e,a){var i,r=-(6*(30-t)+3)*_,o=a*_,n=e*_,s=Math.sin(o),l=Math.cos(o),c=s/l,u=c*c,d=u*u,h=E/Math.sqrt(1-L*(s*s)),p=x*l*l,g=l*(n-r),f=6367449.138844212*(i=o)+-16038.519017028084*Math.sin(2*i)+16.832223171520933*Math.sin(4*i)+-.021800809706533364*Math.sin(6*i),m=1-u+p,M=5-18*u+d+72*p-58*x,A=Math.pow(g,5),S=b*h*(g+m*Math.pow(g,3)/6+M*A/120)+5e5,C=(5-u+9*p+p*p*4)*Math.pow(g,4)/24;return{utm_zone:t,utm_easting:S,utm_northing:b*(f+h*c*(g*g/2+C+(61-58*u+d+600*p-330*x)*(A*g/720)))}},this.invProj=function(t,e,a){var i=-(6*(30-t)+3)*_,r=Math.sqrt(1-L),o=(1-r)/(1+r),n=o*o,s=o*n;e-=5e5;var l=a/b/6367449.138844212,c=21/16*n-55/32*(n*n),u=l+(1.5*o-27/32*s)*Math.sin(2*l)+c*Math.sin(4*l)+151*s/96*Math.sin(6*l),d=Math.sin(u),h=Math.cos(u),p=d/h,g=E/Math.sqrt(1-L*d*d),f=p*p,m=x*h*h,M=1-L*d*d,A=E*(1-L)/Math.sqrt(M*M*M),S=e/(g*b),C=S*S,R=S*C,N=C*C,y=S*N,O=f*f,v=m*m,I=(1+2*f+m)*R/6,D=5-2*m+28*f-3*v+8*x+24*O,w=180*(u-g*p/A*(C/2-(5+3*f+10*m-4*v-9*x)*(N/24)+(61+90*f+298*m+45*O-252*x-3*v)*(R*R)/720))/Math.PI;return{lon:180*(i+(S-I+D*y/120)/h)/Math.PI,lat:w}}};var u,d,h,N=new this.UTM;"object"==typeof Proj4js&&(Proj4js.defs["EPSG:32661"]="+proj=stere +lat_0=90 +lat_ts=90 +lon_0=0 +k=0.994 +x_0=2000000 +y_0=2000000 +ellps=WGS84 +datum=WGS84 +units=m +no_defs",Proj4js.defs["EPSG:32761"]="+proj=stere +lat_0=-90 +lat_ts=-90 +lon_0=0 +k=0.994 +x_0=2000000 +y_0=2000000 +ellps=WGS84 +datum=WGS84 +units=m +no_defs",Proj4js.defs["EPSG:4326"]="+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs",u=new Proj4js.Proj("EPSG:32661"),d=new Proj4js.Proj("EPSG:32761"),h=new Proj4js.Proj("EPSG:4326"))}),usngfunc=new USNG2,utm_proj=new usngfunc.UTM,defaultBounds=new google.maps.LatLngBounds(new google.maps.LatLng(24.20689,-124.291994),new google.maps.LatLng(48.922499,-56.879885)),disableClickListener=!0,graticule=null,gridstyle={majorLineColor:"#0000ff",majorLineWeight:3,majorLineOpacity:.5,semiMajorLineColor:"#0000ff",semiMajorLineWeight:2,semiMajorLineOpacity:.5,minorLineColor:"blue",minorLineWeight:1,minorLineOpacity:.3,fineLineColor:"#ff6633",fineLineWeight:2,fineLineOpacity:.5,majorLabelClass:"majorGridLabel",semiMajorLabelClass:"semiMajorGridLabel",minorLabelClass:"minorGridLabel",fineLabelClass:"fineGridLabel"};function initialize(){geocoder=new google.maps.Geocoder;var t={center:new google.maps.LatLng(40,-97.5),zoom:5,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("map"),t),elevator=new google.maps.ElevationService,overlay=new google.maps.OverlayView,overlay.draw=function(){},overlay.setMap(map),map.zoneon=!1,map.grid100kon=!1,map.grid1kon=!1,map.grid100mon=!1,google.maps.event.addListener(map,"mousemove",function(t){var e=t.latLng,a=usngfunc.fromLonLat({lon:e.lng(),lat:e.lat()},4);document.getElementById("coordinateInfo").innerHTML="<em>"+a+"</em>"}),debug&&google.maps.event.addListener(map,"zoom_changed",function(t){console.log("Current zoom level is: "+map.getZoom())})}function mapClickListenerToggle(){disableClickListener=!disableClickListener}function toggleGridDisp(){0==map.zoneon?(map.zoneon=!0,graticule=new USNGGraticule(map,gridstyle)):(graticule.setMap(null),map.zoneon=!1)}